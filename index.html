<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anker Partner</title>
  <link rel="icon" type="image/png" href="images/Anker Logo New.png">
  <link rel="apple-touch-icon" href="images/Anker Logo New.png">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- Leaflet Maps (Open Source alternative to Google Maps) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Leaflet Geocoding for address search -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>
  <!-- Three.js for 3D visualization -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <style>
    /* ============================================
       Font Face Definitions - MontForAnker
       ============================================ */
    @font-face {
      font-family: 'MontForAnker';
      src: url('./fonts/MontForAnker-Regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: 'MontForAnker';
      src: url('./fonts/MontForAnker-Book.ttf') format('truetype');
      font-weight: 450;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: 'MontForAnker';
      src: url('./fonts/MontForAnker-SemiBold.ttf') format('truetype');
      font-weight: 600;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: 'MontForAnker';
      src: url('./fonts/MontForAnker-Bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: 'MontForAnker';
      src: url('./fonts/MontForAnker-Heavy.ttf') format('truetype');
      font-weight: 900;
      font-style: normal;
      font-display: swap;
    }

    /* ============================================
       CSS Variables - eufy Design System v0.6
       基于: /Users/anker/Anker_Partner_App/eufy组件库v0.6/
       字体: MontForAnker (Anker 专用字体)
       ============================================ */
    :root {
      /* ===================================
         字体家族 - Font Family
         =================================== */
      --font-family: 'MontForAnker', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      --font-family-primary: var(--font-family);

      /* ===================================
         字体尺寸 - Font Sizes
         =================================== */
      --font-display2: 28px;           /* display2_emphasized - 超大标题 */
      --font-display1: 20px;           /* display1_emphasized - 大标题 */
      --font-title1: 16px;             /* title1_emphasized - 一级标题 */
      --font-body: 14px;               /* body_emphasized/body_regular - 正文 */
      --font-caption2: 12px;           /* caption2_emphasized/regular - 描述文案 */
      --font-caption1: 10px;           /* caption1_emphasized/regular - 极小文字 */

      /* ===================================
         字体粗细 - Font Weight
         =================================== */
      --font-weight-regular: 400;      /* Regular */
      --font-weight-semibold: 600;     /* Semibold */
      --font-weight-bold: 700;         /* Bold */

      /* ===================================
         EUFY 品牌色 - Brand Colors (Light Mode)
         =================================== */
      --ref-brand-100: #005D8E;        /* 品牌色_100 - 主品牌色 */
      --ref-brand-60: #669EBB;         /* 品牌色_60 - 次要品牌色 */
      --ref-brand-40: #99BED2;         /* 品牌色_40 - 三级品牌色 */
      --ref-brand-24: #C2D8E4;         /* 品牌色_24 - 四级品牌色 */
      --ref-brand-10: #E0EDF4;         /* 品牌色_10 */

      /* 语义品牌色 Token */
      --brand-fg-primary: #005D8E;     /* brand_fg_primary - 品牌色主要前景色 */
      --brand-fg-secondary: #669EBB;   /* brand_fg_secondary - 品牌色次要前景色 */
      --brand-fg-tertiary: #99BED2;    /* brand_fg_tertiary - 品牌色三级前景色 */

      /* 语义品牌填充色 Token */
      --brand-fill-primary: rgba(0, 93, 142, 0.10);     /* brand_fill_primary */
      --brand-fill-secondary: rgba(0, 93, 142, 0.08);   /* brand_fill_secondary */
      --brand-fill-tertiary: rgba(0, 93, 142, 0.04);    /* brand_fill_tertiary */

      /* ===================================
         背景色 - Background Colors
         =================================== */
      --bg-primary: #F2F4F7;           /* bg_primary - 一级背景色 */
      --bg-secondary: #FFFFFF;         /* bg_secondary - 二级背景色 */
      --bg-tertiary: #EBEEF2;          /* bg_tertiary - 三级背景色 */
      --bg-body-primary: #F2F4F7;      /* bg_body_primary - 一级弹出层颜色 */
      --bg-body-secondary: #FFFFFF;    /* bg_body_secondary - 二级弹出层颜色 */
      --bg-floating: #FFFFFF;          /* bg_floating - 悬浮层颜色 */

      /* Legacy compatibility */
      --color-bg-primary: #FFFFFF;
      --color-bg-secondary: #F2F4F7;
      --color-bg-tertiary: #EBEEF2;

      /* ===================================
         填充色 - Fill Colors
         =================================== */
      --fill-primary: rgba(0, 0, 0, 0.10);      /* fill_primary - 第一级填充色 */
      --fill-secondary: rgba(0, 0, 0, 0.08);    /* fill_secondary - 第二级填充色 */
      --fill-tertiary: rgba(0, 0, 0, 0.04);     /* fill_tertiary - 第三级填充色 */
      --fill-active: rgba(0, 0, 0, 0.08);       /* fill_active - 容器点击态颜色 */
      --fill-toast: rgba(0, 0, 0, 0.85);        /* fill_toast - Toast 背景色 */
      --fill-mask: rgba(0, 0, 0, 0.60);         /* fill_mask - 黑色蒙层背景色 */

      /* ===================================
         文字色 - Text Colors
         =================================== */
      --fg-primary: #1F1F1F;           /* fg_primary - 主要文字色 */
      --fg-secondary: #666666;         /* fg_secondary - 次要文字色 */
      --fg-tertiary: #999999;          /* fg_tertiary - 三级文字色 */
      --fg-quaternary: #C2C2C2;        /* fg_quaternary - 四级文字色 */
      --fg-white: #FFFFFF;             /* fg_white - 纯白色 */
      --fg-black: #000000;             /* fg_black - 纯黑色 */

      /* Legacy compatibility */
      --color-text-primary: #1F1F1F;
      --color-text-secondary: #666666;
      --color-text-tertiary: #999999;
      --color-text-inverse: #FFFFFF;

      /* ===================================
         功能色 - Function Colors
         =================================== */
      --function-error: #F05049;       /* function_error - 错误/危险色 */
      --function-warning: #F79725;     /* function_warning - 警告色 */
      --function-success: #0FBD58;     /* function_success - 成功色 */
      --function-info: #4CA2FF;        /* function_info - 信息色 */

      /* Legacy compatibility */
      --color-danger: #F05049;
      --color-warning: #F79725;
      --color-success: #0FBD58;

      /* ===================================
         线条 - Lines
         =================================== */
      --ref-line-min: 0px;             /* ref_min - 超细 (无边框) */
      --ref-line-xs: 0.33px;           /* ref_xs - 极细 */
      --ref-line-s: 0.5px;             /* ref_s - 细 */
      --ref-line-m: 1px;               /* ref_m - 中等 */
      --comp-btn-line: 0px;            /* comp_btn_line - EUFY 按钮边框线宽 */

      /* Legacy compatibility */
      --color-border-primary: rgba(0, 0, 0, 0.10);
      --color-border-secondary: rgba(0, 0, 0, 0.08);

      /* ===================================
         圆角 - Border Radius
         =================================== */
      /* 基础圆角 */
      --ref-radius-min: 0px;           /* ref_radius_min - 无圆角 */
      --ref-radius-xxxs: 2px;          /* ref_radius_xxxs - 极极小圆角 */
      --ref-radius-xxs: 4px;           /* ref_radius_xxs - 极小圆角 */
      --ref-radius-xs: 8px;            /* ref_radius_xs - 超小圆角 */
      --ref-radius-s: 10px;            /* ref_radius_s - 小圆角 */
      --ref-radius-m: 12px;            /* ref_radius_m - 中圆角 (常用) */
      --ref-radius-l: 16px;            /* ref_radius_l - 大圆角 */
      --ref-radius-xl: 20px;           /* ref-radius_xl - 超大圆角 */
      --ref-radius-xxl: 24px;          /* ref_radius_xxl - 极大圆角 */
      --ref-radius-max: 1000px;        /* ref_radius_max - 全圆角 (胶囊状) */

      /* 组件圆角 */
      --comp-btn-radius: 1000px;       /* comp_btn_radius - 公共按钮圆角 (全圆角胶囊型) */
      --comp-sheet-radius: 24px;       /* comp_sheet_radius - 模态弹窗圆角 */
      --comp-dialog-radius: 16px;      /* comp_dialog_radius - 弹窗圆角 */
      --comp-toast-radius: 12px;       /* comp_toast_radius - 吐司圆角 */
      --comp-group-radius: 16px;       /* comp_group_radius - 组圆角 */
      --comp-input-radius: 12px;       /* 输入框圆角 */
      --comp-card-radius: 16px;        /* 卡片圆角 */

      /* Legacy compatibility */
      --border-radius-sm: 4px;
      --border-radius-md: 8px;
      --border-radius-lg: 12px;
      --border-radius-xl: 16px;

      /* ===================================
         间距 - Spacing
         =================================== */
      /* Padding */
      --ref-padding-xxs: 2px;          /* ref_padding_xxs - 极小内边距 */
      --ref-padding-xs: 4px;           /* ref_padding_xs - 超小内边距 */
      --ref-padding-s: 8px;            /* ref_padding_s - 小内边距 */
      --ref-padding-m: 12px;           /* ref_padding_m - 中内边距 */
      --ref-padding-l: 16px;           /* ref_padding_l - 大内边距 (常用) */
      --ref-padding-xl: 24px;          /* ref_padding_xl - 超大内边距 */

      /* Margin */
      --ref-margin-m: 16px;            /* ref_margin_m - 中外边距 */
      --ref-margin-l: 24px;            /* ref_margin_l - 大外边距 */
      --ref-margin-xl: 32px;           /* ref_margin_xl - 超大外边距 */

      /* 快速查询变量 */
      --space-s: 8px;                  /* 小间距 */
      --space-m: 12px;                 /* 中间距 */
      --space-l: 16px;                 /* 大间距 */
      --space-xl: 24px;                /* 超大间距 */

      /* Legacy compatibility */
      --spacing-xxs: 2px;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-xxl: 48px;

      /* ===================================
         组件高度 - Component Height
         =================================== */
      --ref-min-height-m: 48px;        /* ref_min_height_m - 中等最小高度 (按钮高度) */
      --ref-min-height-l: 56px;        /* ref_min_height_l - 大最小高度 */
      --height-button: 48px;           /* 按钮高度 */
      --height-input: 48px;            /* 输入框高度 */

      /* ===================================
         阴影 - Shadows
         =================================== */
      --shadow-base: 0 2px 12px 0 rgba(0, 0, 0, 0.06);           /* shadow_base - 基础阴影 */
      --shadow-popup-top: 0 -4px 16px 0 rgba(0, 0, 0, 0.06);     /* shadow_popup_top - 顶部弹出阴影 */
      --shadow-popup-bottom: 0 4px 16px 0 rgba(0, 0, 0, 0.06);   /* shadow_popup_bottom - 底部弹出阴影 */
      --shadow-overlay: 0 0 20px 0 rgba(0, 0, 0, 0.12);          /* shadow_overlay - 覆盖层阴影 */
      --shadow-pressed: 0 2px 8px 0 rgba(0, 0, 0, 0.12);         /* shadow_pressed - 按压态阴影 */

      /* Legacy compatibility */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);

      /* ===================================
         动画 - Animation
         =================================== */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --duration-fast: 150ms;
      --duration-normal: 250ms;
      --duration-slow: 500ms;

      /* ===================================
         Z-index 层级
         =================================== */
      --z-base: 1;
      --z-dropdown: 1000;
      --z-overlay: 5000;
      --z-modal: 6000;
      --z-toast: 9000;
      --z-index-modal: 6000;

      /* ===================================
         页面尺寸 - Dimensions
         =================================== */
      --width-mobile: 375px;           /* 移动端容器宽度 (iPhone 标准) */
      --navbar-height: 44px;
      --tabbar-height: 56px;
      --viewport-max-width: 375px;

      /* ===================================
         Legacy Font Size Compatibility - REMOVED
         不符合eufy v0.6规范，已删除所有legacy字体变量
         =================================== */
      --line-height-normal: 1.5;
    }

    /* ============================================
       Global Styles (from css/style.css)
       ============================================ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family);
      font-size: var(--font-body);
      line-height: 1.5;
      color: var(--fg-primary);
      background-color: var(--bg-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      height: 100vh;
      overflow: hidden;
    }

    /* 确保所有表单元素使用 MontForAnker 字体 */
    button,
    input,
    select,
    textarea,
    optgroup,
    option {
      font-family: var(--font-family);
    }

    /* Viewport Container - eufy v0.6 */
    .viewport-container {
      max-width: var(--viewport-max-width);
      width: 100%;
      height: 100vh;
      margin: 0 auto;
      background-color: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      position: relative;
      box-shadow: var(--shadow-base);
      overflow: hidden;
    }

    /* Navbar - eufy v0.6 (optimized for mobile) */
    .navbar-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: var(--navbar-height);
      padding: 0 var(--ref-padding-l);
      background-color: var(--bg-secondary);
      border-bottom: 0.33px solid var(--fill-secondary);
      position: sticky;
      top: 0;
      z-index: var(--z-index-sticky);
    }

    .navbar-back {
      min-width: 60px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      font-size: var(--font-body);
      color: var(--brand-fg-primary);
    }

    .navbar-title {
      flex: 1;
      text-align: center;
      font-size: var(--font-title1);
      font-weight: var(--font-weight-semibold);
      color: var(--fg-primary);
    }

    .navbar-action {
      min-width: 60px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: var(--ref-padding-s);
    }

    /* Page Content - eufy v0.6 */
    .page {
      flex: 1;
      overflow-y: hidden;
      padding-bottom: calc(var(--tabbar-height) + env(safe-area-inset-bottom));
      background-color: var(--bg-primary);
    }

    .page-inner {
      padding: var(--ref-padding-l);
    }

    /* Bottom Tabbar - eufy v0.6 */
    .bottom-tabbar {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      max-width: var(--viewport-max-width);
      width: 100%;
      height: calc(var(--tabbar-height) + env(safe-area-inset-bottom));
      background-color: var(--bg-secondary);
      border-top: 0.33px solid var(--fill-secondary);
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      padding-top: var(--ref-padding-xs);
      padding-bottom: env(safe-area-inset-bottom);
      z-index: var(--z-index-fixed);
    }

    .tab-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: var(--fg-tertiary);
      transition: color 150ms ease;
      padding: var(--ref-padding-xs) 0;
      cursor: pointer;
    }

    .tab-item.active {
      color: var(--brand-fg-primary);
    }

    .tab-item:hover {
      opacity: 0.8;
    }

    .tab-icon {
      margin-bottom: var(--ref-padding-xxs);
      position: relative;
    }

    /* Icon fill effect like WeChat */
    .tab-icon svg {
      transition: opacity 0.2s ease;
    }

    /* Unselected: semi-transparent to look like outline */
    .tab-item:not(.active) .tab-icon svg {
      opacity: 0.4;
    }

    /* Selected: fully opaque to look filled */
    .tab-item.active .tab-icon svg {
      opacity: 1;
    }

    .tab-label {
      font-size: var(--font-caption1);
      font-weight: var(--font-weight-regular);
    }

    /* Selected tab label is bold */
    .tab-item.active .tab-label {
      font-weight: var(--font-weight-semibold);
    }

    /* Buttons - eufy v0.6 */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--ref-padding-s);
      height: var(--ref-min-height-m);
      padding: 0 var(--ref-padding-l);
      font-size: var(--font-body);
      font-weight: var(--font-weight-semibold);
      text-align: center;
      border: none;
      border-radius: var(--comp-btn-radius);
      cursor: pointer;
      transition: all 150ms ease;
      font-family: var(--font-family);
      white-space: nowrap;
      user-select: none;
      box-shadow: var(--shadow-base);
      width: 100%;
    }

    .btn-primary {
      background-color: var(--brand-fg-primary);
      color: var(--fg-white);
    }

    .btn-primary:hover {
      opacity: 0.92;
    }

    .btn-primary:active {
      opacity: 0.84;
    }

    .btn-primary:disabled {
      background-color: var(--fill-secondary);
      color: var(--fg-quaternary);
      cursor: not-allowed;
      opacity: 1;
    }

    .btn-secondary {
      background-color: var(--bg-secondary);
      color: var(--brand-fg-primary);
      border: 1px solid var(--fill-primary);
      box-shadow: none;
    }

    .btn-secondary:hover {
      background-color: var(--fill-tertiary);
      border-color: var(--fill-secondary);
    }

    .btn-secondary:active {
      background-color: var(--fill-secondary);
      border-color: var(--fill-primary);
    }

    .btn-secondary:disabled {
      background-color: var(--fill-tertiary);
      color: var(--fg-quaternary);
      border-color: var(--fill-tertiary);
      cursor: not-allowed;
      opacity: 1;
    }

    .btn-danger {
      background-color: var(--function-error);
      color: var(--fg-white);
    }

    .btn-danger:hover {
      opacity: 0.92;
    }

    .btn-danger:active {
      opacity: 0.84;
    }

    .btn-loading {
      position: relative;
      color: transparent;
      pointer-events: none;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border: 2px solid currentColor;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Form Elements - eufy v0.6 */
    .form-group {
      width: 100%;
      margin-bottom: var(--ref-padding-m);
    }

    .form-label {
      display: block;
      font-size: var(--font-caption2);
      font-weight: var(--font-weight-semibold);
      color: var(--fg-primary);
      margin-bottom: var(--ref-padding-xs);
    }

    .form-label-required::after {
      content: ' *';
      color: var(--function-error);
    }

    .form-input {
      width: 100%;
      height: var(--ref-min-height-m);
      padding: 0 var(--ref-padding-l);
      font-family: var(--font-family);
      font-size: var(--font-body);
      color: var(--fg-primary);
      background-color: var(--bg-secondary);
      border: 0.33px solid var(--fill-secondary);
      border-radius: var(--comp-input-radius);
      outline: none;
      transition: all 150ms ease;
    }

    .form-input::placeholder {
      color: var(--fg-tertiary);
    }

    .form-input:focus {
      border-color: var(--brand-fg-primary);
      box-shadow: 0 0 0 2px var(--brand-fill-primary);
    }

    .form-input:disabled {
      background-color: var(--fill-tertiary);
      color: var(--fg-primary);
      cursor: not-allowed;
    }

    .form-input.error {
      border-color: var(--function-error);
    }

    .form-input.error:focus {
      box-shadow: 0 0 0 2px rgba(255, 59, 48, 0.1);
    }

    /* Select dropdown arrow styling */
    select.form-input {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      padding-right: calc(var(--ref-padding-l) * 2 + 12px); /* Space for arrow icon */
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M2.5 4.5L6 8L9.5 4.5' stroke='%2386868B' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right var(--ref-padding-l) center;
      cursor: pointer;
    }

    .form-error {
      font-size: var(--font-caption2);
      color: var(--function-error);
      margin-top: var(--ref-padding-xs);
      display: none;
    }

    .form-error.visible {
      display: block;
    }

    /* Card - eufy v0.6 */
    .card {
      background-color: var(--bg-secondary);
      border-radius: var(--comp-card-radius);
      padding: var(--ref-padding-l);
      margin-bottom: var(--ref-padding-m);
      box-shadow: var(--shadow-base);
      overflow: hidden;
    }

    /* App Icon Container - iOS Style */
    .app-icon-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      user-select: none;
      transition: transform 150ms ease;
    }

    .app-icon-container:active {
      transform: scale(0.92);
    }

    .app-icon-container.app-disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .app-icon-container.app-disabled:active {
      transform: none;
    }

    .app-icon {
      width: 60px;
      height: 60px;
      border-radius: var(--ref-radius-m);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
      margin-bottom: var(--spacing-xs);
      transition: all 150ms ease;
    }

    .app-icon-container:hover .app-icon {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.16);
    }

    .app-icon-container:active .app-icon {
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
    }

    .app-label {
      font-size: var(--font-caption2);
      color: var(--fg-primary);
      text-align: center;
      line-height: 1.2;
      width: 100%;
      font-weight: var(--font-weight-regular);
    }

    .app-icon-container.app-disabled .app-label {
      color: var(--fg-tertiary);
    }

    /* List Item - eufy v0.6 */
    .list-item {
      display: flex;
      align-items: center;
      min-height: 56px;
      padding: var(--ref-padding-m) var(--ref-padding-l);
      background-color: var(--bg-secondary);
      border-bottom: 0.33px solid var(--fill-secondary);
      cursor: pointer;
      transition: background-color 150ms ease;
    }

    .list-item:hover {
      background-color: var(--brand-fill-tertiary);
    }

    .list-item:active {
      background-color: var(--brand-fill-secondary);
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-item-content {
      flex: 1;
      min-width: 0;
    }

    .list-item-title {
      font-size: var(--font-body);
      font-weight: var(--font-weight-regular);
      color: var(--fg-primary);
      margin-bottom: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .list-item-subtitle {
      font-size: var(--font-caption2);
      color: var(--fg-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .list-item-arrow {
      width: 20px;
      height: 20px;
      color: var(--fg-quaternary);
      margin-left: var(--ref-padding-m);
    }

    /* Empty State - eufy v0.6 */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--ref-padding-xl) var(--ref-padding-l);
      text-align: center;
    }

    .empty-state-icon {
      width: 120px;
      height: 120px;
      margin-bottom: var(--ref-padding-l);
      opacity: 0.6;
      color: var(--fg-tertiary);
    }

    .empty-state-title {
      font-size: var(--font-title1);
      font-weight: var(--font-weight-semibold);
      color: var(--fg-primary);
      margin-bottom: var(--ref-padding-s);
    }

    .empty-state-description {
      font-size: var(--font-body);
      color: var(--fg-secondary);
      max-width: 280px;
    }

    /* Modal - eufy v0.6 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: var(--z-index-modal);
      padding: var(--ref-padding-l);
    }

    .modal-content {
      width: 90%;
      max-width: 340px;
      background-color: var(--bg-secondary);
      border-radius: var(--comp-dialog-radius);
      box-shadow: var(--shadow-overlay);
      overflow: hidden;
    }

    .modal-body {
      padding: var(--ref-padding-l);
      display: flex;
      flex-direction: column;
      gap: var(--ref-padding-m);
    }

    .modal-title {
      font-size: var(--font-title1);
      font-weight: var(--font-weight-semibold);
      color: var(--fg-primary);
      text-align: center;
    }

    .modal-description {
      font-size: var(--font-body);
      color: var(--fg-secondary);
      line-height: 1.6;
      text-align: center;
    }

    .modal-footer {
      padding: var(--ref-padding-l);
      display: flex;
      gap: var(--ref-padding-m);
      border-top: 0.33px solid var(--fill-secondary);
    }

    .modal-footer .btn {
      flex: 1;
    }

    /* Company Selection Cards */
    .company-option {
      display: flex;
      align-items: center;
      padding: var(--ref-padding-m);
      border: 1.5px solid var(--fill-secondary);
      border-radius: var(--comp-card-radius);
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: var(--bg-primary);
    }

    .company-option:hover {
      border-color: var(--brand-fg-primary);
      background-color: var(--brand-bg-secondary);
    }

    .company-option.selected {
      border-color: var(--brand-fg-primary);
      background-color: var(--brand-bg-secondary);
    }

    .company-option-radio {
      width: 20px;
      height: 20px;
      border: 2px solid var(--fill-tertiary);
      border-radius: 50%;
      margin-right: var(--ref-padding-m);
      position: relative;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }

    .company-option.selected .company-option-radio {
      border-color: var(--brand-fg-primary);
    }

    .company-option.selected .company-option-radio::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 10px;
      height: 10px;
      background-color: var(--brand-fg-primary);
      border-radius: 50%;
    }

    .company-option-label {
      font-size: var(--font-body);
      font-weight: var(--font-weight-regular);
      color: var(--fg-primary);
    }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .text-left {
      text-align: left;
    }

    .text-right {
      text-align: right;
    }

    /* Toast Notification - eufy v0.6 */
    .toast {
      position: fixed;
      top: calc(var(--navbar-height) + var(--ref-padding-l));
      left: 50%;
      transform: translateX(-50%);
      max-width: calc(var(--viewport-max-width) - var(--ref-padding-l) * 2);
      padding: var(--ref-padding-m) var(--ref-padding-l);
      border-radius: var(--comp-toast-radius);
      font-size: var(--font-body);
      font-weight: var(--font-weight-regular);
      color: var(--fg-white);
      background-color: var(--fill-toast);
      box-shadow: var(--shadow-overlay);
      z-index: var(--z-index-tooltip);
      animation: toast-in 200ms ease;
      display: flex;
      align-items: center;
      gap: var(--ref-padding-m);
    }

    .toast.success {
      background-color: var(--function-success);
    }

    .toast.error {
      background-color: var(--function-error);
    }

    .toast.warning {
      background-color: var(--function-warning);
    }

    .toast.info {
      background-color: var(--brand-fg-primary);
    }

    @keyframes toast-in {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin var(--duration-slow) linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes dash {
      0% {
        stroke-dashoffset: 0;
      }
      50% {
        stroke-dashoffset: 15.7;
      }
      100% {
        stroke-dashoffset: 31.4;
      }
    }

    /* File Upload Area */
    .file-upload-area {
      cursor: pointer;
      background-color: var(--fill-tertiary);
      border: 2px dashed var(--fill-primary);
      border-radius: var(--ref-radius-m);
      padding: var(--spacing-xl);
      text-align: center;
      transition: all var(--duration-fast) ease;
    }

    .file-upload-area:hover {
      background-color: var(--fill-secondary);
      border-color: var(--brand-fg-primary);
    }

    .file-preview {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .file-preview img {
      max-width: 100%;
      max-height: 200px;
      border-radius: var(--ref-radius-m);
      object-fit: contain;
    }

    /* Filter Chips */
    .filter-chips-container {
      display: flex;
      gap: var(--ref-padding-s);
      overflow-x: auto;
      padding: var(--ref-padding-m) var(--ref-padding-l);
      background-color: var(--bg-secondary);
      -webkit-overflow-scrolling: touch;
    }

    .filter-chips-container::-webkit-scrollbar {
      display: none;
    }

    .filter-chip {
      display: inline-flex;
      align-items: center;
      height: 32px;
      padding: 0 var(--ref-padding-l);
      border-radius: 1000px;
      font-size: var(--font-body);
      font-weight: var(--font-weight-regular);
      white-space: nowrap;
      cursor: pointer;
      transition: all var(--duration-fast) ease;
      background-color: var(--fill-tertiary);
      color: var(--fg-tertiary);
      border: none;
    }

    .filter-chip:hover {
      background-color: var(--fill-secondary);
      color: var(--fg-secondary);
    }

    .filter-chip.active {
      background-color: var(--brand-fg-primary);
      color: var(--fg-white);
      font-weight: var(--font-weight-semibold);
    }

    .filter-chip.active:hover {
      background-color: var(--brand-fg-primary);
      opacity: 0.9;
    }

    /* Scanner Modal Styles */
    .scanner-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      display: none;
      flex-direction: column;
    }

    .scanner-modal.active {
      display: flex;
    }

    .scanner-header {
      padding: var(--spacing-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .scanner-header h3 {
      font-size: var(--font-title1);
      font-weight: var(--font-weight-semibold);
      margin: 0;
    }

    .scanner-close {
      background: none;
      border: none;
      color: white;
      font-size: var(--font-display2);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scanner-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-md);
    }

    #qr-reader {
      width: 100%;
      max-width: 500px;
      border: 2px solid var(--color-primary);
      border-radius: var(--border-radius-md);
      overflow: hidden;
    }

    .scanner-instructions {
      margin-top: var(--spacing-lg);
      color: white;
      text-align: center;
      font-size: var(--font-body);
      padding: 0 var(--spacing-lg);
    }

    .scanner-manual-input {
      margin-top: var(--spacing-lg);
      text-align: center;
    }

    .scanner-manual-input button {
      color: var(--color-primary);
      background: none;
      border: 1px solid var(--color-primary);
      padding: var(--spacing-sm) var(--spacing-lg);
      border-radius: var(--border-radius-md);
      cursor: pointer;
      font-size: var(--font-caption2);
    }
  </style>
</head>
<body>
  <!-- Login View -->
  <div id="loginView" class="viewport-container hidden">
    <div class="page" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--spacing-xl);">
      <!-- App Title -->
      <div style="text-align: center; margin-bottom: var(--spacing-xxl);">
        <h1 style="font-size: var(--font-display2); font-weight: var(--font-weight-bold); color: var(--color-text-primary); letter-spacing: -0.5px;">Anker Partner</h1>
      </div>

      <!-- Login Form -->
      <form id="loginForm" style="width: 100%; max-width: 320px;" novalidate>
        <div class="form-group">
          <label class="form-label form-label-required">Email</label>
          <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email">
          <div class="form-error"></div>
        </div>

        <div class="form-group">
          <label class="form-label form-label-required">Password</label>
          <div style="position: relative;">
            <input type="password" class="form-input" id="loginPassword" placeholder="Enter password">
            <button type="button" id="togglePassword" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 4px; color: var(--color-text-tertiary);">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
              </svg>
            </button>
          </div>
          <div class="form-error"></div>
        </div>

        <button type="submit" class="btn btn-primary" id="loginBtn" style="margin-top: var(--spacing-xl);">Login</button>

        <div style="text-align: center; margin-top: var(--spacing-lg);">
          <button type="button" class="btn btn-secondary" onclick="showPartnerApplication()" style="width: 100%;">Become a Partner</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Partner Application View -->
  <div id="partnerApplicationView" class="viewport-container hidden">
    <div class="navbar-container">
      <div class="navbar-back">
        <span onclick="hidePartnerApplication()" style="cursor: pointer; color: var(--brand-fg-primary);">‹ Back</span>
      </div>
      <div class="navbar-title">Partner Application</div>
      <div class="navbar-action"></div>
    </div>

    <div class="page" style="overflow-y: auto;">
      <div class="page-inner">
        <form id="partnerApplicationForm" novalidate>
          <!-- Account Email -->
          <div class="form-group">
            <label class="form-label form-label-required">Account Email</label>
            <input type="email" class="form-input" id="appEmail" placeholder="Enter your email">
            <div class="form-error"></div>
          </div>

          <!-- Business Type -->
          <div class="form-group">
            <label class="form-label form-label-required">Business Type</label>
            <select class="form-input" id="appBusinessType" disabled>
              <option value="installer" selected>Installer</option>
            </select>
            <div class="form-error"></div>
          </div>

          <!-- Company Name -->
          <div class="form-group">
            <label class="form-label form-label-required">Company Name</label>
            <input type="text" class="form-input" id="appCompanyName" placeholder="Enter company name">
            <div class="form-error"></div>
          </div>

          <!-- Company Description -->
          <div class="form-group">
            <label class="form-label">Company Description</label>
            <textarea class="form-input" id="appCompanyDesc" placeholder="Describe your company" rows="1" style="resize: none; overflow: hidden; line-height: 1.5; padding: 11px var(--ref-padding-l); height: auto;"></textarea>
          </div>

          <!-- Sales Region -->
          <div class="form-group">
            <label class="form-label form-label-required">Sales Region</label>
            <select class="form-input" id="appCountry" disabled>
              <option value="USA" selected>United States</option>
            </select>
            <div class="form-error"></div>
          </div>

          <div class="form-group">
            <label class="form-label form-label-required">State and City</label>
            <input type="text" class="form-input" id="appLocation" placeholder="e.g., CA - Los Angeles, SF">
            <div class="form-error"></div>
          </div>

          <!-- Business License -->
          <div class="form-group">
            <label class="form-label form-label-required">Business License</label>
            <div class="file-upload-area" onclick="triggerFileUpload('businessLicense')">
              <input type="file" id="businessLicense" accept="image/*" style="display: none;" onchange="handleFileSelect(this, 'businessLicensePreview')">
              <div id="businessLicensePreview" class="file-preview">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--fg-tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <div style="margin-top: var(--spacing-sm); color: var(--fg-secondary); font-size: var(--font-caption2);">Tap to upload or take photo</div>
              </div>
            </div>
            <div class="form-error"></div>
          </div>

          <!-- Sales License -->
          <div class="form-group">
            <label class="form-label form-label-required">Sales License</label>
            <div class="file-upload-area" onclick="triggerFileUpload('salesLicense')">
              <input type="file" id="salesLicense" accept="image/*" style="display: none;" onchange="handleFileSelect(this, 'salesLicensePreview')">
              <div id="salesLicensePreview" class="file-preview">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--fg-tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <div style="margin-top: var(--spacing-sm); color: var(--fg-secondary); font-size: var(--font-caption2);">Tap to upload or take photo</div>
              </div>
            </div>
            <div class="form-error"></div>
          </div>

          <!-- Insurance -->
          <div class="form-group">
            <label class="form-label form-label-required">Insurance</label>
            <div class="file-upload-area" onclick="triggerFileUpload('insurance')">
              <input type="file" id="insurance" accept="image/*" style="display: none;" onchange="handleFileSelect(this, 'insurancePreview')">
              <div id="insurancePreview" class="file-preview">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--fg-tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <div style="margin-top: var(--spacing-sm); color: var(--fg-secondary); font-size: var(--font-caption2);">Tap to upload or take photo</div>
              </div>
            </div>
            <div class="form-error"></div>
          </div>

          <!-- Terms Agreement -->
          <div class="form-group">
            <div style="display: flex; align-items: flex-start; gap: var(--spacing-sm); cursor: pointer;" onclick="showAgreementModal()">
              <input type="checkbox" id="termsCheckbox" disabled style="margin-top: 2px; pointer-events: none;">
              <label style="flex: 1; font-size: var(--font-caption2); color: var(--fg-secondary); line-height: 1.5; cursor: pointer;">
                I have read and agree to the <span style="color: var(--brand-fg-primary); text-decoration: underline;">User Service Agreement and Privacy Policy</span>
              </label>
            </div>
            <div class="form-error"></div>
          </div>

          <button type="submit" class="btn btn-primary" id="submitApplicationBtn" style="margin-top: var(--spacing-lg);">Submit Application</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Main App View -->
  <div id="mainAppView" class="viewport-container">
    <!-- Navbar -->
    <div class="navbar-container">
      <div class="navbar-back"></div>
      <div class="navbar-title" id="navbarTitle">Home</div>
      <div class="navbar-action"></div>
    </div>

    <!-- Page Content -->
    <div class="page" id="pageContent">
      <!-- Home Tab Content -->
      <div id="homeContent" style="display: flex; flex-direction: column; height: 100%;">
        <div class="page-inner" style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
          <!-- Data Dashboard -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--ref-padding-m); margin-bottom: var(--ref-padding-m); flex-shrink: 0;">
            <!-- Registered Devices Card -->
            <div class="card" style="text-align: center; padding: var(--ref-padding-m) var(--ref-padding-s);">
              <div style="font-size: 32px; font-weight: var(--font-weight-bold); color: var(--brand-fg-primary); margin-bottom: var(--spacing-xs); line-height: 1;">6</div>
              <div style="font-size: var(--font-caption2); color: var(--fg-secondary); line-height: 1.4;">Registered<br>Devices</div>
            </div>

            <!-- Subscribed Services Card -->
            <div class="card" style="text-align: center; padding: var(--ref-padding-m) var(--ref-padding-s);">
              <div style="font-size: 32px; font-weight: var(--font-weight-bold); color: var(--brand-fg-primary); margin-bottom: var(--spacing-xs); line-height: 1;">3</div>
              <div style="font-size: var(--font-caption2); color: var(--fg-secondary); line-height: 1.4;">Subscribed<br>Services</div>
            </div>
          </div>

          <!-- Applications Grid by Category -->
          <div style="display: flex; flex-direction: column; justify-content: space-evenly; flex: 1; min-height: 0;">
            <!-- Business Section -->
            <div>
              <div style="font-size: var(--font-caption2); font-weight: var(--font-weight-regular); color: var(--fg-tertiary); margin-bottom: var(--ref-padding-s); padding-left: var(--ref-padding-xs);">Business</div>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--ref-padding-m);">
                <!-- Products -->
                <div class="app-icon-container" onclick="showTab('productsTab')">
                  <div class="app-icon" style="background: #FFFFFF;">
                    <svg width="24" height="24" viewBox="0 0 1024 1024" fill="var(--fg-primary)">
                      <path d="M918.3 655.3c-8.7-15.1-28-20.3-43.1-11.5L672.8 760.6 167.6 421c-14.5-9.7-34-5.9-43.8 8.6-9.7 14.5-5.9 34 8.6 43.8l182.7 122.8-57.6 80.6h-91V563c0-17.4-14.1-31.5-31.5-31.5s-31.5 14.1-31.5 31.5v333.5c0 17.4 14.1 31.5 31.5 31.5s31.5-14.1 31.5-31.5V739.8h124v-0.1l76-109.1 287.4 193.2c0.1 0.1 0.3 0.2 0.4 0.2 0.6 0.4 1.3 0.8 2 1.2 0.2 0.1 0.4 0.2 0.7 0.4 0.8 0.4 1.5 0.8 2.3 1.1 0.2 0.1 0.3 0.1 0.5 0.2 0.9 0.4 1.8 0.7 2.7 1h0.1c8 2.4 17 1.7 24.8-2.9l219.5-126.7c15-8.6 20.1-27.9 11.4-43z"></path>
                      <path d="M129.3 320.5L650.6 671c4.7 3.1 9.8 4.8 15.1 5.2 7.5 1.3 15.5-0.1 22.5-4.5l219.1-141.2c14.6-9.4 18.9-28.9 9.4-43.6l-0.1-0.1c-2.3-3.8-5.4-7.2-9.3-9.8L353.2 104.5c-11.3-8.4-27.1-8.4-38.5 0.7-0.1 0-0.1 0.1-0.2 0.1-0.3 0.3-0.6 0.5-0.9 0.7L126.9 269.6c-1.6 1.4-3 2.9-4.2 4.5l-0.1 0.1-0.1 0.1-1.8 2.4c-9.7 14.5-5.9 34.1 8.6 43.8z m207.5-150.9l496.4 333.7-162.9 105-472-317.3 138.5-121.4z"></path>
                    </svg>
                  </div>
                  <div class="app-label">Products</div>
                </div>

                <!-- Register -->
                <div class="app-icon-container" onclick="showTab('registrationTab')">
                  <div class="app-icon" style="background: #FFFFFF;">
                    <svg width="24" height="24" viewBox="0 0 1024 1024" fill="var(--fg-primary)">
                      <path d="M928.016126 543.908618 95.983874 543.908618c-17.717453 0-31.994625-14.277171-31.994625-31.994625S78.26642 479.919368 95.983874 479.919368l832.032253 0c17.717453 0 31.994625 14.277171 31.994625 31.994625S945.73358 543.908618 928.016126 543.908618z"></path>
                      <path d="M832.032253 928.016126 639.892491 928.016126c-17.717453 0-31.994625-14.277171-31.994625-31.994625s14.277171-31.994625 31.994625-31.994625l191.967747 0c17.717453 0 31.994625-14.277171 31.994625-31.994625l0-159.973123c0-17.717453 14.277171-31.994625 31.994625-31.994625s31.994625 14.277171 31.994625 31.994625l0 159.973123C928.016126 884.840585 884.840585 928.016126 832.032253 928.016126z"></path>
                      <path d="M351.94087 928.016126l-159.973123 0c-52.980346 0-95.983874-43.003528-95.983874-95.983874l0-159.973123c0-17.717453 14.277171-31.994625 31.994625-31.994625S159.973123 654.341676 159.973123 672.05913l0 159.973123c0 17.717453 14.449185 31.994625 31.994625 31.994625l159.973123 0c17.717453 0 31.994625 14.277171 31.994625 31.994625C383.935495 913.738955 369.658324 928.016126 351.94087 928.016126z"></path>
                      <path d="M127.978498 383.935495c-17.717453 0-31.994625-14.277171-31.994625-31.994625l0-159.973123c0-52.980346 43.003528-95.983874 95.983874-95.983874l159.973123 0c17.717453 0 31.994625 14.277171 31.994625 31.994625S369.658324 159.973123 351.94087 159.973123l-159.973123 0c-17.545439 0-31.994625 14.449185-31.994625 31.994625l0 159.973123C159.973123 369.658324 145.695952 383.935495 127.978498 383.935495z"></path>
                      <path d="M896.021502 383.935495c-17.717453 0-31.994625-14.277171-31.994625-31.994625l0-159.973123c0-17.545439-14.277171-31.994625-31.994625-31.994625L639.892491 159.973123c-17.717453 0-31.994625-14.277171-31.994625-31.994625s14.277171-31.994625 31.994625-31.994625l191.967747 0c52.980346 0 95.983874 43.003528 95.983874 95.983874l0 159.973123C928.016126 369.658324 913.738955 383.935495 896.021502 383.935495z"></path>
                    </svg>
                  </div>
                  <div class="app-label">Register</div>
                </div>

                <!-- Maintenance -->
                <div class="app-icon-container" onclick="openMaintenanceDetail()">
                  <div class="app-icon" style="background: #FFFFFF;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--fg-primary)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                    </svg>
                  </div>
                  <div class="app-label">Maintenance</div>
                </div>

                <!-- Subscription -->
                <div class="app-icon-container" onclick="openSubscriptionManagement()">
                  <div class="app-icon" style="background: #FFFFFF;">
                    <svg width="24" height="24" viewBox="0 0 1024 1024" fill="var(--fg-primary)">
                      <path d="M834.485 82h-644.969c-14.854 0-26.875 12.021-26.875 26.875v806.237a26.893 26.893 0 0 0 14.172 23.673c8.768 4.724 19.289 4.199 27.582-1.287l307.609-204.307 307.592 204.307a26.876 26.876 0 0 0 14.883 4.489c4.352 0 8.711-1.05 12.705-3.202a26.873 26.873 0 0 0 14.176-23.673v-806.237c0.005-14.854-12.02-26.875-26.875-26.875z m-26.875 783.01l-269.645-179.113c-15.379-10.236-36.324-10.288-51.807-0.059l-269.768 179.172v-729.261h591.219v729.261z"></path>
                      <path d="M377.637 431.403h107.492v107.524c0 14.829 12.02 26.875 26.875 26.875s26.875-12.046 26.875-26.875v-107.524h107.49c14.855 0 26.875-12.021 26.875-26.874 0-14.861-12.02-26.908-26.875-26.908h-107.49v-107.499c0-14.854-12.02-26.874-26.875-26.874s-26.875 12.021-26.875 26.874v107.499h-107.492c-14.828 0-26.875 12.047-26.875 26.908 0 14.853 12.047 26.874 26.875 26.874z"></path>
                    </svg>
                  </div>
                  <div class="app-label">Subscription</div>
                </div>
              </div>
            </div>

            <!-- Tools & Resources Section -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--ref-padding-l);">
              <!-- Tools -->
              <div>
                <div style="font-size: var(--font-caption2); font-weight: var(--font-weight-regular); color: var(--fg-tertiary); margin-bottom: var(--ref-padding-s); padding-left: var(--ref-padding-xs);">Tools</div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--ref-padding-m);">
                  <!-- 3D Plan -->
                  <div class="app-icon-container" onclick="showTab('planTab')">
                    <div class="app-icon" style="background: #FFFFFF;">
                      <svg width="24" height="24" viewBox="0 0 1024 1024" fill="var(--fg-primary)">
                        <path d="M864.757183 264.990257l-319.895751-191.573154c-10.116405-6.057973-21.48943-9.086959-32.861432-9.086959a63.915705 63.915705 0 0 0-32.861432 9.086959l-319.895751 191.573154a63.961754 63.961754 0 0 0-31.099298 54.873771v390.954133a63.960731 63.960731 0 0 0 31.980365 55.391565l319.895751 184.692442c9.894348 5.713119 20.937868 8.569166 31.980365 8.569166s22.086018-2.856048 31.980365-8.569166l319.895751-184.692442a63.959707 63.959707 0 0 0 31.980365-55.391565v-390.954133a63.959707 63.959707 0 0 0-31.099298-54.873771zM512 128.289851l288.778032 172.937725-289.062511 173.228343-288.603047-173.161828 288.887526-173.00424z m-319.895751 228.989322l287.621697 172.573427v347.022575L192.104249 710.817138V357.279173zM543.686676 877.214912V529.862833l288.209075-172.71669v353.670995L543.686676 877.214912z"></path>
                      </svg>
                    </div>
                    <div class="app-label">3D Plan</div>
                  </div>

                  <!-- WiFi Signal -->
                  <div class="app-icon-container">
                    <div class="app-icon" style="background: #FFFFFF;">
                      <svg width="24" height="24" viewBox="0 0 1024 1024" fill="var(--fg-primary)">
                        <path d="M723 620.5C666.8 571.6 593.4 542 513 542s-153.8 29.6-210.1 78.6c-3.2 2.8-3.6 7.8-0.8 11.2l36 42.9c2.9 3.4 8 3.8 11.4 0.9C393.1 637.2 450.3 614 513 614s119.9 23.2 163.5 61.5c3.4 2.9 8.5 2.5 11.4-0.9l36-42.9c2.8-3.3 2.4-8.3-0.9-11.2zM840.4 480.4C751.7 406.5 637.6 362 513 362s-238.7 44.5-327.5 118.4c-3.4 2.8-3.8 7.9-1 11.3l36 42.9c2.8 3.4 7.9 3.8 11.2 1C308 472.2 406.1 434 513 434s205 38.2 281.2 101.6c3.4 2.8 8.4 2.4 11.2-1l36-42.9c2.8-3.4 2.4-8.5-1-11.3z"></path>
                        <path d="M957.1 341.4C835.7 241.8 680.3 182 511 182c-168.2 0-322.6 59-443.7 157.4-3.5 2.8-4 7.9-1.1 11.4l36 42.9c2.8 3.3 7.8 3.8 11.1 1.1C222 306.7 360.3 254 511 254c151.8 0 291 53.5 400 142.7 3.4 2.8 8.4 2.3 11.2-1.1l36-42.9c2.9-3.4 2.4-8.5-1.1-11.3z"></path>
                        <path d="M512 778m-64 0a64 64 0 1 0 128 0 64 64 0 1 0-128 0Z"></path>
                      </svg>
                    </div>
                    <div class="app-label">WiFi Signal</div>
                  </div>
                </div>
              </div>

              <!-- Resources -->
              <div>
                <div style="font-size: var(--font-caption2); font-weight: var(--font-weight-regular); color: var(--fg-tertiary); margin-bottom: var(--ref-padding-s); padding-left: var(--ref-padding-xs);">Resources</div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--ref-padding-m);">
                  <!-- Materials -->
                  <div class="app-icon-container">
                    <div class="app-icon" style="background: #FFFFFF;">
                      <svg t="1767755305659" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="30375" width="24" height="24">
                        <path d="M647.9305 260.951538H172.144332a27.187781 27.187781 0 0 0 0 54.339019h475.786168a27.187781 27.187781 0 0 0 0-54.339019z m27.04161 239.902933a27.114696 27.114696 0 0 0-27.04161-27.187781H172.144332a27.187781 27.187781 0 0 0 0 54.375563h475.786168a27.078153 27.078153 0 0 0 27.04161-27.370495zM172.144332 664.383128a27.187781 27.187781 0 0 0 0 54.339019h259.818714a27.187781 27.187781 0 0 0 0-54.339019H172.144332z m261.64585 282.767539H151.314984a61.355221 61.355221 0 0 1-61.026337-61.501391V115.913497a61.391764 61.391764 0 0 1 61.026337-61.537935h565.315823a61.391764 61.391764 0 0 1 61.026337 61.537935v384.758261a27.04161 27.04161 0 1 0 54.08322 0V115.913497A115.803868 115.803868 0 0 0 716.630807 0H151.314984A115.584612 115.584612 0 0 0 36.205427 115.913497v769.553065a115.548069 115.548069 0 0 0 115.109557 115.876954h282.475198a27.187781 27.187781 0 0 0 0-54.375562z m541.928485-354.720148a26.785811 26.785811 0 0 0-24.849047-3.179216l-194.407252 72.500749a21.231318 21.231318 0 0 0-4.750553 2.631076h-144.709157a86.533153 86.533153 0 0 0-86.240811 86.569695v45.020626a86.935122 86.935122 0 0 0 54.814075 80.393977v63.949753a83.427022 83.427022 0 0 0 82.951966 83.646278h40.562415a83.500107 83.500107 0 0 0 83.317394-83.646278v-47.176647l168.461923 62.853473a28.028264 28.028264 0 0 0 9.501106 1.680965 26.054957 26.054957 0 0 0 15.347941-4.860182 27.187781 27.187781 0 0 0 11.693669-22.291057V614.64849a27.187781 27.187781 0 0 0-11.693669-22.400685z m-400.8736 158.193419a32.340304 32.340304 0 0 1 32.157591-32.230676h131.919206v109.62815h-131.919206a32.376847 32.376847 0 0 1-32.157591-32.230676v-45.166798z m148.728856 189.4009a24.447077 24.447077 0 0 1-24.48362 24.337449h-40.562415a24.337449 24.337449 0 0 1-24.118193-24.337449v-42.133752h89.164228v42.279922z m209.755193-48.784527l-140.689459-52.365712v-133.052031l140.689459-52.365713v237.783456z" p-id="30376"></path>
                      </svg>
                    </div>
                    <div class="app-label">Materials</div>
                  </div>

                  <!-- Training -->
                  <div class="app-icon-container">
                    <div class="app-icon" style="background: #FFFFFF;">
                      <svg t="1767755339985" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33270" width="24" height="24">
                        <path d="M488.96 91.0848h56.32v113.4592h-56.32zM217.7536 922.22464l73.1136-132.16768 49.28 27.264-73.10848 132.16768zM688.29184 816.32768l49.28-27.264 73.63072 133.10976-49.28 27.25888z" fill="#4C4C4C" p-id="33271"></path>
                        <path d="M849.5616 766.72H184.6784a89.7536 89.7536 0 0 1-89.6-89.6V266.24a89.7024 89.7024 0 0 1 89.6-89.6h664.8832a89.7024 89.7024 0 0 1 89.6 89.6v411.0848a89.7536 89.7536 0 0 1-89.6 89.3952zM184.6784 232.7552a33.28 33.28 0 0 0-33.28 33.28v411.0848a33.3312 33.3312 0 0 0 33.28 33.28h664.8832a33.3312 33.3312 0 0 0 33.28-33.28V266.24a33.28 33.28 0 0 0-33.28-33.28z" fill="#4C4C4C" p-id="33272"></path>
                        <path d="M313.856 360.5504h412.3648v56.32H313.856zM313.856 531.7632h412.3648v56.32H313.856z" fill="#4C4C4C" p-id="33273"></path>
                      </svg>
                    </div>
                    <div class="app-label">Training</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Rewards & Community Section -->
            <div>
              <div style="font-size: var(--font-caption2); font-weight: var(--font-weight-regular); color: var(--fg-tertiary); margin-bottom: var(--ref-padding-s); padding-left: var(--ref-padding-xs);">Rewards & Community</div>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--ref-padding-m);">
                <!-- Points Mall -->
                <div class="app-icon-container">
                  <div class="app-icon" style="background: #FFFFFF;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--fg-primary)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="20 12 20 22 4 22 4 12"></polyline>
                      <rect x="2" y="7" width="20" height="5"></rect>
                      <line x1="12" y1="22" x2="12" y2="7"></line>
                      <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path>
                      <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
                    </svg>
                  </div>
                  <div class="app-label">Points Mall</div>
                </div>

                <!-- Community -->
                <div class="app-icon-container">
                  <div class="app-icon" style="background: #FFFFFF;">
                    <svg width="24" height="24" viewBox="0 0 1024 1024" fill="var(--fg-primary)">
                      <path d="M853.333333 568.888889h113.777778v56.888889h-113.777778v-56.888889z m56.888889-455.111111h56.888889v455.111111h-56.888889V113.777778z m-341.333333 284.444444h113.777778v113.777778h-113.777778V398.222222zM199.111111 56.888889H967.111111v56.888889H227.555556v56.888889H170.666667V56.888889h28.444444zM398.222222 398.222222h113.777778v113.777778H398.222222V398.222222zM227.555556 398.222222h113.777777v113.777778H227.555556V398.222222z m159.288888 341.333334L170.666667 910.222222v-170.666666H56.888889V170.666667h796.444444v568.888889H386.844444z m-22.755555-56.888889H796.444444V227.555556H113.777778v455.111111h113.777778v108.088889L364.088889 682.666667z"></path>
                    </svg>
                  </div>
                  <div class="app-label">Community</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Account View -->
      <div id="paymentAccountView" class="hidden" style="height: 100%; overflow-y: auto; background-color: var(--bg-primary);">
        <!-- Empty State Content -->
        <div id="paymentEmptyState" class="page-inner" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh;">
          <div style="text-align: center; padding: var(--spacing-xl) 0; width: 100%; max-width: 320px;">
            <div style="font-size: 64px; margin-bottom: var(--spacing-md); opacity: 0.4;">💳</div>
            <div style="font-size: var(--font-body); color: var(--fg-secondary); margin-bottom: var(--spacing-xl);">No Payment Account</div>
            <button class="btn btn-primary" onclick="showAddPaymentModal()">Add Payment Account</button>
          </div>
        </div>

        <!-- Account Info State -->
        <div id="paymentAccountInfo" class="hidden" style="flex: 1; overflow-y: auto;">
          <div class="page-inner">
            <div class="card" style="margin-bottom: var(--spacing-md);">
              <div style="padding: var(--spacing-md);">
                <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                  <svg width="32" height="32" viewBox="0 0 1024 1024">
                    <path d="M867.0208 865.4336H157.4912c-49.664 0-89.9584-40.2944-89.9584-89.9584V250.1632c0-49.664 40.2944-89.9584 89.9584-89.9584h709.5296c49.664 0 89.9584 40.2944 89.9584 89.9584v525.312c0 49.7152-40.2432 89.9584-89.9584 89.9584z" fill="#F49D22"></path>
                    <path d="M873.0624 160.2048H151.5008c-46.3872 0-83.968 37.5808-83.968 83.968v537.344c0 46.3872 37.5808 83.968 83.968 83.968h474.624c171.3664-128.6144 294.6048-321.2288 330.9056-548.4032V244.1728c-0.0512-46.3872-37.632-83.968-83.968-83.968z" fill="#F6AD2A"></path>
                    <path d="M764.3648 160.2048H151.5008c-46.3872 0-83.968 37.5808-83.968 83.968v537.344c0 5.632 0.5632 11.0592 1.6384 16.384 333.2096-52.8384 611.7376-300.8512 695.1936-637.696z" fill="#F9BF34"></path>
                    <path d="M461.9264 160.2048H151.5008c-46.3872 0-83.968 37.5808-83.968 83.968v249.5488C229.888 426.9568 368.5888 310.272 461.9264 160.2048z" fill="#FAC93A"></path>
                    <path d="M368.9984 505.4976H221.952a38.2464 38.2464 0 0 1 0-76.4928h146.9952a38.2464 38.2464 0 0 1 38.2464 38.2464c0 21.1456-17.1008 38.2464-38.1952 38.2464zM67.5328 303.0016h889.4976v76.4416H67.5328z" fill="#F7F8F8"></path>
                  </svg>
                  <div style="font-size: var(--font-title3); font-weight: var(--font-weight-semibold); color: var(--fg-primary);">Payment Card</div>
                </div>
                <div style="margin-bottom: var(--spacing-xs);">
                  <div style="font-size: var(--font-body); color: var(--fg-secondary); margin-bottom: 4px;">Card Number</div>
                  <div style="font-size: var(--font-title3); font-weight: var(--font-weight-semibold); color: var(--fg-primary); letter-spacing: 2px;">•••• •••• •••• <span id="cardLast4">••••</span></div>
                </div>
                <div>
                  <div style="font-size: var(--font-body); color: var(--fg-secondary); margin-bottom: 4px;">Expires</div>
                  <div style="font-size: var(--font-body); font-weight: var(--font-weight-medium); color: var(--fg-primary);"><span id="cardExpiry">MM/YY</span></div>
                </div>
              </div>
            </div>
            <button class="btn btn-secondary" style="width: 100%;" onclick="showAddPaymentModal()">Change Payment Account</button>
          </div>
        </div>
      </div>

      <!-- Billing History View -->
      <div id="billingHistoryView" class="hidden" style="height: 100%; display: flex; flex-direction: column; background-color: var(--bg-primary);">
        <!-- Fixed Header: Month Selector and Total -->
        <div style="background-color: #ffffff; border-bottom: 1px solid rgba(0, 0, 0, 0.10); padding: var(--spacing-sm) var(--ref-padding-l); flex-shrink: 0;">
          <!-- Labels Row -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <label style="font-size: var(--font-body); color: var(--fg-secondary);">Billing Period</label>
            <label style="font-size: var(--font-body); color: var(--fg-secondary);">Total</label>
          </div>
          <!-- Values Row -->
          <div style="display: flex; justify-content: space-between; align-items: center; gap: var(--spacing-md);">
            <div style="flex: 1;">
              <select class="form-input" id="billingMonthSelect" onchange="loadBillingHistory()" style="width: 100%; height: 40px; font-size: var(--font-body);">
                <option value="2026-01">January 2026</option>
                <option value="2025-12">December 2025</option>
                <option value="2025-11">November 2025</option>
                <option value="2025-10">October 2025</option>
                <option value="2025-09">September 2025</option>
              </select>
            </div>
            <div id="monthlyTotal" style="font-size: var(--font-title1); font-weight: var(--font-weight-bold); color: var(--brand-fg-primary); min-width: 100px; text-align: right;">$0.00</div>
          </div>
        </div>

        <!-- Scrollable Billing List -->
        <div style="flex: 1; overflow-y: auto; padding: var(--spacing-sm) var(--ref-padding-l) var(--ref-padding-l) var(--ref-padding-l);">
          <div id="billingList">
            <!-- Dynamic billing content -->
          </div>
        </div>
      </div>

      <!-- Products Tab Content -->
      <div id="productsContent" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
        <!-- Devices Content -->
        <div id="devicesSubContent" style="display: flex; flex: 1; overflow: hidden;">
          <!-- Left Category Tabs - Images Only -->
          <div style="width: 72px; background-color: var(--bg-secondary); display: flex; flex-direction: column; align-items: center; justify-content: space-evenly; padding: var(--ref-padding-xs) 0; flex-shrink: 0; overflow-y: auto;">
            <!-- Hub -->
            <div class="category-tab active" data-category="hub" style="cursor: pointer; width: 56px; height: 56px; border-radius: var(--ref-radius-s); background-color: var(--bg-primary); display: flex; align-items: center; justify-content: center;">
              <img src="images/categories/Hub.png" style="width: 36px; height: 36px; object-fit: contain;" alt="Hub">
            </div>

            <!-- Control Panel -->
            <div class="category-tab" data-category="control-panel" style="cursor: pointer; width: 56px; height: 56px; border-radius: var(--ref-radius-s); display: flex; align-items: center; justify-content: center;">
              <img src="images/categories/Control Panel.png" style="width: 36px; height: 36px; object-fit: contain;" alt="Control Panel">
            </div>

            <!-- Indoor Cam -->
            <div class="category-tab" data-category="indoor-cam" style="cursor: pointer; width: 56px; height: 56px; border-radius: var(--ref-radius-s); display: flex; align-items: center; justify-content: center;">
              <img src="images/categories/Indoor Cam.png" style="width: 36px; height: 36px; object-fit: contain;" alt="Indoor Cam">
            </div>

            <!-- Outdoor Cam -->
            <div class="category-tab" data-category="outdoor-cam" style="cursor: pointer; width: 56px; height: 56px; border-radius: var(--ref-radius-s); display: flex; align-items: center; justify-content: center;">
              <img src="images/categories/Outdoor Cam.png" style="width: 36px; height: 36px; object-fit: contain;" alt="Outdoor Cam">
            </div>

            <!-- Video Doorbell -->
            <div class="category-tab" data-category="video-doorbell" style="cursor: pointer; width: 56px; height: 56px; border-radius: var(--ref-radius-s); display: flex; align-items: center; justify-content: center;">
              <img src="images/categories/Video Doorbell.png" style="width: 36px; height: 36px; object-fit: contain;" alt="Video Doorbell">
            </div>

            <!-- Burglary Sensor -->
            <div class="category-tab" data-category="burglary-sensor" style="cursor: pointer; width: 56px; height: 56px; border-radius: var(--ref-radius-s); display: flex; align-items: center; justify-content: center;">
              <img src="images/categories/Burglary Sensor.png" style="width: 36px; height: 36px; object-fit: contain;" alt="Burglary Sensor">
            </div>

            <!-- Hazard Sensor -->
            <div class="category-tab" data-category="hazard-sensor" style="cursor: pointer; width: 56px; height: 56px; border-radius: var(--ref-radius-s); display: flex; align-items: center; justify-content: center;">
              <img src="images/categories/Hazard Sensor.png" style="width: 36px; height: 36px; object-fit: contain;" alt="Hazard Sensor">
            </div>

            <!-- Accessory -->
            <div class="category-tab" data-category="accessory" style="cursor: pointer; width: 56px; height: 56px; border-radius: var(--ref-radius-s); display: flex; align-items: center; justify-content: center;">
              <img src="images/categories/Accessory.png" style="width: 36px; height: 36px; object-fit: contain;" alt="Accessory">
            </div>
          </div>

          <!-- Right Product List -->
          <div style="flex: 1; overflow-y: auto; background-color: var(--bg-primary);">
            <div style="padding: var(--ref-padding-l);">
              <h2 id="categoryTitle" style="font-size: var(--font-title1); font-weight: var(--font-weight-semibold); margin-bottom: var(--ref-padding-m); color: var(--fg-primary);">Hub & Control Panel</h2>
              <div id="deviceGrid" style="display: flex; flex-direction: column; gap: var(--ref-padding-s);">
                <!-- Devices will be loaded here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Services Content -->
        <div id="servicesSubContent" class="hidden" style="flex: 1; overflow-y: auto; background-color: var(--bg-primary);">
          <div style="padding: var(--ref-padding-l);">
            <div id="servicePlans">
              <!-- Service plans will be loaded here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Product Detail View -->
      <div id="productDetailView" class="hidden" style="height: 100%; overflow-y: auto; background-color: var(--bg-primary);">
        <!-- Product detail content will be dynamically loaded -->
      </div>

      <!-- Attachment Viewer -->
      <div id="attachmentViewer" class="hidden" style="height: 100%; display: flex; flex-direction: column; background-color: var(--bg-primary);">
        <!-- Attachment viewer content will be dynamically loaded -->
      </div>

      <!-- 3D Plan Tab Content -->
      <div id="planContent" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
        <!-- Plan Home (Two Entry Cards) -->
        <div id="planHome" style="flex: 1; overflow-y: auto;">
          <div class="page-inner">
            <!-- Create New Solution Card -->
            <div class="card" onclick="startNewSolution()" style="margin-bottom: var(--ref-padding-l); cursor: pointer; padding: var(--ref-padding-xl); text-align: center; transition: all 0.2s; border: 2px solid var(--brand-fg-primary);" onmouseover="this.style.background='var(--brand-fill-tertiary)'" onmouseout="this.style.background='white'">
              <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="64" height="64" style="margin: 0 auto var(--ref-padding-m); color: #005D8E;">
                <path d="M474.112 87.893333l390.371556 205.425778 4.664888 7.68v152.632889l-10.012444-1.479111a236.600889 236.600889 0 0 0-35.100444-2.616889l-8.704-8.647111V359.822222L494.250667 528.327111v335.587556l116.451555-63.032889 11.548445 3.185778c6.087111 10.24 12.970667 19.911111 20.48 29.127111l6.712889 8.135111-175.217778 94.72H465.92l-390.371556-211.000889-4.551111-7.623111v-416.426667l4.608-7.68 390.428445-205.425778h8.078222zM124.700444 359.765333v330.296889l321.080889 173.852445v-335.644445L124.700444 359.765333z m345.429334-215.608889L150.300444 317.44 469.902222 480.028444l319.829334-167.992888-319.601778-167.822223z" fill="#005D8E"></path>
                <path d="M921.713778 695.523556h-237.624889a22.641778 22.641778 0 1 1 0-45.283556h237.624889a22.641778 22.641778 0 0 1 0 45.283556z m-118.840889 118.784a22.641778 22.641778 0 0 1-22.584889-22.641778V554.097778a22.641778 22.641778 0 0 1 45.226667 0v237.624889a22.641778 22.641778 0 0 1-22.641778 22.641777z" fill="#005D8E"></path>
                <path d="M802.872889 525.653333a28.444444 28.444444 0 0 1 28.444444 28.444445l-0.056889 90.282666 90.453334 0.056889a28.444444 28.444444 0 1 1 0 56.888889l-90.453334-0.113778v90.453334a28.444444 28.444444 0 0 1-5.347555 16.725333l-2.901333 3.413333a28.444444 28.444444 0 0 1-48.526223-20.138666v-90.453334l-90.453333 0.056889a28.444444 28.444444 0 0 1-27.875556-23.324444l-0.512-5.12a28.444444 28.444444 0 0 1 28.444445-28.387556h90.339555l0.056889-90.396444a28.444444 28.444444 0 0 1 23.324445-27.932445l5.12-0.455111z m16.896 175.616h-33.848889l0.113778 90.453334c0 7.964444 5.575111 14.620444 13.027555 16.384l3.811556 0.455111a16.839111 16.839111 0 0 0 16.896-16.896v-90.396445z m0-45.283555h-33.792v33.735111h33.792v-33.735111z m-45.340445-0.056889l-90.339555 0.056889a16.839111 16.839111 0 0 0-16.440889 13.027555l-0.398222 3.868445c0 9.272889 7.509333 16.839111 16.839111 16.839111h90.339555v-33.792z m56.888889 0v33.792h90.453334c7.964444 0 14.620444-5.518222 16.384-12.970667l0.398222-3.868444a16.839111 16.839111 0 0 0-16.839111-16.896l-90.453334-0.056889z m-28.444444-118.727111a16.839111 16.839111 0 0 0-16.839111 16.839111l-0.113778 90.339555h33.848889V554.097778a16.839111 16.839111 0 0 0-13.027556-16.384l-3.868444-0.455111z" fill="#005D8E"></path>
              </svg>
              <h3 style="font-size: var(--font-title1); font-weight: var(--font-weight-bold); color: var(--brand-fg-primary);">Create New Solution</h3>
            </div>

            <!-- View History Card -->
            <div class="card" onclick="showModelHistory()" style="cursor: pointer; padding: var(--ref-padding-xl); text-align: center; transition: all 0.2s;" onmouseover="this.style.background='var(--fill-tertiary)'" onmouseout="this.style.background='white'">
              <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="var(--fg-tertiary)" style="margin: 0 auto var(--ref-padding-m);">
                <path d="M409.709989 71.493018h204.879992v51.195001H409.709989z"></path>
                <path d="M798.871985 1024H225.327995c-70.593106 0-127.987501-57.394395-127.987501-127.987501V199.480519c0-70.593106 57.394395-127.987501 127.987501-127.987501h47.795333v51.195001h-47.795333c-42.39586 0-76.792501 34.496631-76.7925 76.7925V895.912509c0 42.39586 34.496631 76.792501 76.7925 76.7925h573.54399c42.39586 0 76.792501-34.496631 76.792501-76.7925V199.480519c0-42.39586-34.496631-76.792501-76.792501-76.7925h-47.795332V71.493018h47.795332c70.593106 0 127.987501 57.394395 127.987501 127.987501V895.912509c0.09999 70.693096-57.394395 128.087491-127.987501 128.087491z"></path>
                <path d="M317.319012 0.09999h51.195v184.381994h-51.195zM657.785763 0.09999H708.980764v184.381994h-51.195001zM268.623767 319.368812h480.553071v51.195H268.623767zM268.623767 522.44898h480.553071v51.195H268.623767zM268.623767 729.828728h316.669075v51.195H268.623767z"></path>
              </svg>
              <h3 style="font-size: var(--font-title1); font-weight: var(--font-weight-bold); color: var(--fg-primary);">Solution History</h3>
            </div>
          </div>
        </div>

        <!-- Step 1: House Model Generation -->
        <div id="planStep1" class="hidden" style="flex: 1; overflow-y: auto;">
          <div class="page-inner">
            <!-- Google Map Container (16:9 ratio) -->
            <div class="card" style="margin-bottom: var(--ref-padding-m);">
              <label class="form-label form-label-required" style="font-size: var(--font-body); font-weight: var(--font-weight-semibold); color: var(--fg-primary); margin-bottom: var(--ref-padding-m); display: block;">House Location</label>

              <!-- Address Input -->
              <div class="form-group" style="margin-bottom: var(--ref-padding-m);">
                <input type="text" id="houseAddress" class="form-input" placeholder="Enter house address">
              </div>

              <!-- Map (16:9 aspect ratio) -->
              <div style="width: 100%; padding-bottom: 56.25%; position: relative; border-radius: var(--comp-card-radius); overflow: hidden;">
                <div id="googleMap" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
              </div>
            </div>

            <!-- Floor Selection -->
            <div class="card" style="margin-bottom: var(--ref-padding-m);">
              <h4 style="font-size: var(--font-body); font-weight: var(--font-weight-semibold); color: var(--fg-primary); margin-bottom: var(--ref-padding-m);">Number of Floors</h4>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--ref-padding-s);">
                <label class="floor-option" style="padding: var(--ref-padding-s); background: var(--bg-tertiary); border: 2px solid transparent; border-radius: var(--comp-card-radius); text-align: center; cursor: pointer; transition: all 0.2s;">
                  <input type="radio" name="floors" value="1" checked style="display: none;">
                  <div class="floor-number" style="font-size: var(--font-display1); font-weight: var(--font-weight-regular); color: var(--fg-tertiary); transition: all 0.2s;">1</div>
                </label>
                <label class="floor-option" style="padding: var(--ref-padding-s); background: var(--bg-tertiary); border: 2px solid transparent; border-radius: var(--comp-card-radius); text-align: center; cursor: pointer; transition: all 0.2s;">
                  <input type="radio" name="floors" value="2" style="display: none;">
                  <div class="floor-number" style="font-size: var(--font-display1); font-weight: var(--font-weight-regular); color: var(--fg-tertiary); transition: all 0.2s;">2</div>
                </label>
                <label class="floor-option" style="padding: var(--ref-padding-s); background: var(--bg-tertiary); border: 2px solid transparent; border-radius: var(--comp-card-radius); text-align: center; cursor: pointer; transition: all 0.2s;">
                  <input type="radio" name="floors" value="3" style="display: none;">
                  <div class="floor-number" style="font-size: var(--font-display1); font-weight: var(--font-weight-regular); color: var(--fg-tertiary); transition: all 0.2s;">3</div>
                </label>
                <label class="floor-option" style="padding: var(--ref-padding-s); background: var(--bg-tertiary); border: 2px solid transparent; border-radius: var(--comp-card-radius); text-align: center; cursor: pointer; transition: all 0.2s;">
                  <input type="radio" name="floors" value="4" style="display: none;">
                  <div class="floor-number" style="font-size: var(--font-display1); font-weight: var(--font-weight-regular); color: var(--fg-tertiary); transition: all 0.2s;">4</div>
                </label>
              </div>
            </div>

            <!-- House Photos Upload -->
            <div class="card" style="margin-bottom: var(--ref-padding-m);">
              <label class="form-label form-label-required" style="font-size: var(--font-body); font-weight: var(--font-weight-semibold); color: var(--fg-primary); margin-bottom: var(--ref-padding-m); display: block;">House Photos</label>

              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--ref-padding-m);">
                <!-- Front Photo -->
                <div class="photo-upload-box" data-side="front">
                  <input type="file" id="photoFront" accept="image/*" style="display: none;">
                  <label for="photoFront" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px; padding: var(--ref-padding-m); background: var(--bg-tertiary); border: 2px dashed var(--fill-secondary); border-radius: var(--comp-card-radius); cursor: pointer; transition: all 0.2s;">
                    <div class="photo-preview-img" style="display: none; width: 100%; margin-bottom: var(--ref-padding-s);"></div>
                    <svg class="photo-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--fg-tertiary)" stroke-width="2" style="margin-bottom: var(--ref-padding-s);">
                      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                      <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    <div style="font-size: var(--font-caption2); font-weight: var(--font-weight-semibold); color: var(--fg-primary);">Front</div>
                  </label>
                </div>

                <!-- Back Photo -->
                <div class="photo-upload-box" data-side="back">
                  <input type="file" id="photoBack" accept="image/*" style="display: none;">
                  <label for="photoBack" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px; padding: var(--ref-padding-m); background: var(--bg-tertiary); border: 2px dashed var(--fill-secondary); border-radius: var(--comp-card-radius); cursor: pointer; transition: all 0.2s;">
                    <div class="photo-preview-img" style="display: none; width: 100%; margin-bottom: var(--ref-padding-s);"></div>
                    <svg class="photo-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--fg-tertiary)" stroke-width="2" style="margin-bottom: var(--ref-padding-s);">
                      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                      <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    <div style="font-size: var(--font-caption2); font-weight: var(--font-weight-semibold); color: var(--fg-primary);">Back</div>
                  </label>
                </div>

                <!-- Left Photo -->
                <div class="photo-upload-box" data-side="left">
                  <input type="file" id="photoLeft" accept="image/*" style="display: none;">
                  <label for="photoLeft" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px; padding: var(--ref-padding-m); background: var(--bg-tertiary); border: 2px dashed var(--fill-secondary); border-radius: var(--comp-card-radius); cursor: pointer; transition: all 0.2s;">
                    <div class="photo-preview-img" style="display: none; width: 100%; margin-bottom: var(--ref-padding-s);"></div>
                    <svg class="photo-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--fg-tertiary)" stroke-width="2" style="margin-bottom: var(--ref-padding-s);">
                      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                      <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    <div style="font-size: var(--font-caption2); font-weight: var(--font-weight-semibold); color: var(--fg-primary);">Left</div>
                  </label>
                </div>

                <!-- Right Photo -->
                <div class="photo-upload-box" data-side="right">
                  <input type="file" id="photoRight" accept="image/*" style="display: none;">
                  <label for="photoRight" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px; padding: var(--ref-padding-m); background: var(--bg-tertiary); border: 2px dashed var(--fill-secondary); border-radius: var(--comp-card-radius); cursor: pointer; transition: all 0.2s;">
                    <div class="photo-preview-img" style="display: none; width: 100%; margin-bottom: var(--ref-padding-s);"></div>
                    <svg class="photo-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--fg-tertiary)" stroke-width="2" style="margin-bottom: var(--ref-padding-s);">
                      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                      <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    <div style="font-size: var(--font-caption2); font-weight: var(--font-weight-semibold); color: var(--fg-primary);">Right</div>
                  </label>
                </div>
              </div>
            </div>

            <!-- User Account -->
            <div class="card" style="margin-bottom: var(--ref-padding-m);">
              <div class="form-group">
                <label class="form-label form-label-required">User Account</label>
                <input type="email" id="userEmail" class="form-input" placeholder="user@example.com">
              </div>
            </div>

            <!-- Generate Model Button -->
            <button id="generateModelBtn" class="btn btn-primary" style="width: 100%;" onclick="generateHouseModel()">
              Generate Model
            </button>
          </div>
        </div>

        <!-- Step 2: Solution Generation -->
        <div id="planStep2" class="hidden" style="flex: 1; overflow-y: auto;">
          <div class="page-inner">

            <!-- 3D Model Viewer (1:1 ratio) -->
            <div style="margin-bottom: var(--ref-padding-m);">
              <div id="threeContainer" style="width: 100%; padding-bottom: 100%; position: relative; border-radius: var(--comp-card-radius); overflow: hidden; background: #E0EDF4;">
              </div>
            </div>

            <!-- Device Selection -->
            <div class="card" style="margin-bottom: var(--ref-padding-m);">
              <h4 style="font-size: var(--font-body); font-weight: var(--font-weight-semibold); color: var(--fg-primary); margin-bottom: var(--ref-padding-xs);">Add Installed Devices</h4>
              <p style="font-size: var(--font-caption2); color: var(--fg-tertiary); margin-bottom: var(--ref-padding-m);">Drag devices onto the house model to place them</p>

              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--ref-padding-m);">
                <!-- Camera Device -->
                <div class="device-card" draggable="true" data-device-type="camera" style="padding: var(--ref-padding-m); background: var(--bg-tertiary); border-radius: var(--comp-card-radius); text-align: center; cursor: move; transition: all 0.2s;">
                  <div style="width: 48px; height: 48px; background: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto var(--ref-padding-s);">
                    <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="var(--brand-fg-primary)">
                      <path d="M918.3 655.3c-8.7-15.1-28-20.3-43.1-11.5L672.8 760.6 167.6 421c-14.5-9.7-34-5.9-43.8 8.6-9.7 14.5-5.9 34 8.6 43.8l182.7 122.8-57.6 80.6h-91V563c0-17.4-14.1-31.5-31.5-31.5s-31.5 14.1-31.5 31.5v333.5c0 17.4 14.1 31.5 31.5 31.5s31.5-14.1 31.5-31.5V739.8h124v-0.1l76-109.1 287.4 193.2c0.1 0.1 0.3 0.2 0.4 0.2 0.6 0.4 1.3 0.8 2 1.2 0.2 0.1 0.4 0.2 0.7 0.4 0.8 0.4 1.5 0.8 2.3 1.1 0.2 0.1 0.3 0.1 0.5 0.2 0.9 0.4 1.8 0.7 2.7 1h0.1c8 2.4 17 1.7 24.8-2.9l219.5-126.7c15-8.6 20.1-27.9 11.4-43z"></path>
                      <path d="M129.3 320.5L650.6 671c4.7 3.1 9.8 4.8 15.1 5.2 7.5 1.3 15.5-0.1 22.5-4.5l219.1-141.2c14.6-9.4 18.9-28.9 9.4-43.6l-0.1-0.1c-2.3-3.8-5.4-7.2-9.3-9.8L353.2 104.5c-11.3-8.4-27.1-8.4-38.5 0.7-0.1 0-0.1 0.1-0.2 0.1-0.3 0.3-0.6 0.5-0.9 0.7L126.9 269.6c-1.6 1.4-3 2.9-4.2 4.5l-0.1 0.1-0.1 0.1-1.8 2.4c-9.7 14.5-5.9 34.1 8.6 43.8z m207.5-150.9l496.4 333.7-162.9 105-472-317.3 138.5-121.4z"></path>
                    </svg>
                  </div>
                  <div style="font-size: var(--font-caption2); font-weight: var(--font-weight-semibold); color: var(--fg-primary);">Camera</div>
                </div>

                <!-- Doorbell Device -->
                <div class="device-card" draggable="true" data-device-type="doorbell" style="padding: var(--ref-padding-m); background: var(--bg-tertiary); border-radius: var(--comp-card-radius); text-align: center; cursor: move; transition: all 0.2s;">
                  <div style="width: 48px; height: 48px; background: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto var(--ref-padding-s);">
                    <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="var(--brand-fg-primary)">
                      <path d="M512 445.3c73.68 0 133.4-59.73 133.4-133.4S585.67 178.5 512 178.5s-133.4 59.73-133.4 133.4S438.32 445.3 512 445.3z m0-29.65c-57.3 0-103.76-46.45-103.76-103.76S454.7 208.14 512 208.14s103.76 46.45 103.76 103.76S569.3 415.65 512 415.65z"></path>
                      <path d="M512 378.6c36.84 0 66.7-29.86 66.7-66.7s-29.86-66.7-66.7-66.7-66.7 29.86-66.7 66.7 29.86 66.7 66.7 66.7z m0-14.83c-28.65 0-51.88-23.23-51.88-51.88 0-28.65 23.23-51.88 51.88-51.88 28.65 0 51.88 23.23 51.88 51.88 0 28.66-23.23 51.88-51.88 51.88zM504.59 667.64c0 4.09 3.32 7.41 7.41 7.41s7.41-3.32 7.41-7.41-3.32-7.41-7.41-7.41-7.41 3.31-7.41 7.41zM452.71 801.04c0 32.75 26.55 59.29 59.29 59.29s59.29-26.55 59.29-59.29c0-32.75-26.55-59.29-59.29-59.29s-59.29 26.55-59.29 59.29z"></path>
                      <path d="M319.31 96.97H704.7c32.75 0 59.29 26.55 59.29 59.29v711.49c0 32.75-26.55 59.29-59.29 59.29H319.31c-32.75 0-59.29-26.55-59.29-59.29V156.26c0-32.75 26.54-59.29 59.29-59.29z m0 44.46c-8.19 0-14.82 6.64-14.82 14.82v711.49c0 8.19 6.64 14.82 14.82 14.82H704.7c8.19 0 14.82-6.64 14.82-14.82V156.26c0-8.19-6.64-14.82-14.82-14.82H319.31z"></path>
                    </svg>
                  </div>
                  <div style="font-size: var(--font-caption2); font-weight: var(--font-weight-semibold); color: var(--fg-primary);">Doorbell</div>
                </div>
              </div>
            </div>

            <!-- Placed Devices List -->
            <div class="card" style="margin-bottom: var(--ref-padding-m);">
              <h4 style="font-size: var(--font-body); font-weight: var(--font-weight-semibold); color: var(--fg-primary); margin-bottom: var(--ref-padding-m);">Placed Devices</h4>
              <div id="placedDevicesList" style="min-height: 60px;">
                <div style="text-align: center; padding: var(--ref-padding-l) 0; color: var(--fg-tertiary);">
                  <div style="font-size: var(--font-caption2);">No devices placed yet</div>
                </div>
              </div>
            </div>

            <!-- Generate Solution Button -->
            <button id="generateSolutionBtn" class="btn btn-primary" style="width: 100%;" onclick="generateSolution()">
              Generate Solution
            </button>
          </div>
        </div>

        <!-- Step 3: View Solution -->
        <div id="planStep3" class="hidden" style="flex: 1; overflow-y: auto;">
          <div class="page-inner">

            <!-- 3D Model Viewer with Plan Devices -->
            <div style="margin-bottom: var(--ref-padding-m);">
              <div id="solutionThreeContainer" style="width: 100%; padding-bottom: 100%; position: relative; border-radius: var(--comp-card-radius); overflow: hidden; background: #E0EDF4;">
              </div>
            </div>

            <!-- Plan Selection -->
            <div style="margin-bottom: var(--ref-padding-m);">
              <h4 style="font-size: var(--font-body); font-weight: var(--font-weight-semibold); color: var(--fg-primary); margin-bottom: var(--ref-padding-m);">Recommended Plans</h4>

              <!-- Horizontal Scroll Container -->
              <div id="planCardsContainer" style="display: flex; gap: var(--ref-padding-m); overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: var(--ref-padding-s); scroll-snap-type: x mandatory;">
              </div>
            </div>

            <!-- Send Solution Button -->
            <button id="sendSolutionBtn" class="btn btn-primary" style="width: 100%;" onclick="confirmSendSolution()">
              Send to User
            </button>
          </div>
        </div>
      </div>

      <!-- Model History View (Secondary Page) -->
      <div id="modelHistoryView" class="hidden" style="height: 100%; display: flex; flex-direction: column; background-color: var(--bg-primary);">
        <!-- Search Bar -->
        <div style="padding: var(--ref-padding-m); background: var(--bg-secondary); border-bottom: 1px solid var(--fill-secondary);">
          <input type="text" id="modelHistorySearch" class="form-input" placeholder="Search by user account" oninput="filterModelHistory()">
        </div>

        <!-- Model List -->
        <div id="modelHistoryList" style="flex: 1; overflow-y: auto; padding: var(--ref-padding-m);">
          <!-- Model cards will be rendered here -->
        </div>
      </div>

      <!-- Register Tab Content - Device Registration (Reused) -->
      <!-- Register Tab Content -->
      <div id="registerContent" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
        <!-- Device Registration Sub Content -->
        <div id="deviceRegSubContent" style="flex: 1; overflow-y: auto;">
          <div class="page-inner">
            <form id="deviceRegistrationForm" onsubmit="submitDeviceRegistration(event)">
              <div class="form-group">
                <label class="form-label form-label-required" style="text-align: left;">Device SN</label>
                <div style="display: flex; gap: var(--spacing-sm);">
                  <input type="text" class="form-input" id="deviceSN" placeholder="16-digit code" style="flex: 1;">
                  <button type="button" class="btn btn-secondary" style="width: auto; padding: 0 var(--spacing-md);" onclick="scanDeviceSN()">
                    <svg width="20" height="20" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
                      <path d="M928 544 96 544c-17.664 0-32-14.336-32-32s14.336-32 32-32l832 0c17.696 0 32 14.336 32 32S945.696 544 928 544zM832 928l-192 0c-17.696 0-32-14.304-32-32s14.304-32 32-32l192 0c17.664 0 32-14.336 32-32l0-160c0-17.696 14.304-32 32-32s32 14.304 32 32l0 160C928 884.928 884.928 928 832 928zM352 928 192 928c-52.928 0-96-43.072-96-96l0-160c0-17.696 14.336-32 32-32s32 14.304 32 32l0 160c0 17.664 14.368 32 32 32l160 0c17.664 0 32 14.304 32 32S369.664 928 352 928zM128 384c-17.664 0-32-14.336-32-32L96 192c0-52.928 43.072-96 96-96l160 0c17.664 0 32 14.336 32 32s-14.336 32-32 32L192 160C174.368 160 160 174.368 160 192l0 160C160 369.664 145.664 384 128 384zM896 384c-17.696 0-32-14.336-32-32L864 192c0-17.632-14.336-32-32-32l-192 0c-17.696 0-32-14.336-32-32s14.304-32 32-32l192 0c52.928 0 96 43.072 96 96l0 160C928 369.664 913.696 384 896 384z" fill="currentColor"></path>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label form-label-required" style="text-align: left;">User Account</label>
                <input type="email" class="form-input" id="userAccount" placeholder="user@example.com">
              </div>

              <button type="submit" class="btn btn-primary" style="margin-top: var(--spacing-lg);">Submit Registration</button>
            </form>
          </div>
        </div>

        <!-- Service Subscription Sub Content -->
        <div id="serviceSubSubContent" class="hidden" style="flex: 1; overflow-y: auto;">
          <div class="page-inner">
            <form id="serviceSubscriptionForm" onsubmit="submitServiceSubscription(event)">
              <div class="form-group">
                <label class="form-label form-label-required" style="text-align: left;">Service Plan</label>
                <select class="form-input" id="servicePlan">
                  <option value="basic" selected>Basic Plan</option>
                  <option value="plus">Plus Plan</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label form-label-required" style="text-align: left;">Device SN</label>
                <div style="display: flex; gap: var(--spacing-sm);">
                  <input type="text" class="form-input" id="serviceDeviceSN" placeholder="16-digit code" style="flex: 1;">
                  <button type="button" class="btn btn-secondary" style="width: auto; padding: 0 var(--spacing-md);" onclick="scanServiceDeviceSN()">
                    <svg width="20" height="20" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
                      <path d="M928 544 96 544c-17.664 0-32-14.336-32-32s14.336-32 32-32l832 0c17.696 0 32 14.336 32 32S945.696 544 928 544zM832 928l-192 0c-17.696 0-32-14.304-32-32s14.304-32 32-32l192 0c17.664 0 32-14.336 32-32l0-160c0-17.696 14.304-32 32-32s32 14.304 32 32l0 160C928 884.928 884.928 928 832 928zM352 928 192 928c-52.928 0-96-43.072-96-96l0-160c0-17.696 14.336-32 32-32s32 14.304 32 32l0 160c0 17.664 14.368 32 32 32l160 0c17.664 0 32 14.304 32 32S369.664 928 352 928zM128 384c-17.664 0-32-14.336-32-32L96 192c0-52.928 43.072-96 96-96l160 0c17.664 0 32 14.336 32 32s-14.336 32-32 32L192 160C174.368 160 160 174.368 160 192l0 160C160 369.664 145.664 384 128 384zM896 384c-17.696 0-32-14.336-32-32L864 192c0-17.632-14.336-32-32-32l-192 0c-17.696 0-32-14.336-32-32s14.304-32 32-32l192 0c52.928 0 96 43.072 96 96l0 160C928 369.664 913.696 384 896 384z" fill="currentColor"></path>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label form-label-required" style="text-align: left;">User Account</label>
                <input type="email" class="form-input" id="serviceUserAccount" placeholder="user@example.com">
              </div>

              <button type="submit" class="btn btn-primary" style="margin-top: var(--spacing-lg);">Submit Subscription</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Subscription Management Page (accessed from Home) -->
      <div id="subscriptionManagement" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
        <!-- Fixed Search Bar and Filter -->
        <div style="background-color: var(--bg-secondary); border-bottom: 0.33px solid var(--fill-secondary);">
          <div style="padding: var(--ref-padding-m) var(--ref-padding-l) 0;">
            <input type="text" class="form-input" id="subscriptionSearch" placeholder="Search by Account or Device SN" oninput="applySubscriptionFilters()" style="height: 36px;">
          </div>

          <!-- Status Filter Chips -->
          <div style="display: flex; gap: var(--spacing-xs); overflow-x: auto; padding: var(--spacing-sm) var(--ref-padding-l); -webkit-overflow-scrolling: touch;">
            <button class="filter-chip active" data-status="all" onclick="filterBySubscriptionStatus('all')">All</button>
            <button class="filter-chip" data-status="To be Activated" onclick="filterBySubscriptionStatus('To be Activated')">To be Activated</button>
            <button class="filter-chip" data-status="Active" onclick="filterBySubscriptionStatus('Active')">Active</button>
            <button class="filter-chip" data-status="Grace Period" onclick="filterBySubscriptionStatus('Grace Period')">Grace Period</button>
            <button class="filter-chip" data-status="Overdue" onclick="filterBySubscriptionStatus('Overdue')">Overdue</button>
            <button class="filter-chip" data-status="Canceled" onclick="filterBySubscriptionStatus('Canceled')">Canceled</button>
            <button class="filter-chip" data-status="Payment Error" onclick="filterBySubscriptionStatus('Payment Error')">Payment Error</button>
            <button class="filter-chip" data-status="Trial" onclick="filterBySubscriptionStatus('Trial')">Trial</button>
          </div>
        </div>

        <!-- Scrollable Subscription List -->
        <div style="flex: 1; overflow-y: auto; background-color: var(--bg-primary);">
          <div style="padding: var(--ref-padding-l);">
            <div id="subscriptionList">
              <!-- Subscriptions will be loaded here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Maintenance Detail Page (Not a tab, accessed from Home) -->
      <div id="maintenanceDetail" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
        <!-- Fixed Search Bar and Filter -->
        <div style="background-color: var(--bg-secondary); border-bottom: 0.33px solid var(--fill-secondary);">
          <div style="padding: var(--ref-padding-m) var(--ref-padding-l) 0;">
            <input type="text" class="form-input" id="maintenanceSearch" placeholder="Search by Device SN or Account" style="height: 36px;">
          </div>

          <!-- Status Filter Chips -->
          <div style="display: flex; gap: var(--spacing-xs); overflow-x: auto; padding: var(--spacing-sm) var(--ref-padding-l); -webkit-overflow-scrolling: touch;">
            <button class="filter-chip active" data-status="all" onclick="filterByStatus('all')">All</button>
            <button class="filter-chip" data-status="Online" onclick="filterByStatus('Online')">Online</button>
            <button class="filter-chip" data-status="Offline" onclick="filterByStatus('Offline')">Offline</button>
            <button class="filter-chip" data-status="Manual Offline" onclick="filterByStatus('Manual Offline')">Manual Offline</button>
            <button class="filter-chip" data-status="Low Battery Offline" onclick="filterByStatus('Low Battery Offline')">Low Battery Offline</button>
          </div>
        </div>

        <!-- Scrollable Device List -->
        <div id="maintenanceDeviceList" style="flex: 1; padding: var(--ref-padding-l); overflow-y: auto; background-color: var(--bg-primary);">
          <!-- Dynamic device cards -->
        </div>
      </div>

      <!-- Profile Tab Content -->
      <div id="profileContent" class="hidden">
        <div id="profileMainView" class="page-inner">
          <!-- User Info Card -->
          <div style="background-color: var(--color-bg-primary); border-radius: var(--border-radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-md);">
            <div style="width: 56px; height: 56px; border-radius: 50%; overflow: hidden; flex-shrink: 0;">
              <svg width="56" height="56" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
                <path d="M512 512m-512 0a512 512 0 1 0 1024 0 512 512 0 1 0-1024 0Z" fill="#80AFFF"></path>
                <path d="M493.226667 1023.431111V0.568889C499.484444 0 505.742222 0 512 0c282.737778 0 512 229.262222 512 512s-229.262222 512-512 512c-6.257778 0-12.515556 0-18.773333-0.568889z" fill="#6EA3FF"></path>
                <path d="M150.186667 874.382222c69.404444-149.048889 207.644444-250.88 366.364444-250.88 156.444444 0 292.977778 98.417778 363.52 244.053334-93.297778 96.711111-223.573333 156.444444-368.071111 156.444444-141.084444 0-269.084444-57.457778-361.813333-149.617778z" fill="#D1E1FF"></path>
                <path d="M497.777778 423.822222m-172.373334 0a172.373333 172.373333 0 1 0 344.746667 0 172.373333 172.373333 0 1 0-344.746667 0Z" fill="#DAE7FF"></path>
                <path d="M494.933333 595.626667V251.448889h2.844445c95.004444 0 172.373333 77.368889 172.373333 172.373333s-77.368889 172.373333-172.373333 172.373334c-0.568889-0.568889-1.706667-0.568889-2.844445-0.568889z" fill="#C1D8FF"></path>
                <path d="M489.244444 1024v-399.36c7.395556-0.568889 14.222222-0.568889 21.617778-0.568889 156.444444 0 292.977778 98.417778 363.52 244.053333C781.084444 964.266667 650.808889 1024 506.311111 1024h-17.066667z" fill="#C1D8FF"></path>
              </svg>
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: var(--font-body); font-weight: var(--font-weight-semibold); color: var(--fg-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" id="userEmail">installer@example.com</div>
            </div>
          </div>

          <!-- Settings List -->
          <div style="background-color: var(--color-bg-primary); border-radius: var(--border-radius-md); overflow: hidden; margin-bottom: var(--spacing-md);">
            <div class="list-item" onclick="showPaymentAccount()">
              <div class="list-item-content">
                <div class="list-item-title">Payment Account</div>
                <div class="list-item-subtitle">Manage your payment methods</div>
              </div>
              <div class="list-item-arrow">›</div>
            </div>
            <div class="list-item" onclick="showBillingHistory()">
              <div class="list-item-content">
                <div class="list-item-title">Billing History</div>
                <div class="list-item-subtitle">View invoices and statements</div>
              </div>
              <div class="list-item-arrow">›</div>
            </div>
            <div class="list-item" onclick="showSystemUpdate()">
              <div class="list-item-content">
                <div class="list-item-title">System Version</div>
                <div class="list-item-subtitle" id="currentVersion">v1.0.0</div>
              </div>
              <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                <div id="updateBadge" class="hidden" style="width: 8px; height: 8px; background-color: var(--color-danger); border-radius: 50%;"></div>
                <div class="list-item-arrow">›</div>
              </div>
            </div>
          </div>

          <button class="btn btn-danger" onclick="logout()" style="margin-top: var(--spacing-md);">Logout</button>
        </div>

        <!-- System Update View -->
        <div id="systemUpdateView" class="hidden" style="height: 100%; overflow-y: auto; background-color: var(--bg-primary);">
          <div style="padding: var(--ref-padding-l);">
            <div style="text-align: center; margin-bottom: var(--ref-padding-l);">
              <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="var(--brand-fg-primary)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 16V8"></path>
                <path d="M8 12l4-4 4 4"></path>
              </svg>
            </div>

            <div style="text-align: center; margin-bottom: var(--ref-padding-l);">
              <h2 style="font-size: var(--font-display1); font-weight: var(--font-weight-bold); color: var(--fg-primary); margin-bottom: var(--ref-padding-xs);">System Update Available</h2>
              <p style="font-size: var(--font-body); color: var(--fg-secondary);">Version <span id="latestVersion">v1.2.0</span></p>
            </div>

            <div style="background-color: var(--bg-secondary); border-radius: var(--comp-card-radius); padding: var(--ref-padding-m); margin-bottom: var(--ref-padding-m);">
              <div style="font-size: var(--font-caption2); color: var(--fg-secondary); margin-bottom: var(--ref-padding-xs);">Current Version</div>
              <div style="font-size: var(--font-body); color: var(--fg-primary);" id="currentVersionDetail">v1.0.0</div>
            </div>

            <div style="background-color: var(--bg-secondary); border-radius: var(--comp-card-radius); padding: var(--ref-padding-m); margin-bottom: var(--ref-padding-l);">
              <h3 style="font-size: var(--font-title1); font-weight: var(--font-weight-semibold); color: var(--fg-primary); margin-bottom: var(--ref-padding-m);">What's New</h3>
              <ul id="changelogList" style="margin: 0; padding-left: var(--ref-padding-l); color: var(--fg-secondary); line-height: 1.6;">
                <li style="margin-bottom: var(--ref-padding-s);">Enhanced device registration with improved photo upload</li>
                <li style="margin-bottom: var(--ref-padding-s);">New maintenance search functionality</li>
                <li style="margin-bottom: var(--ref-padding-s);">Performance improvements and bug fixes</li>
                <li style="margin-bottom: var(--ref-padding-s);">Updated service management interface</li>
              </ul>
            </div>

            <button class="btn btn-primary" onclick="performSystemUpdate()" style="margin-bottom: var(--ref-padding-m);">Update Now</button>
            <button class="btn btn-secondary" onclick="hideSystemUpdate()">Later</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Tabbar -->
    <div class="bottom-tabbar">
      <a href="#" class="tab-item active" data-tab="home">
        <div class="tab-icon">
          <svg width="24" height="24" viewBox="0 0 1024 1024" fill="currentColor">
            <path d="M762.77551 929.959184H261.22449c-40.75102 0-74.187755-33.436735-74.187755-74.710204v-288.914286c0-6.791837-5.22449-12.016327-11.493878-12.016327h-27.689796c-21.942857 0-40.75102-12.538776-49.110204-32.914285-8.359184-19.853061-3.657143-42.840816 11.493878-58.514286l341.159183-343.771429c15.673469-16.195918 37.616327-25.077551 60.604082-25.077551s44.930612 8.881633 61.126531 25.6L914.285714 463.412245c15.15102 15.673469 19.853061 38.661224 11.493878 58.514286-8.359184 20.37551-27.167347 32.914286-49.110204 32.914285h-27.689796c-6.269388 0-11.493878 5.22449-11.493878 12.016327v288.914286c-0.522449 40.75102-33.959184 74.187755-74.710204 74.187755zM512 135.836735c-12.016327 0-22.987755 4.702041-31.346939 13.061224L139.493878 492.669388c-5.22449 5.22449-3.657143 10.971429-2.612245 13.061224 1.044898 2.089796 3.657143 7.314286 10.971428 7.314286h27.689796c29.257143 0 53.289796 24.032653 53.289796 53.812245v288.914286c0 17.763265 14.628571 32.914286 32.391837 32.914285h501.55102c17.763265 0 32.391837-14.628571 32.391837-32.914285v-288.914286c0-29.779592 24.032653-53.812245 53.289796-53.812245h27.689796c6.791837 0 9.926531-5.22449 10.971428-7.314286 1.044898-2.089796 2.612245-7.836735-2.612245-13.061224L543.346939 148.897959c-8.359184-8.359184-19.330612-13.061224-31.346939-13.061224z"></path>
            <path d="M663.510204 929.959184H360.489796v-219.428572c0-45.97551 37.616327-83.591837 83.591837-83.591836h135.836734c45.97551 0 83.591837 37.616327 83.591837 83.591836v219.428572z m-261.22449-41.795919h219.428572v-177.632653c0-22.987755-18.808163-41.795918-41.795919-41.795918H444.081633c-22.987755 0-41.795918 18.808163-41.795919 41.795918v177.632653z"></path>
          </svg>
        </div>
        <div class="tab-label">Home</div>
      </a>
      <a href="#" class="tab-item" data-tab="products">
        <div class="tab-icon">
          <svg width="24" height="24" viewBox="0 0 1024 1024" fill="currentColor">
            <path d="M918.3 655.3c-8.7-15.1-28-20.3-43.1-11.5L672.8 760.6 167.6 421c-14.5-9.7-34-5.9-43.8 8.6-9.7 14.5-5.9 34 8.6 43.8l182.7 122.8-57.6 80.6h-91V563c0-17.4-14.1-31.5-31.5-31.5s-31.5 14.1-31.5 31.5v333.5c0 17.4 14.1 31.5 31.5 31.5s31.5-14.1 31.5-31.5V739.8h124v-0.1l76-109.1 287.4 193.2c0.1 0.1 0.3 0.2 0.4 0.2 0.6 0.4 1.3 0.8 2 1.2 0.2 0.1 0.4 0.2 0.7 0.4 0.8 0.4 1.5 0.8 2.3 1.1 0.2 0.1 0.3 0.1 0.5 0.2 0.9 0.4 1.8 0.7 2.7 1h0.1c8 2.4 17 1.7 24.8-2.9l219.5-126.7c15-8.6 20.1-27.9 11.4-43z"></path>
            <path d="M129.3 320.5L650.6 671c4.7 3.1 9.8 4.8 15.1 5.2 7.5 1.3 15.5-0.1 22.5-4.5l219.1-141.2c14.6-9.4 18.9-28.9 9.4-43.6l-0.1-0.1c-2.3-3.8-5.4-7.2-9.3-9.8L353.2 104.5c-11.3-8.4-27.1-8.4-38.5 0.7-0.1 0-0.1 0.1-0.2 0.1-0.3 0.3-0.6 0.5-0.9 0.7L126.9 269.6c-1.6 1.4-3 2.9-4.2 4.5l-0.1 0.1-0.1 0.1-1.8 2.4c-9.7 14.5-5.9 34.1 8.6 43.8z m207.5-150.9l496.4 333.7-162.9 105-472-317.3 138.5-121.4z"></path>
          </svg>
        </div>
        <div class="tab-label">Products</div>
      </a>
      <a href="#" class="tab-item" data-tab="plan">
        <div class="tab-icon">
          <svg width="24" height="24" viewBox="0 0 1024 1024" fill="currentColor">
            <path d="M864.757183 264.990257l-319.895751-191.573154c-10.116405-6.057973-21.48943-9.086959-32.861432-9.086959a63.915705 63.915705 0 0 0-32.861432 9.086959l-319.895751 191.573154a63.961754 63.961754 0 0 0-31.099298 54.873771v390.954133a63.960731 63.960731 0 0 0 31.980365 55.391565l319.895751 184.692442c9.894348 5.713119 20.937868 8.569166 31.980365 8.569166s22.086018-2.856048 31.980365-8.569166l319.895751-184.692442a63.959707 63.959707 0 0 0 31.980365-55.391565v-390.954133a63.959707 63.959707 0 0 0-31.099298-54.873771zM512 128.289851l288.778032 172.937725-289.062511 173.228343-288.603047-173.161828 288.887526-173.00424z m-319.895751 228.989322l287.621697 172.573427v347.022575L192.104249 710.817138V357.279173zM543.686676 877.214912V529.862833l288.209075-172.71669v353.670995L543.686676 877.214912z"></path>
          </svg>
        </div>
        <div class="tab-label">3D Plan</div>
      </a>
      <a href="#" class="tab-item" data-tab="register">
        <div class="tab-icon">
          <svg width="24" height="24" viewBox="0 0 1024 1024" fill="currentColor">
            <path d="M928.016126 543.908618 95.983874 543.908618c-17.717453 0-31.994625-14.277171-31.994625-31.994625S78.26642 479.919368 95.983874 479.919368l832.032253 0c17.717453 0 31.994625 14.277171 31.994625 31.994625S945.73358 543.908618 928.016126 543.908618z"></path>
            <path d="M832.032253 928.016126 639.892491 928.016126c-17.717453 0-31.994625-14.277171-31.994625-31.994625s14.277171-31.994625 31.994625-31.994625l191.967747 0c17.717453 0 31.994625-14.277171 31.994625-31.994625l0-159.973123c0-17.717453 14.277171-31.994625 31.994625-31.994625s31.994625 14.277171 31.994625 31.994625l0 159.973123C928.016126 884.840585 884.840585 928.016126 832.032253 928.016126z"></path>
            <path d="M351.94087 928.016126l-159.973123 0c-52.980346 0-95.983874-43.003528-95.983874-95.983874l0-159.973123c0-17.717453 14.277171-31.994625 31.994625-31.994625S159.973123 654.341676 159.973123 672.05913l0 159.973123c0 17.717453 14.449185 31.994625 31.994625 31.994625l159.973123 0c17.717453 0 31.994625 14.277171 31.994625 31.994625C383.935495 913.738955 369.658324 928.016126 351.94087 928.016126z"></path>
            <path d="M127.978498 383.935495c-17.717453 0-31.994625-14.277171-31.994625-31.994625l0-159.973123c0-52.980346 43.003528-95.983874 95.983874-95.983874l159.973123 0c17.717453 0 31.994625 14.277171 31.994625 31.994625S369.658324 159.973123 351.94087 159.973123l-159.973123 0c-17.545439 0-31.994625 14.449185-31.994625 31.994625l0 159.973123C159.973123 369.658324 145.695952 383.935495 127.978498 383.935495z"></path>
            <path d="M896.021502 383.935495c-17.717453 0-31.994625-14.277171-31.994625-31.994625l0-159.973123c0-17.545439-14.277171-31.994625-31.994625-31.994625L639.892491 159.973123c-17.717453 0-31.994625-14.277171-31.994625-31.994625s14.277171-31.994625 31.994625-31.994625l191.967747 0c52.980346 0 95.983874 43.003528 95.983874 95.983874l0 159.973123C928.016126 369.658324 913.738955 383.935495 896.021502 383.935495z"></path>
          </svg>
        </div>
        <div class="tab-label">Register</div>
      </a>
      <a href="#" class="tab-item" data-tab="profile">
        <div class="tab-icon">
          <svg width="24" height="24" viewBox="0 0 1024 1024" fill="currentColor">
            <path d="M511.790222 61.691037c-246.920716 0-447.803909 200.883193-447.803909 447.803909 0 125.418454 53.093219 245.896386 145.623635 330.515622 82.512249 75.634608 189.831486 117.29852 302.180274 117.29852 111.692848 0 218.693838-41.345664 301.305347-116.443036 93.106538-84.718497 146.498562-205.495234 146.498562-331.370083C959.594131 262.574231 758.710938 61.691037 511.790222 61.691037zM511.790222 916.598898c-96.721879 0-189.330066-33.980929-262.572184-95.978958 55.116295-91.861174 154.071028-148.277068 261.975597-148.277068 108.276029 0 207.383234 56.698327 262.35422 148.997476C700.254571 882.875842 607.935979 916.598898 511.790222 916.598898zM348.355943 468.785779c0-89.786932 73.05076-162.837692 162.837692-162.837692 89.786932 0 162.837692 73.05076 162.837692 162.837692 0 89.797166-73.05076 162.847925-162.837692 162.847925C421.406702 631.632681 348.355943 558.582945 348.355943 468.785779zM803.959491 793.053094c-45.032636-71.482031-113.843838-123.124202-193.077414-146.853649 61.936631-34.94386 103.859439-101.371782 103.859439-177.413666 0-112.239294-91.317799-203.546859-203.546859-203.546859s-203.546859 91.307565-203.546859 203.546859c0 76.051093 41.933041 142.486178 103.881952 177.426969-78.916351 23.647583-147.553591 74.991971-192.623066 146.033981-72.863495-75.56093-114.209158-177.226401-114.209158-282.750759 0-224.468354 182.616154-407.094742 407.094742-407.094742s407.094742 182.626387 407.094742 407.094742C918.884964 615.429651 877.28245 717.399043 803.959491 793.053094z"></path>
          </svg>
        </div>
        <div class="tab-label">Profile</div>
      </a>
    </div>

    <!-- Scanner Modal -->
    <div id="scannerModal" class="scanner-modal">
      <div class="scanner-header">
        <h3>Scan QR Code</h3>
        <button class="scanner-close" onclick="closeScannerModal()">&times;</button>
      </div>
      <div class="scanner-container">
        <div id="qr-reader"></div>
        <div class="scanner-instructions">
          Position the QR code or barcode within the frame to scan
        </div>
        <div class="scanner-manual-input">
          <button onclick="manualInputSN()">Enter Manually</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ============================================
       Utility Functions (from js/common.js)
       ============================================ */
    const utils = {
      // Email validation
      isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      },

      // SN validation (16 characters alphanumeric)
      isValidSN(sn) {
        return sn && sn.length === 16;
      },

      // Show toast notification
      showToast(message, type = 'info', duration = null) {
        // Default duration based on type (UX best practice)
        if (duration === null) {
          duration = type === 'success' ? 1500 : type === 'error' ? 3000 : 2000;
        }

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, duration);
      },

      // Show loading state on button
      showLoading(button) {
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="loading-spinner"></span>';

        return () => {
          button.disabled = false;
          button.innerHTML = originalText;
        };
      }
    };

    const mockData = {
      // Mock login
      login(email, password) {
        return new Promise((resolve) => {
          setTimeout(() => {
            resolve({
              success: true,
              user: {
                email,
                name: 'John Installer'
              }
            });
          }, 500);
        });
      },

      // Mock device data
      getDevices() {
        return [
          {
            id: 1,
            name: 'HomeBase S1 Pro',
            sn: 'T8030P2324A00001',
            status: 'Online',
            account: 'john.smith@example.com',
            firmwareVersion: 'v2.1.5',
            createTime: '2024-12-28 14:23:00'
          }
        ];
      },

      // Mock service purchase
      purchaseService(data) {
        return new Promise((resolve) => {
          setTimeout(() => {
            resolve({ success: true });
          }, 800);
        });
      }
    };

    // Viewport scaling for desktop
    function adjustViewportScale() {
      const viewportMeta = document.querySelector('meta[name="viewport"]');
      const screenWidth = window.screen.width;

      if (screenWidth > 428) {
        const scale = 428 / screenWidth;
        viewportMeta.setAttribute('content',
          `width=428, initial-scale=${scale}, maximum-scale=${scale}, user-scalable=no`
        );
      }
    }

    if (window.screen.width > 428) {
      adjustViewportScale();
    }

    /* ============================================
       Application Logic (from main-tabbar.html)
       ============================================ */

    // Products Data
    const productsData = {
      hub: [
        {
          name: 'HomeBase Professional S1',
          image: 'images/products/HomeBase Professional S1.png',
          tagline: 'The Professional Choice for Powerful Integrated Security',
          features: ['Uninterrupted Video Security', 'Expandable AI Features', 'Seamless Wi-Fi and PoE Connectivity', 'Massive Local Storage', 'One Ecosystem, Total Security'],
          attachments: [
            { name: 'User Manual.pdf', url: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', size: '2.5 MB' },
            { name: 'Quick Start Guide.pdf', url: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', size: '1.2 MB' },
            { name: 'Installation Guide.pdf', url: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', size: '3.1 MB' }
          ]
        }
      ],
      'control-panel': [
        {
          name: 'Smart Display E10',
          image: 'images/products/Smart Display E10.png',
          tagline: 'Multi-View Security, All-in-One Display',
          features: ['Instant Hands-Free Door Alerts', 'See Everything with Four Views on One Screen', 'Instant Playback, No Waiting, No Buffering', 'Smart Daily Reports with Key Security Events', 'Monitor Everything, Anytime, Anywhere']
        },
        {
          name: 'Keypad E10',
          image: 'images/products/Keypad E10.png',
          tagline: 'Instant Security with One-Tap SOS Activation',
          features: ['Easily Arm and Disarm', 'Silent Duress Alarm', 'Fast SOS Alert']
        }
      ],
      'indoor-cam': [
        {
          name: 'Indoor Cam S350',
          image: 'images/products/Indoor Cam S350.png',
          tagline: '4K UHD Dual Security Camera with 8x Zoom and 360° PTZ',
          features: ['Superior Clarity', 'Advanced Zoom Capabilities', 'Complete Coverage', 'Exceptional Night Vision', 'Intelligent Tracking'],
          attachments: [
            { name: 'User Manual.pdf', url: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', size: '1.8 MB' },
            { name: 'Specification Sheet.pdf', url: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', size: '850 KB' }
          ]
        },
        {
          name: 'Indoor Cam E220',
          image: 'images/products/Indoor Cam E220.png',
          tagline: '360° Pan and Tilt with 2K Resolution',
          features: ['On-Device AI', '2K Viewing', 'Works with Voice Control', 'Smart Detection Zones', 'A Clear View at Night', 'Two-Way Audio']
        }
      ],
      'outdoor-cam': [
        {
          name: 'eufy SoloCam S340',
          image: 'images/products/eufy SoloCam S340.png',
          tagline: 'Dual Cameras, 360° Detailed Coverage, Solar-Powered',
          features: ['Enhanced Dual-Camera Clarity at 50 Feet', 'Solar-Powered, Install Once and it Runs Forever', '360° Guardian, No Blind Spots', 'Experience Dual Views for Ultimate Surveillance', 'Local Storage, No Monthly Fee', 'Versatile Installation, Effortless Setup']
        },
        {
          name: 'eufy PoE Bullet-PTZ Cam S4',
          image: 'images/products/eufy PoE Bullet-PTZ Cam S4.png',
          tagline: 'Revolutionary View of Fixed Wide-Angle Plus 360° PTZ',
          features: ['16 MP Triple-Lens Bullet-PTZ Camera', 'Auto-Framing and Group Tracking', 'Starlight Color Night Vision', 'Red and Blue Strobe', 'AI Human Detection', '24/7 Recording with PoE', 'IP65 and Two-Way Talk']
        }
      ],
      'video-doorbell': [
        {
          name: 'Video Doorbell E340',
          image: 'images/products/Video Doorbell E340.png',
          tagline: 'Dual 2K Full HD Cameras with Color Night Vision and Delivery Guard',
          features: ['Dual Cameras, Double Security', 'Color Night Vision for a Clear View', 'See What Matters in 2K Full HD Clarity', 'Battery or Wired-Your Choice'],
          attachments: [
            { name: 'Installation Manual.pdf', url: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', size: '2.1 MB' },
            { name: 'Wiring Guide.pdf', url: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', size: '1.5 MB' }
          ]
        },
        {
          name: 'Video Doorbell C30',
          image: 'images/products/Video Doorbell C30.png',
          tagline: '2K Resolution, Seamless Communication',
          features: ['Crystal-Clear Welcome in 2K FHD', 'Real-Time Chat, Seamless Experience', 'Easy Setup, Convenient Power', 'Local Storage, No Monthly Fee', 'Compatible with HomeBase 3, Works with Alexa and Google Assistant']
        }
      ],
      'burglary-sensor': [
        {
          name: 'Entry Sensor E20',
          image: 'images/products/Entry Sensor E20.png',
          tagline: 'Suitable for Various Doors and Windows',
          features: ['Dual-Side Detection', 'Convenient Bypass Button', 'Long-Lasting 5-Year Battery Life']
        },
        {
          name: 'Motion Sensor E20',
          image: 'images/products/Motion Sensor E20.png',
          tagline: 'Pet-Friendly Motion Sensor with Reliable Battery',
          features: ['Pet-Friendly Detection', 'Long-Lasting 5-Year Battery Life', 'Easy Installation']
        },
        {
          name: 'Glass Break Sensor E10',
          image: 'images/products/Glass Break Sensor E10.png',
          tagline: 'Accurate Detection for Multi-Glass Protection (Coming Soon)',
          features: ['Precision Detection with Advanced Algorithms', 'Wide Coverage Area', 'Long-Lasting 3-Year Battery Life']
        }
      ],
      'hazard-sensor': [
        {
          name: 'Smoke Alarm E10',
          image: 'images/products/Smoke Alarm E10.png',
          tagline: 'Prevents False Alarms from Cooking Fumes',
          features: ['Accurate Fire Alerts', 'Ultra-Compact Modern Design', 'Long-Lasting 5-Year Battery Life', 'Expansive Wireless Range with HomeBase', 'Smart Integration']
        },
        {
          name: 'Flood and Freeze Sensor E20',
          image: 'images/products/Flood and Freeze Sensor E20.png',
          tagline: 'Fits in Narrow Spaces with Extension Cable',
          features: ['Dual Flood and Freeze Protection', 'Extension Cable for Extra Reach', 'Powerful 75 dB Local Alarm', 'Long-Lasting 5-Year Battery Life']
        }
      ],
      accessory: [
        {
          name: 'Panic Button E10',
          image: 'images/products/Panic Button E10.png',
          tagline: 'Immediate SOS Access for Emergencies',
          features: ['Weather-Resistant and Durable', 'Optimal Placement for Best Results']
        },
        {
          name: 'Key Fob E10',
          image: 'images/products/Key Fob E10.png',
          tagline: 'Effortless Arm and Disarm at Your Fingertips',
          features: ['Weather-Resistant and Durable', 'Optimal Placement for Best Results']
        },
        {
          name: 'Indoor Siren E20',
          image: 'images/products/Indoor Siren E20.png',
          tagline: 'Stay Alert with a 110 dB Siren',
          features: ['110 dB Alarm for Whole-Floor Coverage', '48-Hour Backup Power', 'Flexible Installation Options']
        },
        {
          name: 'Outdoor Siren E20',
          image: 'images/products/Outdoor Siren E20.png',
          tagline: 'AI-Powered Voice Siren, Scaring Off Threats Before They Act (Coming Soon)',
          features: []
        },
        {
          name: 'Yard Sign & Window sticker',
          image: 'images/products/Yard Sign & Window sticker.png',
          tagline: 'Send a Clear Security Message',
          features: []
        }
      ]
    };

    const categoryNames = {
      hub: 'Hub',
      'control-panel': 'Control Panel',
      'indoor-cam': 'Indoor Cam',
      'outdoor-cam': 'Outdoor Cam',
      'video-doorbell': 'Video Doorbell',
      'burglary-sensor': 'Burglary Sensor',
      'hazard-sensor': 'Hazard Sensor',
      accessory: 'Accessory'
    };

    let currentCategory = 'hub';
    let currentProduct = null;

    // Tab switching
    const tabs = document.querySelectorAll('.tab-item');
    const contents = {
      home: document.getElementById('homeContent'),
      products: document.getElementById('productsContent'),
      plan: document.getElementById('planContent'),
      register: document.getElementById('registerContent'),
      profile: document.getElementById('profileContent')
    };

    const titles = {
      home: 'Home',
      products: 'Products',
      plan: '3D Plan',
      register: 'Register',
      profile: 'Profile'
    };

    tabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        const targetTab = tab.dataset.tab;

        // Hide subscription management if open
        const subscriptionManagement = document.getElementById('subscriptionManagement');
        if (subscriptionManagement && !subscriptionManagement.classList.contains('hidden')) {
          subscriptionManagement.classList.add('hidden');
          document.querySelector('#mainAppView .navbar-back').innerHTML = '';
        }

        // Hide maintenance detail if open
        const maintenanceDetail = document.getElementById('maintenanceDetail');
        if (maintenanceDetail && !maintenanceDetail.classList.contains('hidden')) {
          maintenanceDetail.classList.add('hidden');
          document.querySelector('#mainAppView .navbar-back').innerHTML = '';
        }

        // Hide product detail if open
        const productDetailView = document.getElementById('productDetailView');
        if (productDetailView && !productDetailView.classList.contains('hidden')) {
          productDetailView.classList.add('hidden');
          document.querySelector('#mainAppView .navbar-back').innerHTML = '';
        }

        // Hide attachment viewer if open
        const attachmentViewer = document.getElementById('attachmentViewer');
        if (attachmentViewer && !attachmentViewer.classList.contains('hidden')) {
          attachmentViewer.classList.add('hidden');
          document.querySelector('#mainAppView .navbar-back').innerHTML = '';
        }

        // Hide model history if open
        const modelHistoryView = document.getElementById('modelHistoryView');
        if (modelHistoryView && !modelHistoryView.classList.contains('hidden')) {
          modelHistoryView.classList.add('hidden');
          isViewingFromHistory = false;
        }

        // Reset 3D Plan to Home when switching to plan tab
        if (targetTab === 'plan') {
          document.getElementById('planHome').classList.remove('hidden');
          document.getElementById('planStep1').classList.add('hidden');
          document.getElementById('planStep2').classList.add('hidden');
          document.getElementById('planStep3').classList.add('hidden');
          // Ensure bottom tabbar is shown for primary page
          showBottomTabbar();
        } else {
          // When leaving plan tab, ensure all views are hidden
          document.getElementById('planHome').classList.add('hidden');
          document.getElementById('planStep1').classList.add('hidden');
          document.getElementById('planStep2').classList.add('hidden');
          document.getElementById('planStep3').classList.add('hidden');
        }

        // Hide payment account view if open
        const paymentAccountView = document.getElementById('paymentAccountView');
        if (paymentAccountView && !paymentAccountView.classList.contains('hidden')) {
          paymentAccountView.classList.add('hidden');
          document.querySelector('#mainAppView .navbar-back').innerHTML = '';
        }

        // Hide billing history view if open
        const billingHistoryView = document.getElementById('billingHistoryView');
        if (billingHistoryView && !billingHistoryView.classList.contains('hidden')) {
          billingHistoryView.classList.add('hidden');
          document.querySelector('#mainAppView .navbar-back').innerHTML = '';
        }

        // Hide system update view if open
        const systemUpdateView = document.getElementById('systemUpdateView');
        if (systemUpdateView && !systemUpdateView.classList.contains('hidden')) {
          systemUpdateView.classList.add('hidden');
          document.querySelector('#mainAppView .navbar-back').innerHTML = '';
        }

        // Update active tab
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Show content
        Object.values(contents).forEach(c => c.classList.add('hidden'));
        contents[targetTab].classList.remove('hidden');

        // Show bottom tabbar when switching to primary tabs
        showBottomTabbar();

        // Update navbar title/subtabs
        const navbarTitle = document.getElementById('navbarTitle');
        if (targetTab === 'products') {
          // Make navbar-title full width for subtabs
          navbarTitle.style.position = 'absolute';
          navbarTitle.style.left = '0';
          navbarTitle.style.right = '0';
          navbarTitle.style.top = '0';
          navbarTitle.style.bottom = '0';
          navbarTitle.style.display = 'flex';
          navbarTitle.style.alignItems = 'center';

          // Check which subtab is currently active
          const servicesContent = document.getElementById('servicesSubContent');
          const isServicesActive = servicesContent && !servicesContent.classList.contains('hidden');
          const currentSubtab = isServicesActive ? 'services' : 'devices';

          // Show subtabs for Products with correct active state
          navbarTitle.innerHTML = `
            <div style="display: flex; width: 100%; align-items: stretch; height: 100%;">
              <div class="products-navbar-subtab ${currentSubtab === 'devices' ? 'active' : ''}" data-subtab="devices" style="flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: var(--font-body); ${currentSubtab === 'devices' ? 'font-weight: var(--font-weight-semibold); color: var(--brand-fg-primary); border-bottom: 2px solid var(--brand-fg-primary);' : 'color: var(--fg-tertiary);'}">Devices</div>
              <div class="products-navbar-subtab ${currentSubtab === 'services' ? 'active' : ''}" data-subtab="services" style="flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: var(--font-body); ${currentSubtab === 'services' ? 'font-weight: var(--font-weight-semibold); color: var(--brand-fg-primary); border-bottom: 2px solid var(--brand-fg-primary);' : 'color: var(--fg-tertiary);'}">Services</div>
            </div>
          `;
          // Attach event listeners to new subtabs
          attachProductsSubtabListeners();
        } else if (targetTab === 'register') {
          // Make navbar-title full width for subtabs
          navbarTitle.style.position = 'absolute';
          navbarTitle.style.left = '0';
          navbarTitle.style.right = '0';
          navbarTitle.style.top = '0';
          navbarTitle.style.bottom = '0';
          navbarTitle.style.display = 'flex';
          navbarTitle.style.alignItems = 'center';

          // Check which subtab is currently active
          const serviceSubContent = document.getElementById('serviceSubSubContent');
          const isServiceSubActive = serviceSubContent && !serviceSubContent.classList.contains('hidden');
          const currentRegSubtab = isServiceSubActive ? 'servicesub' : 'devicereg';

          // Show subtabs for Register with correct active state
          navbarTitle.innerHTML = `
            <div style="display: flex; width: 100%; align-items: stretch; height: 100%;">
              <div class="register-navbar-subtab ${currentRegSubtab === 'devicereg' ? 'active' : ''}" data-subtab="devicereg" style="flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: var(--font-body); ${currentRegSubtab === 'devicereg' ? 'font-weight: var(--font-weight-semibold); color: var(--brand-fg-primary); border-bottom: 2px solid var(--brand-fg-primary);' : 'color: var(--fg-tertiary);'}">Register Device</div>
              <div class="register-navbar-subtab ${currentRegSubtab === 'servicesub' ? 'active' : ''}" data-subtab="servicesub" style="flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: var(--font-body); ${currentRegSubtab === 'servicesub' ? 'font-weight: var(--font-weight-semibold); color: var(--brand-fg-primary); border-bottom: 2px solid var(--brand-fg-primary);' : 'color: var(--fg-tertiary);'}">Subscribe Service</div>
            </div>
          `;
          // Attach event listeners to new subtabs
          attachRegisterSubtabListeners();
        } else {
          // Reset navbar-title style for other tabs
          navbarTitle.style.position = '';
          navbarTitle.style.left = '';
          navbarTitle.style.right = '';
          navbarTitle.style.top = '';
          navbarTitle.style.bottom = '';
          navbarTitle.style.display = '';
          navbarTitle.style.alignItems = '';
          navbarTitle.textContent = titles[targetTab];

          // If switching to profile, ensure profile main view is visible
          if (targetTab === 'profile') {
            const profileMainView = document.getElementById('profileMainView');
            if (profileMainView) {
              profileMainView.classList.remove('hidden');
            }
          }
        }
      });
    });

    // Helper function to switch tabs programmatically
    window.switchToTab = function(tabName) {
      const targetTab = document.querySelector(`.tab-item[data-tab="${tabName}"]`);
      if (targetTab) {
        targetTab.click();
      }
    };

    // Show tab function for home page app icons
    window.showTab = function(tabIdentifier) {
      switch(tabIdentifier) {
        case 'productsTab':
          // Switch to Products tab, show Devices subtab
          switchToTab('products');
          setTimeout(() => {
            const devicesSubtab = document.querySelector('.products-navbar-subtab[data-subtab="devices"]');
            if (devicesSubtab) devicesSubtab.click();
          }, 100);
          break;
        case 'registrationTab':
          // Switch to Register tab
          switchToTab('register');
          break;
        case 'servicesTab':
          // Switch to Products tab, show Services subtab
          switchToTab('products');
          setTimeout(() => {
            const servicesSubtab = document.querySelector('.products-navbar-subtab[data-subtab="services"]');
            if (servicesSubtab) servicesSubtab.click();
          }, 100);
          break;
        case 'planTab':
          // Switch to Plan tab
          switchToTab('plan');
          break;
        default:
          break;
      }
    };

    // Open Subscription Management Page
    window.openSubscriptionManagement = function() {
      // Hide all tab contents
      Object.values(contents).forEach(c => c.classList.add('hidden'));

      // Show subscription management
      const subscriptionManagement = document.getElementById('subscriptionManagement');
      subscriptionManagement.classList.remove('hidden');

      // Update navbar
      document.getElementById('navbarTitle').textContent = 'Subscribed Services';
      document.querySelector('#mainAppView .navbar-back').innerHTML = '<span onclick="closeSubscriptionManagement()" style="cursor: pointer; color: var(--brand-fg-primary);">‹ Back</span>';

      // Hide bottom tabbar (secondary page)
      hideBottomTabbar();

      // Render subscriptions
      renderSubscriptions();
    };

    // Close Subscription Management Page
    window.closeSubscriptionManagement = function() {
      const subscriptionManagement = document.getElementById('subscriptionManagement');
      subscriptionManagement.classList.add('hidden');

      // Show home content
      document.getElementById('homeContent').classList.remove('hidden');

      // Update navbar
      document.getElementById('navbarTitle').textContent = 'Home';
      document.querySelector('#mainAppView .navbar-back').innerHTML = '';

      // Show bottom tabbar (back to primary page)
      showBottomTabbar();

      // Reset search and filter
      document.getElementById('subscriptionSearch').value = '';
      currentSubscriptionStatusFilter = 'all';
      filteredSubscriptions = [...subscriptionServices];
    };

    // Filter by subscription status
    window.filterBySubscriptionStatus = function(status) {
      currentSubscriptionStatusFilter = status;

      // Update active state of filter chips
      document.querySelectorAll('#subscriptionManagement .filter-chip').forEach(chip => {
        chip.classList.remove('active');
        if (chip.dataset.status === status) {
          chip.classList.add('active');
        }
      });

      // Apply filters
      applySubscriptionFilters();
    };

    // Apply subscription filters
    window.applySubscriptionFilters = function() {
      const searchTerm = document.getElementById('subscriptionSearch').value.toLowerCase();

      filteredSubscriptions = subscriptionServices.filter(sub => {
        // Status filter
        if (currentSubscriptionStatusFilter !== 'all' && sub.status !== currentSubscriptionStatusFilter) {
          return false;
        }

        // Search filter
        if (searchTerm &&
            !sub.account.toLowerCase().includes(searchTerm) &&
            !sub.deviceSN.toLowerCase().includes(searchTerm)) {
          return false;
        }

        return true;
      });

      renderSubscriptions();
    };

    // Render subscriptions
    function renderSubscriptions() {
      const subscriptionList = document.getElementById('subscriptionList');

      if (filteredSubscriptions.length === 0) {
        subscriptionList.innerHTML = `
          <div style="text-align: center; padding: var(--spacing-xxl) 0; color: var(--fg-tertiary);">
            <svg viewBox="0 0 1567 1024" xmlns="http://www.w3.org/2000/svg" width="120" height="120" style="margin: 0 auto var(--spacing-md);">
              <path d="M156.662278 699.758173h21.097186A10.444152 10.444152 0 0 1 187.994733 710.202325c0 5.765172-4.490985 10.444152-10.235269 10.444152H156.662278v21.097186A10.444152 10.444152 0 0 1 146.218126 751.978932a10.277045 10.277045 0 0 1-10.444152-10.235269V720.646477H114.676787A10.444152 10.444152 0 0 1 104.441518 710.202325c0-5.765172 4.490985-10.444152 10.235269-10.444152H135.773974v-21.097187A10.444152 10.444152 0 0 1 146.218126 668.425717c5.765172 0 10.444152 4.490985 10.444152 10.235269v21.097187z m1378.628042-83.553215v-21.097186A10.277045 10.277045 0 0 0 1524.846168 584.872503a10.444152 10.444152 0 0 0-10.444152 10.235269v21.097186h-21.097186a10.277045 10.277045 0 0 0-10.235269 10.444152c0 5.598065 4.595427 10.444152 10.235269 10.444152h21.097186v21.097187c0 5.744284 4.67898 10.235269 10.444152 10.235268a10.444152 10.444152 0 0 0 10.444152-10.235268V637.093262h21.097187c5.744284 0 10.235269-4.67898 10.235268-10.444152a10.444152 10.444152 0 0 0-10.235268-10.444152H1535.29032zM776.460024 960.861969H250.596979A20.80475 20.80475 0 0 1 229.77134 939.973665c0-11.530344 9.462402-20.888304 20.825639-20.888303h94.728457A83.010119 83.010119 0 0 1 334.212859 877.413196v-605.96969A83.49055 83.49055 0 0 1 417.849627 187.994733H480.430984V167.001988A83.49055 83.49055 0 0 1 564.067752 83.553215h501.152182A83.448773 83.448773 0 0 1 1148.856702 167.001988v605.969689c0 15.185797-4.052331 29.410732-11.133466 41.672166h115.554096c11.551232 0 20.909192 9.274407 20.909192 20.888304 0 11.530344-9.295295 20.888304-20.888304 20.888304H1002.638576v20.992745c0 15.185797-4.052331 29.410732-11.133466 41.672166h11.196131c11.488567 0 20.825639 9.274407 20.825639 20.888303 0 11.530344-9.462402 20.888304-20.825639 20.888304h-109.893365c9.545955 16.000441 7.478013 36.972297-6.41271 50.863019a41.672166 41.672166 0 0 1-59.072122 0L776.460024 960.861969z m76.367638-41.776607h66.424806c22.977134 0 41.609501-18.59059 41.609501-41.881049V270.461756c0-22.559368-18.047494-40.690416-40.314426-40.690416H416.303892c-22.266932 0-40.314426 18.214601-40.314426 40.690416v606.742557c0 23.123352 18.799473 41.881049 41.588613 41.881049h317.084449l-10.736588-10.757477a41.693054 41.693054 0 0 1-10.861918-40.377091l-19.718558-19.739447A146.259902 146.259902 0 0 1 502.363703 627.693525a146.218126 146.218126 0 0 1 220.517822 190.981761l19.739447 19.739447a41.630389 41.630389 0 0 1 40.377091 10.841029L852.827662 919.085362zM1002.638576 814.643843h62.852906A41.797496 41.797496 0 0 0 1107.080095 772.867236V167.106429c0-23.14424-18.632367-41.776607-41.588613-41.776607H563.775316A41.797496 41.797496 0 0 0 522.207592 167.106429v20.888304h396.794216A83.448773 83.448773 0 0 1 1002.638576 271.443506V814.643843zM266.325872 46.998683h31.123572c8.773088 0 15.875111 6.955805 15.875111 15.666228 0 8.647758-7.102023 15.666228-15.875111 15.666228h-31.123572v31.123572c0 8.773088-6.955805 15.875111-15.666228 15.875111a15.770669 15.770669 0 0 1-15.666228-15.875111V78.331139H203.869844A15.728893 15.728893 0 0 1 187.994733 62.664911c0-8.647758 7.102023-15.666228 15.875111-15.666228h31.123572V15.875111c0-8.773088 6.955805-15.875111 15.666228-15.875111 8.647758 0 15.666228 7.102023 15.666228 15.875111v31.123572zM20.888304 939.973665c0-11.530344 9.462402-20.888304 20.825638-20.888303h125.455152c11.488567 0 20.825639 9.274407 20.825639 20.888303 0 11.530344-9.462402 20.888304-20.825639 20.888304H41.713942A20.80475 20.80475 0 0 1 20.888304 939.973665z m658.733544-135.021995a104.441518 104.441518 0 1 0-147.722083-147.722083 104.441518 104.441518 0 0 0 147.722083 147.722083zM459.542681 313.324555a20.888304 20.888304 0 0 1 20.867415-20.888304H710.202325a20.888304 20.888304 0 1 1 0 41.776608H480.430984A20.825639 20.825639 0 0 1 459.542681 313.324555z m0 104.441518c0-11.530344 9.295295-20.888304 20.742085-20.888303h334.505295c11.44679 0 20.742086 9.274407 20.742086 20.888303 0 11.530344-9.295295 20.888304-20.742086 20.888304H480.284766A20.762974 20.762974 0 0 1 459.542681 417.766073z m0 104.441519c0-11.530344 9.316183-20.888304 20.846527-20.888304h146.301679c11.509455 0 20.846527 9.274407 20.846527 20.888304 0 11.530344-9.316183 20.888304-20.846527 20.888303h-146.301679A20.80475 20.80475 0 0 1 459.542681 522.207592zM62.664911 396.87777a62.664911 62.664911 0 1 1 0-125.329822 62.664911 62.664911 0 0 1 0 125.329822z m0-31.332456a31.332456 31.332456 0 1 0 0-62.664911 31.332456 31.332456 0 0 0 0 62.664911zM1357.739739 271.547948a62.664911 62.664911 0 1 1 0-125.329822 62.664911 62.664911 0 0 1 0 125.329822z m0-31.332456a31.332456 31.332456 0 1 0 0-62.664911 31.332456 31.332456 0 0 0 0 62.664911z" fill="#cdcdcd"></path>
            </svg>
            <div style="font-size: var(--font-body);">No Data</div>
          </div>
        `;
        return;
      }

      subscriptionList.innerHTML = filteredSubscriptions.map((sub, index) => `
        <div class="card" style="margin-bottom: var(--spacing-sm); padding: var(--ref-padding-m);">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-xs);">
            <div style="flex: 1;">
              <div style="font-size: var(--font-title1); font-weight: var(--font-weight-semibold); color: var(--color-text-primary); margin-bottom: 2px;">${sub.serviceName}</div>
              <div style="font-size: var(--font-caption2); color: var(--color-text-secondary);">${sub.account}</div>
            </div>
            <div style="font-size: var(--font-caption1); font-weight: var(--font-weight-semibold); color: ${getSubscriptionStatusColor(sub.status)}; white-space: nowrap;">
              ${sub.status}
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-xs); margin-top: var(--spacing-sm); padding-top: var(--spacing-sm); border-top: 1px solid var(--color-border-secondary);">
            <div>
              <div style="font-size: var(--font-caption1); color: var(--color-text-secondary); margin-bottom: 2px;">Device SN</div>
              <div style="font-size: var(--font-caption2); color: var(--color-text-primary);">${sub.deviceSN}</div>
            </div>
            <div>
              <div style="font-size: var(--font-caption1); color: var(--color-text-secondary); margin-bottom: 2px;">Subscription Time</div>
              <div style="font-size: var(--font-caption2); color: var(--color-text-primary);">${sub.subscriptionTime.split(' ')[0]}</div>
            </div>
            <div style="grid-column: 1 / -1;">
              <div style="font-size: var(--font-caption1); color: var(--color-text-secondary); margin-bottom: 2px;">Expiry Time</div>
              <div style="font-size: var(--font-caption2); color: var(--color-text-primary);">${sub.expiryTime.split(' ')[0]}</div>
            </div>
          </div>

          ${sub.status !== 'Canceled' ? `
            <div style="margin-top: var(--spacing-sm);">
              <button class="btn btn-secondary" onclick="confirmUnsubscribe(${index})" style="width: 100%; font-size: var(--font-caption2); height: 32px;">
                Unsubscribe
              </button>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    // Get subscription status color
    function getSubscriptionStatusColor(status) {
      const statusColors = {
        'To be Activated': '#007AFF',   // 蓝色
        'Active': '#00B578',            // 绿色
        'Grace Period': '#FFD60A',      // 黄色
        'Overdue': '#FF9500',           // 橙色
        'Canceled': '#8E8E93',          // 灰色
        'Payment Error': '#FF3B30',     // 红色
        'Trial': '#AF52DE'              // 紫色
      };
      return statusColors[status] || '#8E8E93';
    }

    // Confirm unsubscribe
    window.confirmUnsubscribe = function(index) {
      const sub = filteredSubscriptions[index];
      const originalIndex = subscriptionServices.findIndex(s =>
        s.serviceName === sub.serviceName &&
        s.account === sub.account &&
        s.deviceSN === sub.deviceSN
      );

      // Show confirmation modal
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-body">
            <div class="modal-title">Confirm Unsubscribe</div>
            <div class="modal-description">Are you sure you want to unsubscribe from <strong>${sub.serviceName}</strong>?</div>
            <div style="margin-top: var(--spacing-md); padding: var(--spacing-sm); background-color: var(--bg-secondary); border-radius: var(--ref-radius-s); font-size: var(--font-caption2); color: var(--fg-secondary);">
              <div style="margin-bottom: 4px;">Device SN: <strong>${sub.deviceSN}</strong></div>
              <div>Account: <strong>${sub.account}</strong></div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
            <button class="btn btn-danger" onclick="executeUnsubscribe(${originalIndex}, ${index})">Unsubscribe</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };

    // Execute unsubscribe
    window.executeUnsubscribe = function(originalIndex, filteredIndex) {
      // Update status to Canceled
      subscriptionServices[originalIndex].status = 'Canceled';
      filteredSubscriptions[filteredIndex].status = 'Canceled';

      // Close modal
      document.querySelector('.modal-overlay').remove();

      // Re-render
      renderSubscriptions();

      utils.showToast('Subscription canceled successfully', 'success');
    };

    // Open Maintenance Detail Page
    window.openMaintenanceDetail = function() {
      // Hide all tab contents
      Object.values(contents).forEach(c => c.classList.add('hidden'));

      // Show maintenance detail
      const maintenanceDetail = document.getElementById('maintenanceDetail');
      maintenanceDetail.classList.remove('hidden');

      // Update navbar
      document.getElementById('navbarTitle').textContent = 'Device Maintenance';
      document.querySelector('#mainAppView .navbar-back').innerHTML = '<span onclick="closeMaintenanceDetail()" style="cursor: pointer; color: var(--brand-fg-primary);">‹ Back</span>';

      // Hide bottom tabbar (secondary page)
      hideBottomTabbar();

      // Render devices
      filterMaintenanceDevices();
    };

    // Close Maintenance Detail Page
    window.closeMaintenanceDetail = function() {
      // Hide maintenance detail
      const maintenanceDetail = document.getElementById('maintenanceDetail');
      maintenanceDetail.classList.add('hidden');

      // Show home content
      contents['home'].classList.remove('hidden');

      // Update navbar
      document.getElementById('navbarTitle').textContent = 'Home';
      document.querySelector('#mainAppView .navbar-back').innerHTML = '';

      // Show bottom tabbar (back to primary page)
      showBottomTabbar();
    };

    // Products Page Functions
    // Function to attach subtab listeners (called dynamically when navbar subtabs are created)
    function attachProductsSubtabListeners() {
      document.querySelectorAll('.products-navbar-subtab').forEach(subtab => {
        subtab.addEventListener('click', () => {
          const targetSubtab = subtab.dataset.subtab;

          // Update active state
          document.querySelectorAll('.products-navbar-subtab').forEach(t => {
            t.classList.remove('active');
            t.style.borderBottom = 'none';
            t.style.color = 'var(--fg-tertiary)';
            t.style.fontWeight = 'normal';
          });
          subtab.classList.add('active');
          subtab.style.borderBottom = '2px solid var(--brand-fg-primary)';
          subtab.style.color = 'var(--brand-fg-primary)';
          subtab.style.fontWeight = 'var(--font-weight-semibold)';

          // Show/hide content
          const devicesContent = document.getElementById('devicesSubContent');
          const servicesContent = document.getElementById('servicesSubContent');

          if (targetSubtab === 'devices') {
            devicesContent.style.display = 'flex';
            servicesContent.classList.add('hidden');
            renderDevicesByCategory(currentCategory);
          } else {
            devicesContent.style.display = 'none';
            servicesContent.classList.remove('hidden');
            loadServices();
          }
        });
      });
    }

    // Attach event listeners for Register subtabs
    function attachRegisterSubtabListeners() {
      document.querySelectorAll('.register-navbar-subtab').forEach(subtab => {
        subtab.addEventListener('click', () => {
          const targetSubtab = subtab.dataset.subtab;

          // Update active state
          document.querySelectorAll('.register-navbar-subtab').forEach(t => {
            t.classList.remove('active');
            t.style.borderBottom = 'none';
            t.style.color = 'var(--fg-tertiary)';
            t.style.fontWeight = 'normal';
          });
          subtab.classList.add('active');
          subtab.style.borderBottom = '2px solid var(--brand-fg-primary)';
          subtab.style.color = 'var(--brand-fg-primary)';
          subtab.style.fontWeight = 'var(--font-weight-semibold)';

          // Show/hide content
          const deviceRegContent = document.getElementById('deviceRegSubContent');
          const serviceSubContent = document.getElementById('serviceSubSubContent');

          if (targetSubtab === 'devicereg') {
            deviceRegContent.classList.remove('hidden');
            serviceSubContent.classList.add('hidden');
          } else {
            deviceRegContent.classList.add('hidden');
            serviceSubContent.classList.remove('hidden');
          }
        });
      });
    }

    // Category tab switching
    document.querySelectorAll('.category-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const category = tab.dataset.category;
        currentCategory = category;

        // Update active state
        document.querySelectorAll('.category-tab').forEach(t => {
          t.classList.remove('active');
          t.style.backgroundColor = '';
        });
        tab.classList.add('active');
        tab.style.backgroundColor = 'var(--bg-primary)';

        // Render devices
        renderDevicesByCategory(category);
      });
    });

    // Render devices by category
    function renderDevicesByCategory(category) {
      const categoryTitle = document.getElementById('categoryTitle');
      const deviceGrid = document.getElementById('deviceGrid');

      categoryTitle.textContent = categoryNames[category];

      const products = productsData[category] || [];

      if (products.length === 0) {
        deviceGrid.innerHTML = `
          <div style="text-align: center; padding: var(--spacing-xl); color: var(--fg-tertiary);">
            No products in this category
          </div>
        `;
        return;
      }

      deviceGrid.innerHTML = products.map(product => `
        <div class="card" style="cursor: pointer; padding: var(--ref-padding-m); display: flex; align-items: center; gap: var(--spacing-md);" onclick="showProductDetail('${category}', '${product.name}')">
          <img src="${product.image}" alt="${product.name}" style="width: 48px; height: 48px; object-fit: contain; flex-shrink: 0;">
          <div style="flex: 1;">
            <div style="font-size: var(--font-body); font-weight: var(--font-weight-semibold); color: var(--fg-primary);">${product.name}</div>
          </div>
          <div class="list-item-arrow">›</div>
        </div>
      `).join('');
    }

    // Show product detail
    window.showProductDetail = function(category, productName) {
      const product = productsData[category].find(p => p.name === productName);
      if (!product) return;

      currentProduct = { category, product };

      // Hide products content
      document.getElementById('productsContent').classList.add('hidden');

      // Show product detail view
      const detailView = document.getElementById('productDetailView');
      const attachments = product.attachments || [];

      detailView.innerHTML = `
        <div style="display: flex; flex-direction: column; height: 100%;">
          <!-- Tab Switcher -->
          <div style="display: flex; height: var(--navbar-height); background-color: #ffffff; border-top: 0.33px solid var(--fill-secondary); border-bottom: 0.33px solid var(--fill-secondary);">
            <button class="detail-tab active" data-tab="details" onclick="switchDetailTab('details')" style="flex: 1; background: none; border: none; color: var(--brand-fg-primary); font-size: var(--font-body); font-weight: var(--font-weight-semibold); cursor: pointer; border-bottom: 2px solid var(--brand-fg-primary); transition: all 150ms ease;">
              Details
            </button>
            <button class="detail-tab" data-tab="attachments" onclick="switchDetailTab('attachments')" style="flex: 1; background: none; border: none; color: var(--fg-secondary); font-size: var(--font-body); font-weight: var(--font-weight-semibold); cursor: pointer; border-bottom: 2px solid transparent; transition: all 150ms ease;">
              Attachments <span style="margin-left: 4px; color: var(--fg-tertiary);">(${attachments.length})</span>
            </button>
          </div>

          <!-- Details Tab Content -->
          <div id="detailsTabContent" style="flex: 1; overflow-y: auto; padding: var(--ref-padding-l);">
            <!-- Product Image -->
            <div style="display: flex; justify-content: center; align-items: center; padding: var(--spacing-xl) 0; background-color: var(--bg-secondary); border-radius: var(--ref-radius-m); margin-bottom: var(--spacing-lg);">
              <img src="${product.image}" alt="${product.name}" style="max-width: 200px; max-height: 200px; object-fit: contain;">
            </div>

            <!-- Product Name -->
            <h2 style="font-size: var(--font-display1); font-weight: var(--font-weight-bold); color: var(--fg-primary); margin-bottom: var(--spacing-sm);">${product.name}</h2>

            <!-- Tagline -->
            <p style="font-size: var(--font-body); color: var(--fg-secondary); margin-bottom: var(--spacing-lg); line-height: var(--line-height-relaxed);">${product.tagline}</p>

            <!-- Features -->
            ${product.features.length > 0 ? `
            <ul style="margin: 0; padding-left: var(--ref-padding-l); color: var(--fg-secondary); line-height: var(--line-height-relaxed);">
              ${product.features.map(feature => `
                <li style="margin-bottom: var(--spacing-sm);">${feature}</li>
              `).join('')}
            </ul>
            ` : ''}
          </div>

          <!-- Attachments Tab Content -->
          <div id="attachmentsTabContent" class="hidden" style="flex: 1; overflow-y: auto; padding: var(--ref-padding-l);">
            ${attachments.length > 0 ? `
              <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                ${attachments.map((attachment, index) => `
                  <div class="card" style="cursor: pointer; padding: var(--ref-padding-m); display: flex; align-items: center; gap: var(--spacing-md);" onclick="showAttachmentViewer('${attachment.url}', '${attachment.name}')">
                    <svg t="1767756051900" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="35265" width="40" height="40" style="flex-shrink: 0;">
                      <path d="M870.4 1024h-716.8A51.2 51.2 0 0 1 102.4 972.8v-921.6A51.2 51.2 0 0 1 153.6 0h569.685333a42.666667 42.666667 0 0 1 30.037334 12.288l155.989333 155.989333a42.666667 42.666667 0 0 1 12.288 30.037334V972.8a51.2 51.2 0 0 1-51.2 51.2zM153.6 34.133333a17.066667 17.066667 0 0 0-17.066667 17.066667v921.6a17.066667 17.066667 0 0 0 17.066667 17.066667h716.8a17.066667 17.066667 0 0 0 17.066667-17.066667V198.314667a7.168 7.168 0 0 0-2.389334-5.802667l-155.989333-155.989333a7.168 7.168 0 0 0-5.802667-2.389334z" fill="#4D4D4D" p-id="35266"></path>
                      <path d="M904.533333 204.8h-170.666666a17.066667 17.066667 0 0 1-17.066667-17.066667v-170.666666h34.133333V170.666667h153.6z" fill="#4D4D4D" p-id="35267"></path>
                      <path d="M204.8 170.666667h443.733333v34.133333H204.8zM204.8 307.2h614.4v34.133333H204.8zM204.8 443.733333h614.4v34.133334H204.8zM204.8 580.266667h614.4v34.133333H204.8zM204.8 853.333333h614.4v34.133334H204.8zM204.8 716.8h614.4v34.133333H204.8z" fill="#B3B3B3" p-id="35268"></path>
                      <path d="M51.2 460.8m17.066667 0l887.466666 0q17.066667 0 17.066667 17.066667l0 273.066666q0 17.066667-17.066667 17.066667l-887.466666 0q-17.066667 0-17.066667-17.066667l0-273.066666q0-17.066667 17.066667-17.066667Z" fill="#F33958" p-id="35269"></path>
                      <path d="M955.733333 477.866667v273.066666H68.266667v-273.066666h887.466666m0-34.133334H68.266667a34.133333 34.133333 0 0 0-34.133334 34.133334v273.066666a34.133333 34.133333 0 0 0 34.133334 34.133334h887.466666a34.133333 34.133333 0 0 0 34.133334-34.133334v-273.066666a34.133333 34.133333 0 0 0-34.133334-34.133334z" fill="#C42E47" p-id="35270"></path>
                      <path d="M348.16 530.090667a55.978667 55.978667 0 1 1 0 111.616H307.2v57.002666h-24.917333v-168.618666zM307.2 618.837333h34.133333c22.528 0 35.84-11.605333 35.84-32.426666s-12.970667-34.133333-35.84-34.133334H307.2zM509.952 530.090667A74.410667 74.410667 0 0 1 589.141333 614.4a75.093333 75.093333 0 0 1-79.189333 84.992h-60.757333v-169.301333z m-34.133333 144.725333h31.744A52.906667 52.906667 0 0 0 562.858667 614.4a53.248 53.248 0 0 0-55.637334-60.074667h-31.744zM636.586667 698.709333v-168.618666h105.130666v23.893333h-78.848v51.882667h72.021334v22.869333h-72.021334v68.266667z" fill="#FFFFFF" p-id="35271"></path>
                    </svg>
                    <div style="flex: 1;">
                      <div style="font-size: var(--font-body); font-weight: var(--font-weight-semibold); color: var(--fg-primary); margin-bottom: 2px;">${attachment.name}</div>
                      <div style="font-size: var(--font-caption2); color: var(--fg-tertiary);">${attachment.size || 'PDF Document'}</div>
                    </div>
                    <div class="list-item-arrow">›</div>
                  </div>
                `).join('')}
              </div>
            ` : `
              <div style="text-align: center; padding: var(--spacing-xxl) 0; color: var(--fg-tertiary);">
                <svg t="1767756603110" class="icon" viewBox="0 0 1593 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="40200" width="120" height="120" style="margin: 0 auto var(--spacing-md);">
                  <path d="M1380.821654 457.181353v-21.81197c0-3.988211 3.218286-7.221895 7.252692-7.221894 4.003609 0 7.260391 3.310677 7.260391 7.221894v21.804271h21.804271c3.988211 0 7.221895 3.225985 7.221894 7.260391 0 4.003609-3.310677 7.252692-7.221894 7.252692h-21.804271v21.804271a7.221895 7.221895 0 0 1-7.260391 7.221894 7.283489 7.283489 0 0 1-7.252692-7.221894v-21.804271h-21.804271a7.221895 7.221895 0 0 1-7.221894-7.252692c0-4.003609 3.310677-7.260391 7.221894-7.260391h21.804271zM190.710376 384.600541v-21.80427c0-3.988211 3.218286-7.221895 7.260391-7.221895 4.003609 0 7.252692 3.310677 7.252692 7.221895v21.80427h21.80427c3.988211 0 7.221895 3.218286 7.221895 7.260391 0 4.003609-3.310677 7.252692-7.221895 7.252692h-21.80427v21.804271a7.221895 7.221895 0 0 1-7.252692 7.221894 7.283489 7.283489 0 0 1-7.260391-7.221894v-21.804271h-21.804271a7.221895 7.221895 0 0 1-7.221894-7.252692c0-4.011308 3.310677-7.260391 7.221894-7.260391h21.804271zM1315.508932 43.539248V7.314286c0-4.034406 3.218286-7.306586 7.260391-7.306587 4.003609 0 7.252692 3.264481 7.252692 7.306587v36.232661h36.232662c4.034406 0 7.314286 3.225985 7.314285 7.260391 0 4.003609-3.27218 7.252692-7.314285 7.252692h-36.232662v36.232662a7.260391 7.260391 0 0 1-7.252692 7.314285 7.275789 7.275789 0 0 1-7.260391-7.314285V58.052331h-36.232661a7.260391 7.260391 0 0 1-7.314286-7.252692c0-4.003609 3.27218-7.260391 7.314286-7.260391h36.232661zM447.210827 366.645895a23.251729 23.251729 0 0 1 7.768541-1.324271h56.651068v-62.648782c0-25.523008 20.664782-46.203188 46.164692-46.203188h488.217022a46.156992 46.156992 0 0 1 46.164692 46.195489v62.656481h56.651068c2.725534 0 5.343278 0.461955 7.77624 1.33197V120.300752c0-8.469173-6.875429-15.336902-15.3523-15.336902h-238.653594c-7.599158 0-19.017143 6.028511-23.274827 12.295699l-31.867188 46.89612c-7.668451 11.287098-23.197835 19.479098-36.840903 19.479098H462.586226a15.398496 15.398496 0 0 0-15.375399 15.383098V366.638195z m0 316.20812c0 8.507669 6.898526 15.398496 15.46009 15.398496h678.465444a15.390797 15.390797 0 0 0 15.467789-15.344601V388.442466c0-4.273083-3.464662-7.722346-7.77624-7.722346h-693.856241c-4.319278 0-7.760842 3.441564-7.760842 7.722346v294.419248z m724.79182 0.053895v7.614556a23.113143 23.113143 0 0 1-23.174737 23.120842h-693.856241a23.128541 23.128541 0 0 1-23.159338-23.120842V199.017865a30.796992 30.796992 0 0 1 30.773895-30.789294h348.029112c8.538466 0 19.302015-5.658947 24.098647-12.726857l31.874887-46.888421c7.144902-10.524872 23.34412-19.04794 36.009384-19.04794h238.653594a30.743098 30.743098 0 0 1 30.750797 30.735399v562.607158z m-95.224301-318.471699v-61.763369c0-17.038436-13.766256-30.804692-30.766196-30.804692H557.795128a30.781594 30.781594 0 0 0-30.766196 30.796993v61.771068h549.749414zM302.195489 870.015038a15.398496 15.398496 0 1 1 0-30.796993 15.398496 15.398496 0 0 1 0 30.796993zM7.699248 941.233083a7.699248 7.699248 0 1 1 0-15.398497h192.481203a7.699248 7.699248 0 1 1 0 15.398497H7.699248z m827.669173 0a7.699248 7.699248 0 1 1 0-15.398497h192.481203a7.699248 7.699248 0 1 1 0 15.398497h-192.481203z m-558.195489 0a7.699248 7.699248 0 1 1 0-15.398497h288.721805a7.699248 7.699248 0 1 1 0 15.398497H277.172932z m827.669173 0a7.699248 7.699248 0 1 1 0-15.398497H1586.045113a7.699248 7.699248 0 1 1 0 15.398497h-481.203008z m-442.706767 0a7.699248 7.699248 0 1 1 0-15.398497h96.240602a7.699248 7.699248 0 1 1 0 15.398497H662.135338z m-96.240601 76.992481a7.699248 7.699248 0 1 1 0-15.398496h384.962406a7.699248 7.699248 0 1 1 0 15.398496h-384.962406z m461.954887 0a7.699248 7.699248 0 1 1 0-15.398496h9.62406a7.699248 7.699248 0 1 1 0 15.398496h-9.62406z" fill="#999999" p-id="40201"></path>
                </svg>
                <div style="font-size: var(--font-body);">No Attachments</div>
              </div>
            `}
          </div>
        </div>
      `;

      detailView.classList.remove('hidden');

      // Hide bottom tabbar (secondary page)
      hideBottomTabbar();

      // Update navbar - reset positioning and show product name
      const navbarTitle = document.getElementById('navbarTitle');
      navbarTitle.style.position = '';
      navbarTitle.style.left = '';
      navbarTitle.style.right = '';
      navbarTitle.style.top = '';
      navbarTitle.style.bottom = '';
      navbarTitle.style.display = '';
      navbarTitle.style.alignItems = '';
      navbarTitle.textContent = product.name;
      document.querySelector('#mainAppView .navbar-back').innerHTML = '<span onclick="showProductsList()" style="cursor: pointer; color: var(--brand-fg-primary);">‹ Back</span>';
    };

    // Show products list
    window.showProductsList = function() {
      const detailView = document.getElementById('productDetailView');
      detailView.classList.add('hidden');

      document.getElementById('productsContent').classList.remove('hidden');

      // Show bottom tabbar (back to primary page)
      showBottomTabbar();

      // Restore navbar subtabs with absolute positioning
      const navbarTitle = document.getElementById('navbarTitle');

      // Apply absolute positioning for full width
      navbarTitle.style.position = 'absolute';
      navbarTitle.style.left = '0';
      navbarTitle.style.right = '0';
      navbarTitle.style.top = '0';
      navbarTitle.style.bottom = '0';
      navbarTitle.style.display = 'flex';
      navbarTitle.style.alignItems = 'center';

      const currentSubtab = document.getElementById('servicesSubContent').classList.contains('hidden') ? 'devices' : 'services';
      navbarTitle.innerHTML = `
        <div style="display: flex; width: 100%; align-items: stretch; height: 100%;">
          <div class="products-navbar-subtab ${currentSubtab === 'devices' ? 'active' : ''}" data-subtab="devices" style="flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: var(--font-body); ${currentSubtab === 'devices' ? 'font-weight: var(--font-weight-semibold); color: var(--brand-fg-primary); border-bottom: 2px solid var(--brand-fg-primary);' : 'color: var(--fg-tertiary);'}">Devices</div>
          <div class="products-navbar-subtab ${currentSubtab === 'services' ? 'active' : ''}" data-subtab="services" style="flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: var(--font-body); ${currentSubtab === 'services' ? 'font-weight: var(--font-weight-semibold); color: var(--brand-fg-primary); border-bottom: 2px solid var(--brand-fg-primary);' : 'color: var(--fg-tertiary);'}">Services</div>
        </div>
      `;
      attachProductsSubtabListeners();

      document.querySelector('#mainAppView .navbar-back').innerHTML = '';

      currentProduct = null;
    };

    // Switch detail tab
    window.switchDetailTab = function(tabName) {
      // Update tab buttons
      document.querySelectorAll('.detail-tab').forEach(tab => {
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
          tab.style.color = 'var(--brand-fg-primary)';
          tab.style.borderBottomColor = 'var(--brand-fg-primary)';
        } else {
          tab.classList.remove('active');
          tab.style.color = 'var(--fg-secondary)';
          tab.style.borderBottomColor = 'transparent';
        }
      });

      // Show/hide content
      if (tabName === 'details') {
        document.getElementById('detailsTabContent').classList.remove('hidden');
        document.getElementById('attachmentsTabContent').classList.add('hidden');
      } else {
        document.getElementById('detailsTabContent').classList.add('hidden');
        document.getElementById('attachmentsTabContent').classList.remove('hidden');
      }
    };

    // Show attachment viewer
    window.showAttachmentViewer = function(url, name) {
      // Hide product detail
      document.getElementById('productDetailView').classList.add('hidden');

      // Show attachment viewer
      const viewer = document.getElementById('attachmentViewer');

      // Bottom tabbar already hidden from product detail (tertiary page)
      viewer.innerHTML = `
        <div style="flex: 1; display: flex; flex-direction: column; height: 100%;">
          <!-- PDF Viewer Mock -->
          <div style="flex: 1; background-color: #f5f5f5; position: relative; overflow-y: auto; padding: var(--spacing-lg);">
            <div style="max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: var(--spacing-lg);">

              <!-- Page 1 -->
              <div style="background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: var(--spacing-xl);">
                <div style="text-align: center; margin-bottom: var(--spacing-lg);">
                  <svg t="1767756051900" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="35265" width="60" height="60" style="margin: 0 auto var(--spacing-sm); opacity: 0.5;">
                    <path d="M870.4 1024h-716.8A51.2 51.2 0 0 1 102.4 972.8v-921.6A51.2 51.2 0 0 1 153.6 0h569.685333a42.666667 42.666667 0 0 1 30.037334 12.288l155.989333 155.989333a42.666667 42.666667 0 0 1 12.288 30.037334V972.8a51.2 51.2 0 0 1-51.2 51.2zM153.6 34.133333a17.066667 17.066667 0 0 0-17.066667 17.066667v921.6a17.066667 17.066667 0 0 0 17.066667 17.066667h716.8a17.066667 17.066667 0 0 0 17.066667-17.066667V198.314667a7.168 7.168 0 0 0-2.389334-5.802667l-155.989333-155.989333a7.168 7.168 0 0 0-5.802667-2.389334z" fill="#4D4D4D" p-id="35266"></path>
                    <path d="M51.2 460.8m17.066667 0l887.466666 0q17.066667 0 17.066667 17.066667l0 273.066666q0 17.066667-17.066667 17.066667l-887.466666 0q-17.066667 0-17.066667-17.066667l0-273.066666q0-17.066667 17.066667-17.066667Z" fill="#F33958" p-id="35269"></path>
                    <path d="M348.16 530.090667a55.978667 55.978667 0 1 1 0 111.616H307.2v57.002666h-24.917333v-168.618666zM307.2 618.837333h34.133333c22.528 0 35.84-11.605333 35.84-32.426666s-12.970667-34.133333-35.84-34.133334H307.2zM509.952 530.090667A74.410667 74.410667 0 0 1 589.141333 614.4a75.093333 75.093333 0 0 1-79.189333 84.992h-60.757333v-169.301333z m-34.133333 144.725333h31.744A52.906667 52.906667 0 0 0 562.858667 614.4a53.248 53.248 0 0 0-55.637334-60.074667h-31.744zM636.586667 698.709333v-168.618666h105.130666v23.893333h-78.848v51.882667h72.021334v22.869333h-72.021334v68.266667z" fill="#FFFFFF" p-id="35271"></path>
                  </svg>
                  <h3 style="font-size: var(--font-title1); font-weight: var(--font-weight-bold); color: var(--fg-primary); margin-bottom: var(--spacing-xxs);">${name}</h3>
                  <p style="font-size: var(--font-caption2); color: var(--fg-tertiary);">Page 1</p>
                </div>
                <div style="padding: var(--spacing-md) 0;">
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 80%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 95%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 70%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-lg); border-radius: 2px; width: 90%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 85%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 92%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 75%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-lg); border-radius: 2px; width: 88%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 78%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 93%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 82%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 90%;"></div>
                </div>
              </div>

              <!-- Page 2 -->
              <div style="background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: var(--spacing-xl);">
                <div style="text-align: center; margin-bottom: var(--spacing-lg); padding-bottom: var(--spacing-md); border-bottom: 1px solid var(--fill-tertiary);">
                  <p style="font-size: var(--font-caption2); color: var(--fg-tertiary);">Page 2</p>
                </div>
                <div style="padding: var(--spacing-md) 0;">
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 88%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 92%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 76%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-lg); border-radius: 2px; width: 85%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 90%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 94%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 80%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-lg); border-radius: 2px; width: 87%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 83%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 91%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 77%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 89%;"></div>
                </div>
              </div>

              <!-- Page 3 -->
              <div style="background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: var(--spacing-xl); margin-bottom: var(--spacing-lg);">
                <div style="text-align: center; margin-bottom: var(--spacing-lg); padding-bottom: var(--spacing-md); border-bottom: 1px solid var(--fill-tertiary);">
                  <p style="font-size: var(--font-caption2); color: var(--fg-tertiary);">Page 3</p>
                </div>
                <div style="padding: var(--spacing-md) 0;">
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 86%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 93%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 79%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-lg); border-radius: 2px; width: 91%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 84%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 90%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 72%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-lg); border-radius: 2px; width: 88%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 81%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 95%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 74%;"></div>
                  <div style="height: 4px; background: var(--fill-tertiary); margin-bottom: var(--spacing-sm); border-radius: 2px; width: 87%;"></div>
                </div>
              </div>

            </div>
          </div>

          <!-- Download Button -->
          <div style="padding: var(--ref-padding-l); background-color: var(--bg-primary); border-top: 0.33px solid var(--fill-secondary);">
            <button class="btn btn-primary" onclick="downloadAttachment('${url}', '${name}')">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: var(--spacing-xs);">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              Download
            </button>
          </div>
        </div>
      `;
      viewer.classList.remove('hidden');

      // Update navbar
      const navbarTitle = document.getElementById('navbarTitle');
      navbarTitle.textContent = name;
      document.querySelector('#mainAppView .navbar-back').innerHTML = '<span onclick="closeAttachmentViewer()" style="cursor: pointer; color: var(--brand-fg-primary);">‹ Back</span>';
    };

    // Close attachment viewer
    window.closeAttachmentViewer = function() {
      document.getElementById('attachmentViewer').classList.add('hidden');
      document.getElementById('productDetailView').classList.remove('hidden');

      // Restore product name in navbar
      if (currentProduct) {
        document.getElementById('navbarTitle').textContent = currentProduct.product.name;
        document.querySelector('#mainAppView .navbar-back').innerHTML = '<span onclick="showProductsList()" style="cursor: pointer; color: var(--brand-fg-primary);">‹ Back</span>';
      }
    };

    // Download attachment
    window.downloadAttachment = function(url, name) {
      // For prototype: simulate download
      utils.showToast(`Downloading ${name}...`, 'success');

      // In real app, this would trigger actual download:
      // const link = document.createElement('a');
      // link.href = url;
      // link.download = name;
      // document.body.appendChild(link);
      // link.click();
      // document.body.removeChild(link);
    };

    // Load services
    function loadServices() {
      const container = document.getElementById('servicePlans');

      // All services list
      const allServices = [
        '4G cellular Backup',
        'eufyCare+',
        'eufyExpert GPT Assistant',
        '3D Home Arm/Disarm',
        '24/7 Professional Monitoring',
        'Home Insurance Discount'
      ];

      // Basic has first 4, Plus has all 6
      const basicIncluded = [true, true, true, true, false, false];
      const plusIncluded = [true, true, true, true, true, true];

      container.innerHTML = `
        <div class="card" style="overflow-x: auto; padding: 0 var(--ref-padding-l);">
          <table style="width: 100%; border-collapse: collapse;">
            <!-- Header Row -->
            <thead>
              <tr style="border-bottom: 2px solid rgba(0, 0, 0, 0.10);">
                <th style="text-align: left; padding: var(--spacing-md) var(--spacing-sm); font-size: var(--font-body); font-weight: var(--font-weight-semibold); color: var(--fg-primary);">Service</th>
                <th style="text-align: center; padding: var(--spacing-md) var(--spacing-sm); font-size: var(--font-body); font-weight: var(--font-weight-semibold); color: var(--fg-primary);">Basic Plan</th>
                <th style="text-align: center; padding: var(--spacing-md) var(--spacing-sm); font-size: var(--font-body); font-weight: var(--font-weight-semibold); color: var(--fg-primary);">Plus Plan</th>
              </tr>
            </thead>
            <!-- Service Rows -->
            <tbody>
              ${allServices.map((service, index) => `
                <tr style="${index < allServices.length - 1 ? 'border-bottom: 1px solid rgba(0, 0, 0, 0.10);' : ''}">
                  <td style="padding: var(--spacing-md) var(--spacing-sm); font-size: var(--font-body); color: var(--fg-primary);">${service}</td>
                  <td style="text-align: center; padding: var(--spacing-md) var(--spacing-sm);">
                    ${basicIncluded[index] ? `
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--function-success)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                    ` : `<span style="color: var(--fg-quaternary); font-size: var(--font-body);">-</span>`}
                  </td>
                  <td style="text-align: center; padding: var(--spacing-md) var(--spacing-sm);">
                    ${plusIncluded[index] ? `
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--function-success)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                    ` : `<span style="color: var(--fg-quaternary); font-size: var(--font-body);">-</span>`}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // Initialize products page
    renderDevicesByCategory('hub');

    // Subscription Management Data
    let subscriptionServices = [
      {
        serviceName: 'Basic Plan',
        account: 'john.smith@example.com',
        deviceSN: 'T8030P2324A00001',
        status: 'Active',
        subscriptionTime: '2024-01-15 10:30:00',
        expiryTime: '2025-01-15 10:30:00'
      },
      {
        serviceName: 'Plus Plan',
        account: 'mary.jones@example.com',
        deviceSN: 'T8030P2324A00002',
        status: 'To be Activated',
        subscriptionTime: '2025-01-05 14:20:00',
        expiryTime: '2026-01-05 14:20:00'
      },
      {
        serviceName: 'Basic Plan',
        account: 'alice.wilson@example.com',
        deviceSN: 'T8030P2324A00004',
        status: 'Grace Period',
        subscriptionTime: '2024-02-10 09:15:00',
        expiryTime: '2025-01-10 09:15:00'
      },
      {
        serviceName: 'Plus Plan',
        account: 'bob.brown@example.com',
        deviceSN: 'T8030P2324A00005',
        status: 'Overdue',
        subscriptionTime: '2024-03-20 16:45:00',
        expiryTime: '2024-12-20 16:45:00'
      },
      {
        serviceName: 'Basic Plan',
        account: 'john.smith@example.com',
        deviceSN: 'T8030P2324A00003',
        status: 'Canceled',
        subscriptionTime: '2024-06-01 11:00:00',
        expiryTime: '2025-06-01 11:00:00'
      },
      {
        serviceName: 'Plus Plan',
        account: 'sarah.davis@example.com',
        deviceSN: 'T8030P2324A00007',
        status: 'Payment Error',
        subscriptionTime: '2024-11-15 13:30:00',
        expiryTime: '2025-11-15 13:30:00'
      },
      {
        serviceName: 'Basic Plan',
        account: 'mike.taylor@example.com',
        deviceSN: 'T8030P2324A00008',
        status: 'Trial',
        subscriptionTime: '2025-01-01 08:00:00',
        expiryTime: '2025-01-31 08:00:00'
      }
    ];

    let filteredSubscriptions = [...subscriptionServices];
    let currentSubscriptionStatusFilter = 'all';

    // Maintenance Page Functions
    let maintenanceDevices = [
      {
        deviceSN: 'T8030P2324A00001',
        deviceName: 'HomeBase S1 Pro',
        account: 'john.smith@example.com',
        firmwareVersion: 'v2.1.5',
        createTime: '2024-12-28 14:23:00',
        status: 'Online'
      },
      {
        deviceSN: 'T8030P2324A00002',
        deviceName: 'Indoor Cam S350',
        account: 'mary.jones@example.com',
        firmwareVersion: 'v1.8.2',
        createTime: '2024-12-27 09:45:00',
        status: 'Offline'
      },
      {
        deviceSN: 'T8030P2324A00003',
        deviceName: 'Video Doorbell E340',
        account: 'john.smith@example.com',
        firmwareVersion: 'v3.2.1',
        createTime: '2024-12-25 16:30:00',
        status: 'Manual Offline'
      },
      {
        deviceSN: 'T8030P2324A00004',
        deviceName: 'eufy SoloCam S340',
        account: 'alice.wilson@example.com',
        firmwareVersion: 'v2.5.0',
        createTime: '2024-12-24 11:15:00',
        status: 'Low Battery Offline'
      },
      {
        deviceSN: 'T8030P2324A00005',
        deviceName: 'Smart Display E10',
        account: 'bob.brown@example.com',
        firmwareVersion: 'v1.9.3',
        createTime: '2024-12-23 08:20:00',
        status: 'Online'
      },
      {
        deviceSN: 'T8030P2324A00006',
        deviceName: 'Entry Sensor E20',
        account: 'mary.jones@example.com',
        firmwareVersion: 'v1.2.0',
        createTime: '2024-12-22 13:50:00',
        status: 'Online'
      }
    ];

    let filteredDevices = [...maintenanceDevices];
    let currentStatusFilter = 'all';

    function filterByStatus(status) {
      currentStatusFilter = status;

      // Update active state of filter chips
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
        if (chip.dataset.status === status) {
          chip.classList.add('active');
        }
      });

      // Apply filters
      applyFilters();
    }

    function applyFilters() {
      const searchTerm = document.getElementById('maintenanceSearch').value.toLowerCase().trim();

      filteredDevices = maintenanceDevices.filter(device => {
        // Check search term
        const matchesSearch = !searchTerm ||
          device.deviceSN.toLowerCase().includes(searchTerm) ||
          device.account.toLowerCase().includes(searchTerm);

        // Check status filter
        const matchesStatus = currentStatusFilter === 'all' ||
          device.status === currentStatusFilter;

        return matchesSearch && matchesStatus;
      });

      // Always sort by create time (newest first)
      filteredDevices.sort((a, b) => new Date(b.createTime) - new Date(a.createTime));

      renderMaintenanceDevices();
    }

    function getStatusColor(status) {
      const statusColors = {
        'Online': 'var(--color-success)',
        'Offline': 'var(--color-text-tertiary)',
        'Manual Offline': 'var(--color-warning)',
        'Low Battery Offline': 'var(--color-danger)'
      };
      return statusColors[status] || 'var(--color-text-secondary)';
    }

    function renderMaintenanceDevices() {
      const deviceList = document.getElementById('maintenanceDeviceList');

      if (filteredDevices.length === 0) {
        deviceList.innerHTML = `
          <div style="text-align: center; padding: var(--spacing-xxl) 0; color: var(--fg-tertiary);">
            <svg viewBox="0 0 1567 1024" xmlns="http://www.w3.org/2000/svg" width="120" height="120" style="margin: 0 auto var(--spacing-md);">
              <path d="M156.662278 699.758173h21.097186A10.444152 10.444152 0 0 1 187.994733 710.202325c0 5.765172-4.490985 10.444152-10.235269 10.444152H156.662278v21.097186A10.444152 10.444152 0 0 1 146.218126 751.978932a10.277045 10.277045 0 0 1-10.444152-10.235269V720.646477H114.676787A10.444152 10.444152 0 0 1 104.441518 710.202325c0-5.765172 4.490985-10.444152 10.235269-10.444152H135.773974v-21.097187A10.444152 10.444152 0 0 1 146.218126 668.425717c5.765172 0 10.444152 4.490985 10.444152 10.235269v21.097187z m1378.628042-83.553215v-21.097186A10.277045 10.277045 0 0 0 1524.846168 584.872503a10.444152 10.444152 0 0 0-10.444152 10.235269v21.097186h-21.097186a10.277045 10.277045 0 0 0-10.235269 10.444152c0 5.598065 4.595427 10.444152 10.235269 10.444152h21.097186v21.097187c0 5.744284 4.67898 10.235269 10.444152 10.235268a10.444152 10.444152 0 0 0 10.444152-10.235268V637.093262h21.097187c5.744284 0 10.235269-4.67898 10.235268-10.444152a10.444152 10.444152 0 0 0-10.235268-10.444152H1535.29032zM776.460024 960.861969H250.596979A20.80475 20.80475 0 0 1 229.77134 939.973665c0-11.530344 9.462402-20.888304 20.825639-20.888303h94.728457A83.010119 83.010119 0 0 1 334.212859 877.413196v-605.96969A83.49055 83.49055 0 0 1 417.849627 187.994733H480.430984V167.001988A83.49055 83.49055 0 0 1 564.067752 83.553215h501.152182A83.448773 83.448773 0 0 1 1148.856702 167.001988v605.969689c0 15.185797-4.052331 29.410732-11.133466 41.672166h115.554096c11.551232 0 20.909192 9.274407 20.909192 20.888304 0 11.530344-9.295295 20.888304-20.888304 20.888304H1002.638576v20.992745c0 15.185797-4.052331 29.410732-11.133466 41.672166h11.196131c11.488567 0 20.825639 9.274407 20.825639 20.888303 0 11.530344-9.462402 20.888304-20.825639 20.888304h-109.893365c9.545955 16.000441 7.478013 36.972297-6.41271 50.863019a41.672166 41.672166 0 0 1-59.072122 0L776.460024 960.861969z m76.367638-41.776607h66.424806c22.977134 0 41.609501-18.59059 41.609501-41.881049V270.461756c0-22.559368-18.047494-40.690416-40.314426-40.690416H416.303892c-22.266932 0-40.314426 18.214601-40.314426 40.690416v606.742557c0 23.123352 18.799473 41.881049 41.588613 41.881049h317.084449l-10.736588-10.757477a41.693054 41.693054 0 0 1-10.861918-40.377091l-19.718558-19.739447A146.259902 146.259902 0 0 1 502.363703 627.693525a146.218126 146.218126 0 0 1 220.517822 190.981761l19.739447 19.739447a41.630389 41.630389 0 0 1 40.377091 10.841029L852.827662 919.085362zM1002.638576 814.643843h62.852906A41.797496 41.797496 0 0 0 1107.080095 772.867236V167.106429c0-23.14424-18.632367-41.776607-41.588613-41.776607H563.775316A41.797496 41.797496 0 0 0 522.207592 167.106429v20.888304h396.794216A83.448773 83.448773 0 0 1 1002.638576 271.443506V814.643843zM266.325872 46.998683h31.123572c8.773088 0 15.875111 6.955805 15.875111 15.666228 0 8.647758-7.102023 15.666228-15.875111 15.666228h-31.123572v31.123572c0 8.773088-6.955805 15.875111-15.666228 15.875111a15.770669 15.770669 0 0 1-15.666228-15.875111V78.331139H203.869844A15.728893 15.728893 0 0 1 187.994733 62.664911c0-8.647758 7.102023-15.666228 15.875111-15.666228h31.123572V15.875111c0-8.773088 6.955805-15.875111 15.666228-15.875111 8.647758 0 15.666228 7.102023 15.666228 15.875111v31.123572zM20.888304 939.973665c0-11.530344 9.462402-20.888304 20.825638-20.888303h125.455152c11.488567 0 20.825639 9.274407 20.825639 20.888303 0 11.530344-9.462402 20.888304-20.825639 20.888304H41.713942A20.80475 20.80475 0 0 1 20.888304 939.973665z m658.733544-135.021995a104.441518 104.441518 0 1 0-147.722083-147.722083 104.441518 104.441518 0 0 0 147.722083 147.722083zM459.542681 313.324555a20.888304 20.888304 0 0 1 20.867415-20.888304H710.202325a20.888304 20.888304 0 1 1 0 41.776608H480.430984A20.825639 20.825639 0 0 1 459.542681 313.324555z m0 104.441518c0-11.530344 9.295295-20.888304 20.742085-20.888303h334.505295c11.44679 0 20.742086 9.274407 20.742086 20.888303 0 11.530344-9.295295 20.888304-20.742086 20.888304H480.284766A20.762974 20.762974 0 0 1 459.542681 417.766073z m0 104.441519c0-11.530344 9.316183-20.888304 20.846527-20.888304h146.301679c11.509455 0 20.846527 9.274407 20.846527 20.888304 0 11.530344-9.316183 20.888304-20.846527 20.888303h-146.301679A20.80475 20.80475 0 0 1 459.542681 522.207592zM62.664911 396.87777a62.664911 62.664911 0 1 1 0-125.329822 62.664911 62.664911 0 0 1 0 125.329822z m0-31.332456a31.332456 31.332456 0 1 0 0-62.664911 31.332456 31.332456 0 0 0 0 62.664911zM1357.739739 271.547948a62.664911 62.664911 0 1 1 0-125.329822 62.664911 62.664911 0 0 1 0 125.329822z m0-31.332456a31.332456 31.332456 0 1 0 0-62.664911 31.332456 31.332456 0 0 0 0 62.664911z" fill="#cdcdcd"></path>
            </svg>
            <div style="font-size: var(--font-body);">No Data</div>
          </div>
        `;
        return;
      }

      deviceList.innerHTML = filteredDevices.map((device, index) => `
        <div class="card" style="margin-bottom: var(--spacing-sm); padding: var(--ref-padding-m);">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-xs);">
            <div style="flex: 1;">
              <div style="font-size: var(--font-title1); font-weight: var(--font-weight-semibold); color: var(--color-text-primary); margin-bottom: 2px;">${device.deviceSN}</div>
              <div style="font-size: var(--font-caption2); color: var(--color-text-secondary);">${device.deviceName}</div>
            </div>
            <div style="font-size: var(--font-caption1); font-weight: var(--font-weight-semibold); color: ${getStatusColor(device.status)}; white-space: nowrap;">
              ${device.status}
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-xs); margin-top: var(--spacing-sm); padding-top: var(--spacing-sm); border-top: 1px solid var(--color-border-secondary);">
            <div>
              <div style="font-size: var(--font-caption1); color: var(--color-text-secondary); margin-bottom: 2px;">Account</div>
              <div style="font-size: var(--font-caption2); color: var(--color-text-primary); word-break: break-all;">${device.account}</div>
            </div>
            <div>
              <div style="font-size: var(--font-caption1); color: var(--color-text-secondary); margin-bottom: 2px;">Firmware</div>
              <div style="font-size: var(--font-caption2); color: var(--color-text-primary);">${device.firmwareVersion}</div>
            </div>
            <div style="grid-column: 1 / -1;">
              <div style="font-size: var(--font-caption1); color: var(--color-text-secondary); margin-bottom: 2px;">Register Time</div>
              <div style="font-size: var(--font-caption2); color: var(--color-text-primary);">${device.createTime}</div>
            </div>
          </div>

          <div style="margin-top: var(--spacing-sm);">
            <button class="btn btn-secondary" onclick="confirmDeleteDevice(${index})" style="width: 100%; font-size: var(--font-caption2); height: 32px;">
              Remove
            </button>
          </div>
        </div>
      `).join('');
    }

    function filterMaintenanceDevices() {
      applyFilters();
    }

    // Initialize Maintenance Page
    function initMaintenancePage() {
      // Search input listener
      document.getElementById('maintenanceSearch').addEventListener('input', filterMaintenanceDevices);

      // Initial render
      filterMaintenanceDevices();
    }

    // Delete Device Functions
    window.confirmDeleteDevice = function(filteredIndex) {
      const device = filteredDevices[filteredIndex];

      // Find the original index in maintenanceDevices array
      const originalIndex = maintenanceDevices.findIndex(d => d.deviceSN === device.deviceSN);

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'deleteDeviceModal';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-body">
            <div class="modal-title">Confirm Remove</div>
            <div class="modal-description">Are you sure you want to remove device <strong>${device.deviceSN}</strong> from your company?</div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
            <button class="btn btn-danger" onclick="executeDeleteDevice(${originalIndex})">Remove</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };

    window.executeDeleteDevice = function(originalIndex) {
      // Remove device from maintenanceDevices array
      maintenanceDevices.splice(originalIndex, 1);

      // Close modal
      document.getElementById('deleteDeviceModal')?.remove();

      // Show success message
      utils.showToast('Device unbound successfully', 'success');

      // Re-apply filters and re-render
      applyFilters();
      renderMaintenanceDevices();
    };

    // Device Registration Functions
    let html5QrcodeScanner = null;
    let currentScanTarget = null;

    window.scanDeviceSN = function() {
      openScannerModal('deviceSN');
    };

    window.openScannerModal = function(targetInputId) {
      currentScanTarget = targetInputId;
      const modal = document.getElementById('scannerModal');
      modal.classList.add('active');

      // Start scanner after a short delay to ensure modal is visible
      setTimeout(() => {
        startScanner();
      }, 300);
    };

    window.closeScannerModal = function() {
      stopScanner();
      const modal = document.getElementById('scannerModal');
      modal.classList.remove('active');
      currentScanTarget = null;
    };

    function startScanner() {
      if (html5QrcodeScanner) {
        stopScanner();
      }

      html5QrcodeScanner = new Html5Qrcode("qr-reader");

      const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0,
        formatsToSupport: [
          Html5QrcodeSupportedFormats.QR_CODE,
          Html5QrcodeSupportedFormats.CODE_128,
          Html5QrcodeSupportedFormats.CODE_39,
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.EAN_8,
          Html5QrcodeSupportedFormats.UPC_A,
          Html5QrcodeSupportedFormats.UPC_E
        ]
      };

      html5QrcodeScanner.start(
        { facingMode: "environment" },
        config,
        (decodedText, decodedResult) => {
          // Success callback
          if (currentScanTarget) {
            const inputElement = document.getElementById(currentScanTarget);
            if (inputElement) {
              inputElement.value = decodedText;
              utils.showToast('SN scanned successfully!', 'success');
              closeScannerModal();
            }
          }
        },
        (errorMessage) => {
          // Error callback - we can ignore this as it fires constantly while scanning
        }
      ).catch(err => {
        console.error('Unable to start scanner:', err);
        utils.showToast('Unable to access camera. Please check permissions.', 'error');
        closeScannerModal();
      });
    }

    function stopScanner() {
      if (html5QrcodeScanner) {
        try {
          html5QrcodeScanner.stop().then(() => {
            html5QrcodeScanner.clear();
            html5QrcodeScanner = null;
          }).catch(err => {
            console.error('Error stopping scanner:', err);
            html5QrcodeScanner = null;
          });
        } catch (err) {
          console.error('Error stopping scanner:', err);
          html5QrcodeScanner = null;
        }
      }
    }

    window.manualInputSN = function() {
      closeScannerModal();
      const sn = prompt('Enter 16-digit SN code:');
      if (sn && utils.isValidSN(sn)) {
        if (currentScanTarget) {
          const inputElement = document.getElementById(currentScanTarget);
          if (inputElement) {
            inputElement.value = sn;
            utils.showToast('SN entered successfully!', 'success');
          }
        }
      } else if (sn) {
        utils.showToast('Invalid SN code format', 'error');
      }
    };

    window.submitDeviceRegistration = async function(event) {
      event.preventDefault();

      const deviceSN = document.getElementById('deviceSN').value;
      const userAccount = document.getElementById('userAccount').value;

      // Validation for Device SN
      if (!deviceSN) {
        utils.showToast('Please enter Device SN', 'error');
        return;
      }

      if (!utils.isValidSN(deviceSN)) {
        utils.showToast('Device SN must be 16 characters', 'error');
        return;
      }

      // Validation for User Account
      if (!userAccount) {
        utils.showToast('Please enter User Account', 'error');
        return;
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(userAccount)) {
        utils.showToast('Please enter a valid email address', 'error');
        return;
      }

      // Simulate submission directly without confirmation
      const submitBtn = event.target.querySelector('button[type="submit"]');
      const hideLoading = utils.showLoading(submitBtn);

      setTimeout(() => {
        hideLoading();

        // Simulate backend validation: check if device exists under this user account
        const deviceExistsForUser = false; // Mock result

        if (deviceExistsForUser) {
          utils.showToast('This device already exists under this user account', 'error');
          return;
        }

        utils.showToast('Device registered successfully!', 'success');

        // Clear only Device SN field, keep User Account field
        document.getElementById('deviceSN').value = '';
        // User Account field is intentionally NOT cleared to facilitate multiple device submissions
      }, 800);
    };

    // Submit service subscription form
    window.submitServiceSubscription = async function(event) {
      event.preventDefault();

      const servicePlan = document.getElementById('servicePlan').value;
      const serviceDeviceSN = document.getElementById('serviceDeviceSN').value;
      const serviceUserAccount = document.getElementById('serviceUserAccount').value;

      // Validation for Service Plan
      if (!servicePlan) {
        utils.showToast('Please select a service package', 'error');
        return;
      }

      // Validation for Device SN
      if (!serviceDeviceSN) {
        utils.showToast('Please enter Device SN', 'error');
        return;
      }

      if (!utils.isValidSN(serviceDeviceSN)) {
        utils.showToast('Device SN must be 16 characters', 'error');
        return;
      }

      // Validation for User Account
      if (!serviceUserAccount) {
        utils.showToast('Please enter User Account', 'error');
        return;
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(serviceUserAccount)) {
        utils.showToast('Please enter a valid email address', 'error');
        return;
      }

      // Show confirmation dialog
      const packageName = servicePlan === 'basic' ? 'Basic Plan' : 'Plus Plan';
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-body">
            <div class="modal-title">Confirm Service Subscription</div>
            <div class="modal-description">Subscribe <strong>${packageName}</strong> for device <strong>${serviceDeviceSN}</strong> under account <strong>${serviceUserAccount}</strong>?</div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmServiceSubscription('${servicePlan}', '${serviceDeviceSN}', '${serviceUserAccount}')">Confirm</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };

    // Confirm service subscription
    window.confirmServiceSubscription = function(servicePlan, serviceDeviceSN, serviceUserAccount) {
      // Close modal
      document.querySelector('.modal-overlay').remove();

      // Simulate submission with loading state
      const submitBtn = document.querySelector('#serviceSubscriptionForm button[type="submit"]');
      const hideLoading = utils.showLoading(submitBtn);

      setTimeout(() => {
        hideLoading();

        const packageName = servicePlan === 'basic' ? 'Basic Plan' : 'Plus Plan';
        utils.showToast(`${packageName} subscribed successfully!`, 'success');

        // Clear Device SN and reset to Basic Plan, keep User Account for multiple subscriptions
        document.getElementById('servicePlan').value = 'basic';
        document.getElementById('serviceDeviceSN').value = '';
        // User Account field is intentionally NOT cleared to facilitate multiple service subscriptions
      }, 800);
    };

    // Scan device SN for service subscription
    window.scanServiceDeviceSN = function() {
      openScannerModal('serviceDeviceSN');
    };

    // ========================================
    // Payment Account Functions
    // ========================================
    let paymentAccount = null;

    window.showPaymentAccount = function() {
      // Hide profile main view
      document.getElementById('profileMainView').classList.add('hidden');
      document.getElementById('profileContent').classList.add('hidden');
      document.getElementById('paymentAccountView').classList.remove('hidden');

      // Update navbar
      const navbarTitle = document.getElementById('navbarTitle');
      navbarTitle.textContent = 'Payment Account';
      const navbarBack = document.querySelector('#mainAppView .navbar-back');
      navbarBack.innerHTML = '<span style="cursor: pointer; color: var(--brand-fg-primary);" onclick="hidePaymentAccount()">‹ Back</span>';

      // Hide bottom tabbar (secondary page)
      hideBottomTabbar();

      // Check if payment account exists
      if (paymentAccount) {
        document.getElementById('paymentEmptyState').classList.add('hidden');
        document.getElementById('paymentAccountInfo').classList.remove('hidden');
        document.getElementById('cardLast4').textContent = paymentAccount.last4;
        document.getElementById('cardExpiry').textContent = paymentAccount.expiry;
      } else {
        document.getElementById('paymentEmptyState').classList.remove('hidden');
        document.getElementById('paymentAccountInfo').classList.add('hidden');
      }
    };

    window.hidePaymentAccount = function() {
      document.getElementById('paymentAccountView').classList.add('hidden');
      document.getElementById('profileContent').classList.remove('hidden');
      document.getElementById('profileMainView').classList.remove('hidden');

      // Reset navbar
      const navbarTitle = document.getElementById('navbarTitle');
      navbarTitle.textContent = 'Profile';
      const navbarBack = document.querySelector('#mainAppView .navbar-back');
      navbarBack.innerHTML = '';

      // Show bottom tabbar (back to primary page)
      showBottomTabbar();
    };

    window.showAddPaymentModal = function() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-body">
            <div class="modal-title">Add Payment Account</div>
            <div class="form-group">
              <label class="form-label form-label-required">Card Number</label>
              <input type="text" class="form-input" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
            </div>
            <div class="form-group">
              <label class="form-label form-label-required">Expiry Date</label>
              <input type="text" class="form-input" id="expiryDate" placeholder="MM/YY" maxlength="5">
            </div>
            <div class="form-group">
              <label class="form-label form-label-required">CVV</label>
              <input type="text" class="form-input" id="cvv" placeholder="123" maxlength="3">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
            <button class="btn btn-primary" onclick="submitPaymentAccount(event)">Submit</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Format card number input
      document.getElementById('cardNumber').addEventListener('input', (e) => {
        let value = e.target.value.replace(/\s/g, '');
        let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formatted;
      });

      // Format expiry date input
      document.getElementById('expiryDate').addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
          value = value.slice(0, 2) + '/' + value.slice(2, 4);
        }
        e.target.value = value;
      });

      // Only allow digits for CVV
      document.getElementById('cvv').addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/\D/g, '');
      });
    };

    window.submitPaymentAccount = async function(event) {
      const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
      const expiryDate = document.getElementById('expiryDate').value;
      const cvv = document.getElementById('cvv').value;

      // Validation
      if (!cardNumber || cardNumber.length !== 16) {
        utils.showToast('Please enter valid 16-digit card number', 'error');
        return;
      }

      if (!expiryDate || expiryDate.length !== 5) {
        utils.showToast('Please enter valid expiry date (MM/YY)', 'error');
        return;
      }

      if (!cvv || cvv.length !== 3) {
        utils.showToast('Please enter valid 3-digit CVV', 'error');
        return;
      }

      // Validate expiry date format
      const [month, year] = expiryDate.split('/');
      if (parseInt(month) < 1 || parseInt(month) > 12) {
        utils.showToast('Invalid month in expiry date', 'error');
        return;
      }

      // Simulate submission
      const submitBtn = event.target;
      const hideLoading = utils.showLoading(submitBtn);

      setTimeout(() => {
        hideLoading();

        // Save payment account
        paymentAccount = {
          last4: cardNumber.slice(-4),
          expiry: expiryDate
        };

        utils.showToast('Payment account added successfully!', 'success');
        document.querySelector('.modal-overlay').remove();

        // Refresh view
        showPaymentAccount();
      }, 1000);
    };

    // ========================================
    // Billing History Functions
    // ========================================
    window.showBillingHistory = function() {
      // Hide profile main view
      document.getElementById('profileMainView').classList.add('hidden');
      document.getElementById('profileContent').classList.add('hidden');
      document.getElementById('billingHistoryView').classList.remove('hidden');

      // Update navbar
      const navbarTitle = document.getElementById('navbarTitle');
      navbarTitle.textContent = 'Billing History';
      const navbarBack = document.querySelector('#mainAppView .navbar-back');
      navbarBack.innerHTML = '<span style="cursor: pointer; color: var(--brand-fg-primary);" onclick="hideBillingHistory()">‹ Back</span>';

      // Hide bottom tabbar (secondary page)
      hideBottomTabbar();

      loadBillingHistory();
    };

    window.hideBillingHistory = function() {
      document.getElementById('billingHistoryView').classList.add('hidden');
      document.getElementById('profileContent').classList.remove('hidden');
      document.getElementById('profileMainView').classList.remove('hidden');

      // Reset navbar
      const navbarTitle = document.getElementById('navbarTitle');
      navbarTitle.textContent = 'Profile';
      const navbarBack = document.querySelector('#mainAppView .navbar-back');
      navbarBack.innerHTML = '';

      // Show bottom tabbar (back to primary page)
      showBottomTabbar();
    };

    window.loadBillingHistory = function() {
      const selectedMonth = document.getElementById('billingMonthSelect').value;
      const billingList = document.getElementById('billingList');

      // Mock billing data (only Basic Plan and Plus Plan services)
      const allBillings = {
        '2026-01': [
          { name: 'Plus Plan - January', amount: 19.99, date: '2026-01-01', type: 'subscription' },
          { name: 'Basic Plan - January', amount: 9.99, date: '2026-01-01', type: 'subscription' },
          { name: 'Plus Plan - Device 1', amount: 19.99, date: '2026-01-05', type: 'subscription' },
          { name: 'Basic Plan - Device 2', amount: 9.99, date: '2026-01-08', type: 'subscription' },
          { name: 'Plus Plan - Device 3', amount: 19.99, date: '2026-01-12', type: 'subscription' },
          { name: 'Basic Plan - Device 4', amount: 9.99, date: '2026-01-15', type: 'subscription' },
          { name: 'Plus Plan - Device 5', amount: 19.99, date: '2026-01-18', type: 'subscription' },
          { name: 'Basic Plan - Device 6', amount: 9.99, date: '2026-01-22', type: 'subscription' },
          { name: 'Plus Plan - Device 7', amount: 19.99, date: '2026-01-25', type: 'subscription' },
          { name: 'Basic Plan - Device 8', amount: 9.99, date: '2026-01-28', type: 'subscription' }
        ],
        '2025-12': [
          { name: 'Plus Plan - December', amount: 19.99, date: '2025-12-01', type: 'subscription' },
          { name: 'Basic Plan - December', amount: 9.99, date: '2025-12-01', type: 'subscription' }
        ],
        '2025-11': [
          { name: 'Plus Plan - November', amount: 19.99, date: '2025-11-01', type: 'subscription' }
        ],
        '2025-10': [
          { name: 'Basic Plan - October', amount: 9.99, date: '2025-10-01', type: 'subscription' }
        ],
        '2025-09': []
      };

      const billings = allBillings[selectedMonth] || [];

      // Sort by date descending (newest first)
      billings.sort((a, b) => new Date(b.date) - new Date(a.date));

      const total = billings.reduce((sum, bill) => sum + bill.amount, 0);

      // Update total
      document.getElementById('monthlyTotal').textContent = `$${total.toFixed(2)}`;

      // Render billing list
      if (billings.length === 0) {
        billingList.innerHTML = `
          <div style="text-align: center; padding: var(--spacing-xxl) 0; color: var(--fg-tertiary);">
            <svg viewBox="0 0 1567 1024" xmlns="http://www.w3.org/2000/svg" width="120" height="120" style="margin: 0 auto var(--spacing-md);">
              <path d="M156.662278 699.758173h21.097186A10.444152 10.444152 0 0 1 187.994733 710.202325c0 5.765172-4.490985 10.444152-10.235269 10.444152H156.662278v21.097186A10.444152 10.444152 0 0 1 146.218126 751.978932a10.277045 10.277045 0 0 1-10.444152-10.235269V720.646477H114.676787A10.444152 10.444152 0 0 1 104.441518 710.202325c0-5.765172 4.490985-10.444152 10.235269-10.444152H135.773974v-21.097187A10.444152 10.444152 0 0 1 146.218126 668.425717c5.765172 0 10.444152 4.490985 10.444152 10.235269v21.097187z m1378.628042-83.553215v-21.097186A10.277045 10.277045 0 0 0 1524.846168 584.872503a10.444152 10.444152 0 0 0-10.444152 10.235269v21.097186h-21.097186a10.277045 10.277045 0 0 0-10.235269 10.444152c0 5.598065 4.595427 10.444152 10.235269 10.444152h21.097186v21.097187c0 5.744284 4.67898 10.235269 10.444152 10.235268a10.444152 10.444152 0 0 0 10.444152-10.235268V637.093262h21.097187c5.744284 0 10.235269-4.67898 10.235268-10.444152a10.444152 10.444152 0 0 0-10.235268-10.444152H1535.29032zM776.460024 960.861969H250.596979A20.80475 20.80475 0 0 1 229.77134 939.973665c0-11.530344 9.462402-20.888304 20.825639-20.888303h94.728457A83.010119 83.010119 0 0 1 334.212859 877.413196v-605.96969A83.49055 83.49055 0 0 1 417.849627 187.994733H480.430984V167.001988A83.49055 83.49055 0 0 1 564.067752 83.553215h501.152182A83.448773 83.448773 0 0 1 1148.856702 167.001988v605.969689c0 15.185797-4.052331 29.410732-11.133466 41.672166h115.554096c11.551232 0 20.909192 9.274407 20.909192 20.888304 0 11.530344-9.295295 20.888304-20.888304 20.888304H1002.638576v20.992745c0 15.185797-4.052331 29.410732-11.133466 41.672166h11.196131c11.488567 0 20.825639 9.274407 20.825639 20.888303 0 11.530344-9.462402 20.888304-20.825639 20.888304h-109.893365c9.545955 16.000441 7.478013 36.972297-6.41271 50.863019a41.672166 41.672166 0 0 1-59.072122 0L776.460024 960.861969z m76.367638-41.776607h66.424806c22.977134 0 41.609501-18.59059 41.609501-41.881049V270.461756c0-22.559368-18.047494-40.690416-40.314426-40.690416H416.303892c-22.266932 0-40.314426 18.214601-40.314426 40.690416v606.742557c0 23.123352 18.799473 41.881049 41.588613 41.881049h317.084449l-10.736588-10.757477a41.693054 41.693054 0 0 1-10.861918-40.377091l-19.718558-19.739447A146.259902 146.259902 0 0 1 502.363703 627.693525a146.218126 146.218126 0 0 1 220.517822 190.981761l19.739447 19.739447a41.630389 41.630389 0 0 1 40.377091 10.841029L852.827662 919.085362zM1002.638576 814.643843h62.852906A41.797496 41.797496 0 0 0 1107.080095 772.867236V167.106429c0-23.14424-18.632367-41.776607-41.588613-41.776607H563.775316A41.797496 41.797496 0 0 0 522.207592 167.106429v20.888304h396.794216A83.448773 83.448773 0 0 1 1002.638576 271.443506V814.643843zM266.325872 46.998683h31.123572c8.773088 0 15.875111 6.955805 15.875111 15.666228 0 8.647758-7.102023 15.666228-15.875111 15.666228h-31.123572v31.123572c0 8.773088-6.955805 15.875111-15.666228 15.875111a15.770669 15.770669 0 0 1-15.666228-15.875111V78.331139H203.869844A15.728893 15.728893 0 0 1 187.994733 62.664911c0-8.647758 7.102023-15.666228 15.875111-15.666228h31.123572V15.875111c0-8.773088 6.955805-15.875111 15.666228-15.875111 8.647758 0 15.666228 7.102023 15.666228 15.875111v31.123572zM20.888304 939.973665c0-11.530344 9.462402-20.888304 20.825638-20.888303h125.455152c11.488567 0 20.825639 9.274407 20.825639 20.888303 0 11.530344-9.462402 20.888304-20.825639 20.888304H41.713942A20.80475 20.80475 0 0 1 20.888304 939.973665z m658.733544-135.021995a104.441518 104.441518 0 1 0-147.722083-147.722083 104.441518 104.441518 0 0 0 147.722083 147.722083zM459.542681 313.324555a20.888304 20.888304 0 0 1 20.867415-20.888304H710.202325a20.888304 20.888304 0 1 1 0 41.776608H480.430984A20.825639 20.825639 0 0 1 459.542681 313.324555z m0 104.441518c0-11.530344 9.295295-20.888304 20.742085-20.888303h334.505295c11.44679 0 20.742086 9.274407 20.742086 20.888303 0 11.530344-9.295295 20.888304-20.742086 20.888304H480.284766A20.762974 20.762974 0 0 1 459.542681 417.766073z m0 104.441519c0-11.530344 9.316183-20.888304 20.846527-20.888304h146.301679c11.509455 0 20.846527 9.274407 20.846527 20.888304 0 11.530344-9.316183 20.888304-20.846527 20.888303h-146.301679A20.80475 20.80475 0 0 1 459.542681 522.207592zM62.664911 396.87777a62.664911 62.664911 0 1 1 0-125.329822 62.664911 62.664911 0 0 1 0 125.329822z m0-31.332456a31.332456 31.332456 0 1 0 0-62.664911 31.332456 31.332456 0 0 0 0 62.664911zM1357.739739 271.547948a62.664911 62.664911 0 1 1 0-125.329822 62.664911 62.664911 0 0 1 0 125.329822z m0-31.332456a31.332456 31.332456 0 1 0 0-62.664911 31.332456 31.332456 0 0 0 0 62.664911z" fill="#cdcdcd"></path>
            </svg>
            <div style="font-size: var(--font-body);">No Data</div>
          </div>
        `;
      } else {
        billingList.innerHTML = billings.map(bill => `
          <div class="card" style="margin-bottom: var(--spacing-sm);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-md);">
              <div style="flex: 1;">
                <div style="font-size: var(--font-body); font-weight: var(--font-weight-semibold); color: var(--fg-primary); margin-bottom: 4px;">${bill.name}</div>
                <div style="font-size: var(--font-caption2); color: var(--fg-secondary);">${bill.date}</div>
              </div>
              <div style="font-size: var(--font-title2); font-weight: var(--font-weight-bold); color: var(--brand-fg-primary);">$${bill.amount.toFixed(2)}</div>
            </div>
            <button class="btn btn-secondary" style="width: 100%; font-size: var(--font-caption2); height: 36px;" onclick="viewBillingInvoice('${bill.name}', ${bill.amount}, '${bill.date}')">View Invoice</button>
          </div>
        `).join('');
      }
    };

    // Helper function to download invoice with loading state
    window.downloadInvoiceWithLoading = function(button) {
      const modal = button.closest('.modal-overlay');
      const downloadBtn = button;
      const closeBtn = modal.querySelector('.btn-secondary');

      // Disable both buttons and show loading state
      downloadBtn.disabled = true;
      closeBtn.disabled = true;
      downloadBtn.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 8px;"><svg width="16" height="16" viewBox="0 0 16 16" style="animation: spin 1s linear infinite;"><circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="31.4" stroke-dashoffset="0" style="animation: dash 1.5s ease-in-out infinite;"/></svg>Downloading...</span>';

      // Simulate download process
      setTimeout(() => {
        modal.remove();
        utils.showToast('Invoice downloaded successfully', 'success');
      }, 1800); // 1.8 seconds for realistic feel
    };

    window.viewBillingInvoice = function(name, amount, date) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-body">
            <div class="modal-title">Invoice Details</div>
            <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background-color: var(--bg-secondary); border-radius: var(--ref-radius-m);">
              <div style="font-size: var(--font-body); color: var(--fg-secondary); margin-bottom: 4px;">Service</div>
              <div style="font-size: var(--font-title2); font-weight: var(--font-weight-semibold); color: var(--fg-primary); margin-bottom: var(--spacing-md);">${name}</div>
              <div style="font-size: var(--font-body); color: var(--fg-secondary); margin-bottom: 4px;">Date</div>
              <div style="font-size: var(--font-title3); color: var(--fg-primary); margin-bottom: var(--spacing-md);">${date}</div>
              <div style="font-size: var(--font-body); color: var(--fg-secondary); margin-bottom: 4px;">Amount</div>
              <div style="font-size: var(--font-display1); font-weight: var(--font-weight-bold); color: var(--brand-fg-primary);">$${amount.toFixed(2)}</div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
            <button class="btn btn-primary" onclick="downloadInvoiceWithLoading(this)">Download</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };

    window.logout = function() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'logoutConfirmModal'; // Add unique ID
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-body">
            <div class="modal-title">Confirm Logout</div>
            <div class="modal-description">Are you sure you want to logout?</div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmLogout()">Logout</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };

    window.confirmLogout = function() {
      localStorage.removeItem('user');

      // Reset all views to initial state
      // Hide all secondary pages
      document.getElementById('paymentAccountView')?.classList.add('hidden');
      document.getElementById('billingHistoryView')?.classList.add('hidden');
      document.getElementById('systemUpdateView')?.classList.add('hidden');
      document.getElementById('productDetailView')?.classList.add('hidden');
      document.getElementById('attachmentViewer')?.classList.add('hidden');
      document.getElementById('subscriptionManagement')?.classList.add('hidden');
      document.getElementById('maintenanceDetail')?.classList.add('hidden');

      // Show main views
      document.getElementById('profileMainView')?.classList.remove('hidden');
      document.getElementById('profileContent')?.classList.remove('hidden');
      document.getElementById('productsContent')?.classList.remove('hidden');

      // Reset navbar
      document.getElementById('navbarTitle').textContent = 'Home';
      document.querySelector('#mainAppView .navbar-back').innerHTML = '';

      // Hide main app, show login view
      document.getElementById('mainAppView').classList.add('hidden');
      document.getElementById('loginView').classList.remove('hidden');

      // Clear login form
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';

      // Reset company selection modal
      document.getElementById('companySelectionModal')?.classList.add('hidden');
      // Reset company selection to default
      selectedCompany = 'companyA';
      document.querySelectorAll('.company-option').forEach((option, index) => {
        if (index === 0) {
          option.classList.add('selected');
        } else {
          option.classList.remove('selected');
        }
      });

      // Close logout confirm modal
      document.getElementById('logoutConfirmModal')?.remove();

      utils.showToast('Logout successful', 'success');
    };

    // System Update Functions
    window.showSystemUpdate = function() {
      document.getElementById('profileMainView').classList.add('hidden');
      document.getElementById('systemUpdateView').classList.remove('hidden');

      // Update navbar
      document.getElementById('navbarTitle').textContent = 'System Update';
      document.querySelector('#mainAppView .navbar-back').innerHTML = '<span onclick="hideSystemUpdate()" style="cursor: pointer; color: var(--brand-fg-primary);">‹ Back</span>';

      // Hide bottom tabbar (secondary page)
      hideBottomTabbar();
    };

    window.hideSystemUpdate = function() {
      document.getElementById('systemUpdateView').classList.add('hidden');
      document.getElementById('profileMainView').classList.remove('hidden');

      // Reset navbar
      document.getElementById('navbarTitle').textContent = 'Profile';
      document.querySelector('#mainAppView .navbar-back').innerHTML = '';

      // Show bottom tabbar (back to primary page)
      showBottomTabbar();
    };

    window.performSystemUpdate = async function() {
      const updateBtn = event.target;
      const hideLoading = utils.showLoading(updateBtn);

      setTimeout(() => {
        hideLoading();
        utils.showToast('System updated successfully!', 'success');

        // Update version
        document.getElementById('currentVersion').textContent = 'v1.2.0';
        document.getElementById('currentVersionDetail').textContent = 'v1.2.0';
        document.getElementById('updateBadge').classList.add('hidden');

        // Hide update view
        setTimeout(() => {
          hideSystemUpdate();
        }, 500);
      }, 2000);
    };

    // Check for updates on page load
    function checkForUpdates() {
      const currentVersion = '1.0.0';
      const latestVersion = '1.2.0';

      if (latestVersion > currentVersion) {
        document.getElementById('updateBadge').classList.remove('hidden');
      }
    }

    // Load initial content
    checkForUpdates();
    initMaintenancePage();

    // Login Functionality
    // Password toggle
    const passwordInput = document.getElementById('loginPassword');
    const toggleBtn = document.getElementById('togglePassword');

    if (toggleBtn && passwordInput) {
      toggleBtn.addEventListener('click', () => {
        const type = passwordInput.type === 'password' ? 'text' : 'password';
        passwordInput.type = type;

        // Toggle icon between eye and eye-off
        if (type === 'password') {
          // Password is hidden, show eye-off icon
          toggleBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>';
        } else {
          // Password is visible, show eye icon
          toggleBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
        }
      });
    }

    // Login submission
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const loginBtn = document.getElementById('loginBtn');
        const hideLoading = utils.showLoading(loginBtn);

        // Simulate brief loading for better UX
        setTimeout(() => {
          hideLoading();

          // Show company selection modal
          setTimeout(() => {
            document.getElementById('companySelectionModal').classList.remove('hidden');
          }, 200);
        }, 300);
      });
    }

    // ============================================
    // Company Selection Functions
    // ============================================

    let selectedCompany = 'companyA'; // Default selection

    // Select company option
    window.selectCompany = function(companyId) {
      // Remove selected class from all options
      document.querySelectorAll('.company-option').forEach(option => {
        option.classList.remove('selected');
      });

      // Add selected class to clicked option
      event.currentTarget.classList.add('selected');

      // Store selected company
      selectedCompany = companyId;
    };

    // Confirm company selection and enter main app
    window.confirmCompanySelection = function() {
      // Store user session with selected company
      const email = document.getElementById('loginEmail').value;
      const companyName = selectedCompany === 'companyA' ? 'Company A' : 'Company B';
      localStorage.setItem('user', JSON.stringify({
        email,
        company: selectedCompany,
        companyName
      }));

      // Hide company selection modal
      document.getElementById('companySelectionModal').classList.add('hidden');

      // Hide login view
      document.getElementById('loginView').classList.add('hidden');

      // Show main app view
      document.getElementById('mainAppView').classList.remove('hidden');

      // Reset to Home tab
      const tabs = document.querySelectorAll('.tab-item');
      const homeTab = document.querySelector('.tab-item[data-tab="home"]');

      // Update active tab
      tabs.forEach(t => t.classList.remove('active'));
      homeTab.classList.add('active');

      // Show home content, hide others
      document.getElementById('homeContent').classList.remove('hidden');
      document.getElementById('productsContent').classList.add('hidden');
      document.getElementById('planContent').classList.add('hidden');
      document.getElementById('registerContent').classList.add('hidden');
      document.getElementById('profileContent').classList.add('hidden');

      // Update navbar title
      document.getElementById('navbarTitle').textContent = 'Home';

      // Show login success toast
      utils.showToast('Login successful', 'success');
    };

    // ============================================
    // Partner Application Functions
    // ============================================

    // Show partner application page
    window.showPartnerApplication = function() {
      document.getElementById('loginView').classList.add('hidden');
      document.getElementById('partnerApplicationView').classList.remove('hidden');
    };

    // Hide partner application page
    window.hidePartnerApplication = function() {
      document.getElementById('partnerApplicationView').classList.add('hidden');
      document.getElementById('loginView').classList.remove('hidden');
      // Reset form
      document.getElementById('partnerApplicationForm').reset();
      // Reset file previews
      resetFilePreview('businessLicensePreview');
      resetFilePreview('salesLicensePreview');
      resetFilePreview('insurancePreview');
      // Reset checkbox
      document.getElementById('termsCheckbox').disabled = true;
      document.getElementById('termsCheckbox').checked = false;
    };


    // Trigger file upload
    window.triggerFileUpload = function(inputId) {
      document.getElementById(inputId).click();
    };

    // Handle file selection
    window.handleFileSelect = function(input, previewId) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById(previewId);
          preview.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <div style="margin-top: var(--spacing-sm); color: var(--function-success); font-size: var(--font-caption2);">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 4px;">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              File uploaded
            </div>
          `;
        };
        reader.readAsDataURL(file);
      }
    };

    // Reset file preview
    function resetFilePreview(previewId) {
      const preview = document.getElementById(previewId);
      preview.innerHTML = `
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--fg-tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        <div style="margin-top: var(--spacing-sm); color: var(--fg-secondary); font-size: var(--font-caption2);">Tap to upload or take photo</div>
      `;
    }

    // Agreement reading state
    let agreementReadTime = 0;
    let agreementScrolledToBottom = false;

    // Show Agreement modal
    window.showAgreementModal = function() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'agreementModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-height: 80vh; display: flex; flex-direction: column;">
          <div style="padding: var(--ref-padding-l); border-bottom: 0.33px solid var(--fill-secondary);">
            <div class="modal-title">User Agreement</div>
          </div>

          <div id="agreementContent" style="flex: 1; overflow-y: auto; padding: var(--ref-padding-l); font-size: var(--font-caption1); color: var(--fg-secondary); line-height: 1.6;">
            <h3 style="font-size: var(--font-subheadline); font-weight: var(--font-weight-semibold); color: var(--fg-primary); margin-bottom: var(--spacing-sm); margin-top: 0;">Terms & Conditions</h3>

            <h4 style="font-size: var(--font-caption1); font-weight: var(--font-weight-medium); color: var(--fg-primary); margin-bottom: var(--spacing-xs); margin-top: var(--spacing-sm);">1. Acceptance of Terms</h4>
            <p style="margin-bottom: var(--spacing-sm); font-size: var(--font-caption2);">By accessing and using the Anker Partner platform, you agree to be bound by these Terms & Conditions and all applicable laws and regulations.</p>

            <h4 style="font-size: var(--font-caption1); font-weight: var(--font-weight-medium); color: var(--fg-primary); margin-bottom: var(--spacing-xs); margin-top: var(--spacing-sm);">2. Partner Eligibility</h4>
            <p style="margin-bottom: var(--spacing-sm); font-size: var(--font-caption2);">To become an Anker Partner, you must be a legally registered business entity with valid business licenses and insurance coverage as required by your jurisdiction.</p>

            <h4 style="font-size: var(--font-caption1); font-weight: var(--font-weight-medium); color: var(--fg-primary); margin-bottom: var(--spacing-xs); margin-top: var(--spacing-sm);">3. Services and Responsibilities</h4>
            <p style="margin-bottom: var(--spacing-sm); font-size: var(--font-caption2);">Partners are responsible for providing professional installation and maintenance services for Anker products. All services must meet our quality standards and customer service requirements.</p>

            <h4 style="font-size: var(--font-caption1); font-weight: var(--font-weight-medium); color: var(--fg-primary); margin-bottom: var(--spacing-xs); margin-top: var(--spacing-sm);">4. Payment Terms</h4>
            <p style="margin-bottom: var(--spacing-sm); font-size: var(--font-caption2);">Payment for services will be processed according to the agreed payment schedule. Partners must maintain accurate billing records and submit invoices in a timely manner.</p>

            <h4 style="font-size: var(--font-caption1); font-weight: var(--font-weight-medium); color: var(--fg-primary); margin-bottom: var(--spacing-xs); margin-top: var(--spacing-sm);">5. Insurance Requirements</h4>
            <p style="margin-bottom: var(--spacing-sm); font-size: var(--font-caption2);">Partners must maintain adequate liability insurance coverage throughout the partnership period. Proof of insurance must be provided and kept current.</p>

            <h4 style="font-size: var(--font-caption1); font-weight: var(--font-weight-medium); color: var(--fg-primary); margin-bottom: var(--spacing-xs); margin-top: var(--spacing-sm);">6. Termination</h4>
            <p style="margin-bottom: var(--spacing-sm); font-size: var(--font-caption2);">Either party may terminate this agreement with 30 days written notice. Anker reserves the right to terminate immediately for breach of terms.</p>

            <h4 style="font-size: var(--font-caption1); font-weight: var(--font-weight-medium); color: var(--fg-primary); margin-bottom: var(--spacing-xs); margin-top: var(--spacing-sm);">7. Confidentiality</h4>
            <p style="margin-bottom: var(--spacing-sm); font-size: var(--font-caption2);">Partners must maintain confidentiality of all proprietary information, customer data, and business practices shared during the partnership.</p>

            <h4 style="font-size: var(--font-caption1); font-weight: var(--font-weight-medium); color: var(--fg-primary); margin-bottom: var(--spacing-xs); margin-top: var(--spacing-sm);">8. Limitation of Liability</h4>
            <p style="margin-bottom: var(--spacing-sm); font-size: var(--font-caption2);">Anker shall not be liable for any indirect, incidental, special, or consequential damages arising from the partnership.</p>

            <h3 style="font-size: var(--font-subheadline); font-weight: var(--font-weight-semibold); color: var(--fg-primary); margin-bottom: var(--spacing-sm); margin-top: var(--spacing-md);">Privacy Policy</h3>

            <h4 style="font-size: var(--font-caption1); font-weight: var(--font-weight-medium); color: var(--fg-primary); margin-bottom: var(--spacing-xs); margin-top: var(--spacing-sm);">1. Information Collection</h4>
            <p style="margin-bottom: var(--spacing-sm); font-size: var(--font-caption2);">We collect information necessary to process your partner application, including business details, contact information, and required documentation.</p>

            <h4 style="font-size: var(--font-caption1); font-weight: var(--font-weight-medium); color: var(--fg-primary); margin-bottom: var(--spacing-xs); margin-top: var(--spacing-sm);">2. Use of Information</h4>
            <p style="margin-bottom: var(--spacing-sm); font-size: var(--font-caption2);">Your information is used to verify your eligibility as a partner, process applications, manage the partnership, and communicate important updates.</p>

            <h4 style="font-size: var(--font-caption1); font-weight: var(--font-weight-medium); color: var(--fg-primary); margin-bottom: var(--spacing-xs); margin-top: var(--spacing-sm);">3. Data Protection</h4>
            <p style="margin-bottom: var(--spacing-sm); font-size: var(--font-caption2);">We implement industry-standard security measures to protect your data from unauthorized access, disclosure, or misuse.</p>

            <h4 style="font-size: var(--font-caption1); font-weight: var(--font-weight-medium); color: var(--fg-primary); margin-bottom: var(--spacing-xs); margin-top: var(--spacing-sm);">4. Data Sharing</h4>
            <p style="margin-bottom: var(--spacing-sm); font-size: var(--font-caption2);">We do not sell or share your personal information with third parties except as required for partnership operations or by law.</p>

            <h4 style="font-size: var(--font-caption1); font-weight: var(--font-weight-medium); color: var(--fg-primary); margin-bottom: var(--spacing-xs); margin-top: var(--spacing-sm);">5. Customer Data</h4>
            <p style="margin-bottom: var(--spacing-sm); font-size: var(--font-caption2);">Partners who handle customer data through our platform must comply with all applicable privacy laws and our data protection requirements.</p>

            <h4 style="font-size: var(--font-caption1); font-weight: var(--font-weight-medium); color: var(--fg-primary); margin-bottom: var(--spacing-xs); margin-top: var(--spacing-sm);">6. Data Retention</h4>
            <p style="margin-bottom: var(--spacing-sm); font-size: var(--font-caption2);">We retain partner information for the duration of the partnership and as required by law or business purposes.</p>

            <h4 style="font-size: var(--font-caption1); font-weight: var(--font-weight-medium); color: var(--fg-primary); margin-bottom: var(--spacing-xs); margin-top: var(--spacing-sm);">7. Your Rights</h4>
            <p style="margin-bottom: var(--spacing-sm); font-size: var(--font-caption2);">You have the right to access, correct, or request deletion of your personal information, subject to legal and contractual obligations.</p>

            <h4 style="font-size: var(--font-caption1); font-weight: var(--font-weight-medium); color: var(--fg-primary); margin-bottom: var(--spacing-xs); margin-top: var(--spacing-sm);">8. Policy Updates</h4>
            <p style="margin-bottom: var(--spacing-sm); font-size: var(--font-caption2);">We may update this privacy policy from time to time. Partners will be notified of significant changes.</p>
          </div>

          <div style="padding: var(--ref-padding-l) var(--ref-padding-l) 0;">
            <div id="agreementTimer" style="text-align: center; font-size: var(--font-caption2); color: var(--fg-tertiary);">
              Please read for at least 5 seconds and scroll to the bottom
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-primary" onclick="acceptAgreement()" id="agreementAcceptBtn" disabled>I Agree</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Start timer
      agreementReadTime = 0;
      agreementScrolledToBottom = false;
      const timer = setInterval(() => {
        agreementReadTime++;
        updateAgreementButton();
        if (agreementReadTime >= 5 && agreementScrolledToBottom) {
          clearInterval(timer);
        }
      }, 1000);

      // Monitor scroll
      const content = document.getElementById('agreementContent');
      content.addEventListener('scroll', function() {
        if (content.scrollHeight - content.scrollTop <= content.clientHeight + 10) {
          agreementScrolledToBottom = true;
          updateAgreementButton();
        }
      });
    };

    function updateAgreementButton() {
      const btn = document.getElementById('agreementAcceptBtn');
      const timer = document.getElementById('agreementTimer');
      if (agreementReadTime >= 5 && agreementScrolledToBottom) {
        btn.disabled = false;
        timer.textContent = '✓ You can now agree to continue';
        timer.style.color = 'var(--function-success)';
      } else {
        const remaining = Math.max(0, 5 - agreementReadTime);
        let message = '';
        if (remaining > 0) {
          message = `Please wait ${remaining} more second${remaining !== 1 ? 's' : ''}`;
        }
        if (!agreementScrolledToBottom) {
          message += (message ? ' and ' : '') + 'scroll to the bottom';
        }
        timer.textContent = message;
      }
    }

    window.closeAgreementModal = function() {
      const modal = document.getElementById('agreementModal');
      if (modal) modal.remove();
    };

    window.acceptAgreement = function() {
      document.getElementById('agreementModal').remove();
      checkAgreementStatus();
    };

    // Check agreement status
    function checkAgreementStatus() {
      if (agreementReadTime >= 5 && agreementScrolledToBottom) {
        const checkbox = document.getElementById('termsCheckbox');
        checkbox.disabled = false;
        checkbox.checked = true;
        checkbox.style.cursor = 'default';
      }
    }

    // Auto-resize Company Description textarea
    const companyDescTextarea = document.getElementById('appCompanyDesc');
    if (companyDescTextarea) {
      const adjustHeight = function() {
        // Reset height to calculate scrollHeight correctly
        companyDescTextarea.style.height = 'auto';

        // Calculate single line height (with padding)
        const lineHeight = parseFloat(getComputedStyle(companyDescTextarea).lineHeight);
        const paddingTop = parseFloat(getComputedStyle(companyDescTextarea).paddingTop);
        const paddingBottom = parseFloat(getComputedStyle(companyDescTextarea).paddingBottom);
        const singleLineHeight = lineHeight + paddingTop + paddingBottom;
        const maxHeight = lineHeight * 3 + paddingTop + paddingBottom; // 3 lines max

        // Set height based on content, but not exceeding max height
        const newHeight = Math.min(companyDescTextarea.scrollHeight, maxHeight);
        companyDescTextarea.style.height = Math.max(newHeight, singleLineHeight) + 'px';

        // Enable scrolling if content exceeds max height
        if (companyDescTextarea.scrollHeight > maxHeight) {
          companyDescTextarea.style.overflowY = 'auto';
        } else {
          companyDescTextarea.style.overflowY = 'hidden';
        }
      };

      companyDescTextarea.addEventListener('input', adjustHeight);
      // Initial adjustment
      adjustHeight();
    }

    // Partner application form submission
    if (document.getElementById('partnerApplicationForm')) {
      document.getElementById('partnerApplicationForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // Validate form
        const email = document.getElementById('appEmail').value;
        const companyName = document.getElementById('appCompanyName').value;
        const country = document.getElementById('appCountry').value;
        const location = document.getElementById('appLocation').value;
        const businessLicense = document.getElementById('businessLicense').files[0];
        const salesLicense = document.getElementById('salesLicense').files[0];
        const insurance = document.getElementById('insurance').files[0];
        const termsChecked = document.getElementById('termsCheckbox').checked;

        // Clear previous errors
        document.querySelectorAll('.form-error').forEach(el => el.textContent = '');
        document.querySelectorAll('.form-input').forEach(el => el.classList.remove('error'));

        let hasError = false;

        if (!email) {
          showFormError('appEmail', 'Email is required');
          hasError = true;
        }

        if (!companyName) {
          showFormError('appCompanyName', 'Company name is required');
          hasError = true;
        }

        if (!country) {
          showFormError('appCountry', 'Please select a country');
          hasError = true;
        }

        if (!location) {
          showFormError('appLocation', 'State and City is required');
          hasError = true;
        }

        if (!businessLicense) {
          showFormError('businessLicense', 'Business license is required');
          hasError = true;
        }

        if (!salesLicense) {
          showFormError('salesLicense', 'Sales license is required');
          hasError = true;
        }

        if (!insurance) {
          showFormError('insurance', 'Insurance document is required');
          hasError = true;
        }

        if (!termsChecked) {
          showFormError('termsCheckbox', 'You must read and agree to the terms');
          hasError = true;
        }

        if (hasError) {
          return;
        }

        // Show loading state
        const submitBtn = document.getElementById('submitApplicationBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span>Submitting...';

        // Simulate API call
        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Application';

          utils.showToast('Application submitted successfully', 'success');

          // Go back to login
          setTimeout(() => {
            hidePartnerApplication();
          }, 1500);
        }, 2000);
      });
    }

    function showFormError(fieldId, message) {
      const field = document.getElementById(fieldId);
      const errorDiv = field.closest('.form-group').querySelector('.form-error');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.color = 'var(--function-error)';
        errorDiv.style.fontSize = 'var(--font-caption2)';
        errorDiv.style.marginTop = 'var(--spacing-xs)';
      }
      if (field.tagName !== 'INPUT' || field.type !== 'file') {
        field.classList.add('error');
      }
    }

    // ============================================
    // Bottom Tabbar Control
    // ============================================

    function hideBottomTabbar() {
      const tabbar = document.querySelector('.bottom-tabbar');
      if (tabbar) {
        tabbar.style.display = 'none';
      }

      // Extend content area to bottom
      const pages = document.querySelectorAll('.page');
      pages.forEach(page => {
        page.style.paddingBottom = '0';
      });
    }

    function showBottomTabbar() {
      const tabbar = document.querySelector('.bottom-tabbar');
      if (tabbar) {
        tabbar.style.display = 'flex';
      }

      // Restore original padding for tabbar
      const pages = document.querySelectorAll('.page');
      pages.forEach(page => {
        page.style.paddingBottom = 'calc(var(--tabbar-height) + env(safe-area-inset-bottom))';
      });
    }

    // ============================================
    // 3D Plan Functionality
    // ============================================

    let map, marker, geocoder;
    let uploadedPhotos = {};
    let threeScene, threeCamera, threeRenderer, threeControls;
    let placedDevices = [];
    let userPlacedData = [];
    let houseModel, userDeviceGroup, planDeviceGroup;
    let selectedDeviceIndex = -1;
    let selectedPlanIndex = -1;
    let isViewingFromHistory = false;
    let currentDraftId = null; // Track current draft being edited

    // Mock model history data
    let modelHistory = [
      {
        id: 1,
        userAccount: 'john.smith@example.com',
        address: '123 Main Street, San Francisco, CA',
        floors: 1,
        thumbnail: 'images/model-history/Model 1.png',
        createdAt: '2026-01-07 14:30',
        updatedAt: '2026-01-07 14:30',
        status: 'sent', // 'draft' or 'sent'
        selectedPlan: 'Basic'
      },
      {
        id: 2,
        userAccount: 'sarah.wilson@example.com',
        address: '456 Oak Avenue, Los Angeles, CA',
        floors: 3,
        thumbnail: 'images/model-history/Model 2.png',
        createdAt: '2026-01-06 10:15',
        updatedAt: '2026-01-06 16:20',
        status: 'draft',
        selectedPlan: 'Plus'
      }
    ];

    let filteredModelHistory = [...modelHistory];

    // Security Plans
    const securityPlans = [
      {
        name: 'Basic',
        devices: [
          { name: 'HomeBase Professional S1', image: 'images/products/HomeBase Professional S1.png', count: 1 },
          { name: 'eufy SoloCam S340', image: 'images/products/eufy SoloCam S340.png', count: 2 }
        ],
        layout: [
          { pos: [0, 2, 4.5], rot: [0, 0, 0], type: 'camera' },           // Front wall center
          { pos: [0, 2, -4.5], rot: [0, Math.PI, 0], type: 'camera' }      // Back wall center
        ]
      },
      {
        name: 'Plus',
        devices: [
          { name: 'HomeBase Professional S1', image: 'images/products/HomeBase Professional S1.png', count: 1 },
          { name: 'eufy SoloCam S340', image: 'images/products/eufy SoloCam S340.png', count: 4 },
          { name: 'Video Doorbell E340', image: 'images/products/Video Doorbell E340.png', count: 1 }
        ],
        layout: [
          { pos: [0, 2, 4.5], rot: [0, 0, 0], type: 'camera' },           // Front wall center
          { pos: [0, 2, -4.5], rot: [0, Math.PI, 0], type: 'camera' },     // Back wall center
          { pos: [-6, 2, 0], rot: [0, -Math.PI/2, 0], type: 'camera' },    // Left wall center (facing right)
          { pos: [6, 2, 0], rot: [0, Math.PI/2, 0], type: 'camera' },      // Right wall center (facing left)
          { pos: [0, 1.2, 4.5], rot: [0, 0, 0], type: 'doorbell' }         // Front door
        ]
      },
      {
        name: 'Premium',
        devices: [
          { name: 'HomeBase Professional S1', image: 'images/products/HomeBase Professional S1.png', count: 1 },
          { name: 'eufy PoE Bullet-PTZ Cam S4', image: 'images/products/eufy PoE Bullet-PTZ Cam S4.png', count: 4 },
          { name: 'eufy SoloCam S340', image: 'images/products/eufy SoloCam S340.png', count: 2 },
          { name: 'Video Doorbell E340', image: 'images/products/Video Doorbell E340.png', count: 1 }
        ],
        layout: [
          { pos: [-3, 2, 4.5], rot: [0, 0, 0], type: 'camera' },           // Front wall left (PoE)
          { pos: [3, 2, 4.5], rot: [0, 0, 0], type: 'camera' },            // Front wall right (Outdoor)
          { pos: [-3, 2, -4.5], rot: [0, Math.PI, 0], type: 'camera' },    // Back wall left (PoE)
          { pos: [3, 2, -4.5], rot: [0, Math.PI, 0], type: 'camera' },     // Back wall right (Outdoor)
          { pos: [-6, 2, 0], rot: [0, -Math.PI/2, 0], type: 'camera' },    // Left wall center (PoE, facing right)
          { pos: [6, 2, 0], rot: [0, Math.PI/2, 0], type: 'camera' },      // Right wall center (PoE, facing left)
          { pos: [0, 1.2, 4.5], rot: [0, 0, 0], type: 'doorbell' }         // Front door
        ]
      }
    ];

    // Initialize Leaflet Map
    function initGoogleMap() {
      const defaultLocation = [37.7749, -122.4194]; // San Francisco default

      // Create map
      map = L.map('googleMap').setView(defaultLocation, 15);

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      // Fix map tile loading issue - invalidate size after container is ready
      setTimeout(() => {
        if (map) {
          map.invalidateSize();
        }
      }, 200);

      // Add draggable marker
      marker = L.marker(defaultLocation, { draggable: true }).addTo(map);

      // Geolocation disabled for prototype - no permission prompts
      // if (navigator.geolocation) {
      //   navigator.geolocation.getCurrentPosition(
      //     (position) => {
      //       const pos = [position.coords.latitude, position.coords.longitude];
      //       map.setView(pos, 15);
      //       marker.setLatLng(pos);
      //       geocodeLatLng(position.coords.latitude, position.coords.longitude);
      //     },
      //     () => {
      //       console.log('Geolocation failed, using default location');
      //     }
      //   );
      // }

      // Add geocoding control for address search (force English)
      geocoder = L.Control.Geocoder.nominatim({
        geocodingQueryParams: {
          'accept-language': 'en'
        },
        reverseQueryParams: {
          'accept-language': 'en'
        }
      });
      const geocoderControl = L.Control.geocoder({
        geocoder: geocoder,
        defaultMarkGeocode: false
      }).on('markgeocode', function(e) {
        const latlng = e.geocode.center;
        map.setView(latlng, 18);
        marker.setLatLng(latlng);
        document.getElementById('houseAddress').value = e.geocode.name;
      }).addTo(map);

      // Update address when marker is dragged
      marker.on('dragend', function(e) {
        const pos = e.target.getLatLng();
        geocodeLatLng(pos.lat, pos.lng);
      });

      // Address input enter key handler
      const addressInput = document.getElementById('houseAddress');
      addressInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchAddress(this.value);
        }
      });
    }

    function searchAddress(address) {
      if (!address) return;
      geocoder.geocode(address, function(results) {
        if (results && results.length > 0) {
          const result = results[0];
          map.setView(result.center, 18);
          marker.setLatLng(result.center);
          document.getElementById('houseAddress').value = result.name;
        }
      });
    }

    function geocodeLatLng(lat, lng) {
      geocoder.reverse({ lat: lat, lng: lng }, map.options.crs.scale(map.getZoom()), function(results) {
        if (results && results.length > 0) {
          document.getElementById('houseAddress').value = results[0].name;
        }
      });
    }

    // Floor selection interaction
    document.addEventListener('DOMContentLoaded', function() {
      const floorOptions = document.querySelectorAll('.floor-option');
      floorOptions.forEach(option => {
        option.addEventListener('click', function() {
          // Reset all options
          floorOptions.forEach(opt => {
            opt.style.border = '2px solid transparent';
            opt.style.background = 'var(--bg-tertiary)';
            const number = opt.querySelector('.floor-number');
            number.style.fontWeight = 'var(--font-weight-regular)';
            number.style.color = 'var(--fg-tertiary)';
          });
          // Highlight selected
          this.style.border = '2px solid var(--brand-fg-primary)';
          this.style.background = 'var(--brand-fill-tertiary)';
          const selectedNumber = this.querySelector('.floor-number');
          selectedNumber.style.fontWeight = 'var(--font-weight-bold)';
          selectedNumber.style.color = 'var(--brand-fg-primary)';
        });
      });

      // Set default selected floor (1)
      const defaultFloor = document.querySelector('input[name="floors"][value="1"]').parentElement;
      defaultFloor.style.border = '2px solid var(--brand-fg-primary)';
      defaultFloor.style.background = 'var(--brand-fill-tertiary)';
      const defaultNumber = defaultFloor.querySelector('.floor-number');
      defaultNumber.style.fontWeight = 'var(--font-weight-bold)';
      defaultNumber.style.color = 'var(--brand-fg-primary)';

      // Photo upload handlers
      ['photoFront', 'photoBack', 'photoLeft', 'photoRight'].forEach(id => {
        const input = document.getElementById(id);
        input.addEventListener('change', function(e) {
          handlePhotoUpload(e, this.id);
        });
      });

      // Initialize Google Map when tab is shown
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.target.id === 'planContent' && !mutation.target.classList.contains('hidden')) {
            setTimeout(initGoogleMap, 100);
            observer.disconnect();
          }
        });
      });
      observer.observe(document.getElementById('planContent'), { attributes: true, attributeFilter: ['class'] });
    });

    function handlePhotoUpload(event, inputId) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const side = inputId.replace('photo', '').toLowerCase();
          uploadedPhotos[side] = e.target.result;

          // Show preview - image goes above the text, icon is hidden
          const box = document.querySelector(`[data-side="${side}"]`);
          const label = box.querySelector('label');
          const icon = label.querySelector('.photo-icon');
          const preview = label.querySelector('.photo-preview-img');

          label.style.border = '2px solid var(--brand-fg-primary)';
          label.style.background = 'var(--brand-fill-tertiary)';

          // Hide icon, show image
          icon.style.display = 'none';
          preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 80px; object-fit: cover; border-radius: var(--ref-radius-xs);">`;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }

    function generateHouseModel() {
      // Validation disabled for prototype testing
      // const email = document.getElementById('userEmail').value;
      // const address = document.getElementById('houseAddress').value;
      // const hasFrontPhoto = uploadedPhotos['front'];

      // if (!address) {
      //   utils.showToast('Please enter house address', 'error');
      //   return;
      // }

      // if (!hasFrontPhoto) {
      //   utils.showToast('Please upload front photo', 'error');
      //   return;
      // }

      // if (!email || !email.includes('@')) {
      //   utils.showToast('Please enter valid email', 'error');
      //   return;
      // }

      // Show loading
      const btn = document.getElementById('generateModelBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Generating...';

      // Simulate model generation
      setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = 'Generate Model';

        // Save or update draft in history
        saveModelDraft();

        // Switch to step 2
        document.getElementById('planStep1').classList.add('hidden');
        document.getElementById('planStep2').classList.remove('hidden');

        // Update navbar
        document.getElementById('navbarTitle').textContent = 'Step 2/3: Generate Solution';
        document.querySelector('#mainAppView .navbar-back').innerHTML = '<span onclick="backToStep1()" style="cursor: pointer; color: var(--brand-fg-primary);">‹ Back</span>';

        // Initialize 3D scene
        setTimeout(init3DScene, 100);

        utils.showToast('Model generated successfully!', 'success');
      }, 1500);
    }

    function saveModelDraft() {
      const userEmail = document.getElementById('userEmail').value || 'user@example.com';
      const address = document.getElementById('houseAddress').value || 'Unknown Address';
      const floors = parseInt(document.querySelector('input[name="floors"]:checked').value);
      const now = new Date().toISOString().slice(0, 16).replace('T', ' ');

      if (currentDraftId) {
        // Update existing draft
        const draft = modelHistory.find(m => m.id === currentDraftId);
        if (draft) {
          draft.userAccount = userEmail;
          draft.address = address;
          draft.floors = floors;
          draft.updatedAt = now;
        }
      } else {
        // Create new draft
        const newId = modelHistory.length > 0 ? Math.max(...modelHistory.map(m => m.id)) + 1 : 1;
        currentDraftId = newId;

        modelHistory.unshift({
          id: newId,
          userAccount: userEmail,
          address: address,
          floors: floors,
          thumbnail: floors === 1 ? 'images/model-history/Model 1.png' : 'images/model-history/Model 2.png',
          createdAt: now,
          updatedAt: now,
          status: 'draft',
          selectedPlan: null,
          devices: [...userPlacedData]
        });
      }

      filteredModelHistory = [...modelHistory];
    }

    function backToStep1() {
      document.getElementById('planStep2').classList.add('hidden');
      document.getElementById('planStep1').classList.remove('hidden');

      // Restore navbar
      document.getElementById('navbarTitle').textContent = 'Step 1/3: House Model';
      document.querySelector('#mainAppView .navbar-back').innerHTML = '<span onclick="backToPlanHome()" style="cursor: pointer; color: var(--brand-fg-primary);">‹ Back</span>';
    }

    // Three.js 3D Scene
    function init3DScene() {
      const container = document.getElementById('threeContainer');
      if (!container) {
        console.error('threeContainer not found');
        return;
      }

      // Clear container
      container.innerHTML = '';

      // Get container size (it's 1:1 ratio with padding-bottom)
      const containerWidth = container.parentElement.clientWidth;
      const size = containerWidth;

      // Scene setup
      threeScene = new THREE.Scene();
      threeScene.background = new THREE.Color(0xE0EDF4);

      // Camera
      threeCamera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
      threeCamera.position.set(30, 25, 30);
      threeCamera.lookAt(0, 0, 0);

      // Renderer
      threeRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      threeRenderer.setSize(size, size);
      threeRenderer.setPixelRatio(window.devicePixelRatio);
      threeRenderer.shadowMap.enabled = true;

      // Position renderer canvas absolutely
      threeRenderer.domElement.style.position = 'absolute';
      threeRenderer.domElement.style.top = '0';
      threeRenderer.domElement.style.left = '0';
      threeRenderer.domElement.style.width = '100%';
      threeRenderer.domElement.style.height = '100%';
      threeRenderer.domElement.style.cursor = 'grab';

      container.appendChild(threeRenderer.domElement);

      // Controls
      threeControls = new THREE.OrbitControls(threeCamera, threeRenderer.domElement);
      threeControls.enableDamping = true;
      threeControls.dampingFactor = 0.05;

      // Lights
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      threeScene.add(ambientLight);

      const sun = new THREE.DirectionalLight(0xffffff, 0.6);
      sun.position.set(20, 50, 20);
      sun.castShadow = true;
      threeScene.add(sun);

      // Create device groups
      userDeviceGroup = new THREE.Group();
      threeScene.add(userDeviceGroup);

      // Create house model
      createHouseModel();

      // Re-add existing devices if any
      userPlacedData.forEach(data => {
        addDeviceToScene(data.pos, data.normal, data.type, userDeviceGroup, 0xFFFFFF);
      });

      // Animation loop
      function animate() {
        requestAnimationFrame(animate);
        threeControls.update();
        threeRenderer.render(threeScene, threeCamera);
      }
      animate();

      // Handle window resize
      window.addEventListener('resize', () => {
        const newSize = container.parentElement.clientWidth;
        threeCamera.aspect = 1;
        threeCamera.updateProjectionMatrix();
        threeRenderer.setSize(newSize, newSize);
      });

      // Initialize drag and drop after scene is ready
      setTimeout(initDeviceDragDrop, 100);
    }

    function createHouseModel() {
      const floors = parseInt(document.querySelector('input[name="floors"]:checked').value);

      houseModel = new THREE.Group();

      // Lawn/Ground
      const lawn = new THREE.Mesh(
        new THREE.BoxGeometry(40, 0.2, 40),
        new THREE.MeshPhongMaterial({ color: 0x155E38 })
      );
      lawn.position.y = -0.1;
      lawn.receiveShadow = true;
      houseModel.add(lawn);

      // Walkway
      const path = new THREE.Mesh(
        new THREE.BoxGeometry(6, 0.1, 15),
        new THREE.MeshPhongMaterial({ color: 0x94A3B8 })
      );
      path.position.set(0, 0.01, 12);
      path.receiveShadow = true;
      houseModel.add(path);

      // Pool (decorative)
      const poolBorder = new THREE.Mesh(
        new THREE.BoxGeometry(11, 0.15, 9),
        new THREE.MeshPhongMaterial({ color: 0xFFFFFF })
      );
      poolBorder.position.set(12, 0, -5);
      houseModel.add(poolBorder);

      const water = new THREE.Mesh(
        new THREE.BoxGeometry(10, 0.1, 8),
        new THREE.MeshPhongMaterial({ color: 0xA5F3FC, transparent: true, opacity: 0.6 })
      );
      water.position.set(12, 0.05, -5);
      houseModel.add(water);

      // House structure
      const floorHeight = 3.5;
      const houseWidth = 12;
      const houseDepth = 9;

      for (let i = 0; i < floors; i++) {
        const yPos = (i * floorHeight) + floorHeight/2;

        // Main floor box
        const floorMesh = new THREE.Mesh(
          new THREE.BoxGeometry(houseWidth, floorHeight, houseDepth),
          new THREE.MeshPhongMaterial({ color: 0xF1F5F9 })
        );
        floorMesh.position.y = yPos;
        floorMesh.castShadow = true;
        floorMesh.receiveShadow = true;
        houseModel.add(floorMesh);

        // Trim between floors
        if (i > 0) {
          const trim = new THREE.Mesh(
            new THREE.BoxGeometry(houseWidth + 0.4, 0.2, houseDepth + 0.4),
            new THREE.MeshPhongMaterial({ color: 0xFFFFFF })
          );
          trim.position.y = i * floorHeight;
          trim.castShadow = true;
          houseModel.add(trim);
        }

        // Door on first floor
        if (i === 0) {
          const door = new THREE.Mesh(
            new THREE.BoxGeometry(2, 2.5, 0.2),
            new THREE.MeshPhongMaterial({ color: 0x5D4037 })
          );
          door.position.set(0, yPos - 0.5, houseDepth/2 + 0.11);
          houseModel.add(door);

          const step = new THREE.Mesh(
            new THREE.BoxGeometry(4, 0.5, 2),
            new THREE.MeshPhongMaterial({ color: 0xCBD5E1 })
          );
          step.position.set(0, 0.25, houseDepth/2 + 1);
          houseModel.add(step);

          // Windows on first floor (2 windows)
          addWindow(houseModel, -3, yPos, houseDepth);
          addWindow(houseModel, 3, yPos, houseDepth);
        } else {
          // Windows on upper floors (3 windows)
          addWindow(houseModel, -3, yPos, houseDepth);
          addWindow(houseModel, 0, yPos, houseDepth);
          addWindow(houseModel, 3, yPos, houseDepth);
        }
      }

      // Roof
      const roof = new THREE.Mesh(
        new THREE.ConeGeometry(houseWidth * 0.8, 3.5, 4),
        new THREE.MeshPhongMaterial({ color: 0x3F4C5E })
      );
      roof.rotation.y = Math.PI / 4;
      roof.position.y = (floors * floorHeight) + 3.5/2;
      roof.castShadow = true;
      houseModel.add(roof);

      threeScene.add(houseModel);
    }

    function addWindow(group, x, y, depth) {
      const windowFrame = new THREE.Mesh(
        new THREE.BoxGeometry(1.7, 1.7, 0.05),
        new THREE.MeshPhongMaterial({ color: 0xFFFFFF })
      );
      windowFrame.position.set(x, y, depth/2);
      group.add(windowFrame);

      const windowGlass = new THREE.Mesh(
        new THREE.BoxGeometry(1.5, 1.5, 0.1),
        new THREE.MeshPhongMaterial({ color: 0x93C5FD })
      );
      windowGlass.position.set(x, y, depth/2 + 0.05);
      group.add(windowGlass);
    }

    // Device drag and drop - initialized when Step 2 loads
    function initDeviceDragDrop() {
      const deviceCards = document.querySelectorAll('.device-card');
      const canvas = threeRenderer ? threeRenderer.domElement : null;

      if (!canvas) return;

      deviceCards.forEach(card => {
        // Desktop drag and drop
        card.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('deviceType', card.dataset.deviceType);

          // Create custom drag image (only icon and circle)
          const dragPreview = document.createElement('div');
          dragPreview.style.width = '80px';
          dragPreview.style.height = '80px';
          dragPreview.style.background = 'white';
          dragPreview.style.borderRadius = '50%';
          dragPreview.style.display = 'flex';
          dragPreview.style.alignItems = 'center';
          dragPreview.style.justifyContent = 'center';
          dragPreview.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
          dragPreview.style.position = 'absolute';
          dragPreview.style.top = '-1000px';

          const icon = card.querySelector('svg').cloneNode(true);
          icon.setAttribute('width', '40');
          icon.setAttribute('height', '40');
          dragPreview.appendChild(icon);

          document.body.appendChild(dragPreview);
          e.dataTransfer.setDragImage(dragPreview, 40, 40);

          setTimeout(() => document.body.removeChild(dragPreview), 0);
        });

        // Mobile touch support
        let draggedDeviceType = null;
        let touchStartY = 0;
        let isDragging = false;
        let dragIndicator = null;

        card.addEventListener('touchstart', (e) => {
          touchStartY = e.touches[0].clientY;
          draggedDeviceType = card.dataset.deviceType;
          isDragging = false;
        }, { passive: true });

        card.addEventListener('touchmove', (e) => {
          const touch = e.touches[0];
          const touchMoveY = touch.clientY;
          const deltaY = Math.abs(touchMoveY - touchStartY);

          // If moved more than 10px, consider it a drag
          if (deltaY > 10) {
            if (!isDragging) {
              isDragging = true;

              // Create drag indicator with device icon
              dragIndicator = document.createElement('div');
              dragIndicator.style.position = 'fixed';
              dragIndicator.style.width = '60px';
              dragIndicator.style.height = '60px';
              dragIndicator.style.background = 'white';
              dragIndicator.style.borderRadius = '50%';
              dragIndicator.style.display = 'flex';
              dragIndicator.style.alignItems = 'center';
              dragIndicator.style.justifyContent = 'center';
              dragIndicator.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
              dragIndicator.style.pointerEvents = 'none';
              dragIndicator.style.zIndex = '9999';
              dragIndicator.style.transition = 'opacity 0.2s';

              const icon = card.querySelector('svg').cloneNode(true);
              icon.setAttribute('width', '32');
              icon.setAttribute('height', '32');
              dragIndicator.appendChild(icon);

              document.body.appendChild(dragIndicator);
            }

            // Update drag indicator position
            if (dragIndicator) {
              dragIndicator.style.left = (touch.clientX - 30) + 'px';
              dragIndicator.style.top = (touch.clientY - 30) + 'px';
            }

            e.preventDefault(); // Prevent scrolling when dragging
          }
        }, { passive: false });

        card.addEventListener('touchend', (e) => {
          if (isDragging && draggedDeviceType) {
            const touch = e.changedTouches[0];
            const canvasRect = canvas.getBoundingClientRect();

            // Check if touch ended on canvas
            if (touch.clientX >= canvasRect.left &&
                touch.clientX <= canvasRect.right &&
                touch.clientY >= canvasRect.top &&
                touch.clientY <= canvasRect.bottom) {

              // Create synthetic event for placeDevice
              const syntheticEvent = {
                clientX: touch.clientX,
                clientY: touch.clientY
              };
              placeDevice(syntheticEvent, draggedDeviceType);
            }
          }

          // Remove drag indicator
          if (dragIndicator) {
            dragIndicator.style.opacity = '0';
            setTimeout(() => {
              if (dragIndicator && dragIndicator.parentNode) {
                document.body.removeChild(dragIndicator);
              }
              dragIndicator = null;
            }, 200);
          }

          isDragging = false;
          draggedDeviceType = null;
        });
      });

      canvas.addEventListener('dragover', (e) => {
        e.preventDefault();
      });

      canvas.addEventListener('drop', (e) => {
        e.preventDefault();
        const deviceType = e.dataTransfer.getData('deviceType');
        placeDevice(e, deviceType);
      });
    }

    function placeDevice(event, deviceType) {
      const canvas = threeRenderer.domElement;
      const rect = canvas.getBoundingClientRect();
      const mouse = new THREE.Vector2(
        ((event.clientX - rect.left) / rect.width) * 2 - 1,
        -((event.clientY - rect.top) / rect.height) * 2 + 1
      );

      const raycaster = new THREE.Raycaster();
      raycaster.setFromCamera(mouse, threeCamera);

      const intersects = raycaster.intersectObject(houseModel, true);

      if (intersects.length > 0) {
        const pos = intersects[0].point;
        const normal = intersects[0].face.normal;

        // Save to user placed data
        userPlacedData.push({
          pos: pos.clone(),
          normal: normal.clone(),
          type: deviceType
        });

        // Add to scene with white FOV
        addDeviceToScene(pos, normal, deviceType, userDeviceGroup, 0xFFFFFF);

        // Update list
        updatePlacedDevicesList();

        utils.showToast(`${deviceType.charAt(0).toUpperCase() + deviceType.slice(1)} placed`, 'success');
      }
    }

    function addDeviceToScene(posVec, normalVec, type, targetGroup, customColor = null) {
      const device = new THREE.Group();

      // Device body
      let bodyColor = 0x334155;
      const body = new THREE.Mesh(
        new THREE.BoxGeometry(0.3, 0.3, 0.5),
        new THREE.MeshPhongMaterial({ color: bodyColor })
      );
      body.position.z = 0.25;
      device.add(body);

      // Field of view for cameras/doorbells
      if (type === 'camera' || type === 'doorbell') {
        let fovColor = customColor !== null ? customColor : 0x3B82F6;
        let fovOpacity = customColor !== null ? 0.5 : 0.2;
        let fovLen, fovRadius;

        if (type === 'doorbell') {
          fovLen = 6.25;   // Half of camera length
          fovRadius = 4.5; // Half of camera radius
        } else {
          fovLen = 12.5;
          fovRadius = 9;
        }

        const tilt = 10 * (Math.PI / 180); // 10 degrees down tilt

        // Create pitch group for tilt
        const pitchGroup = new THREE.Group();
        pitchGroup.position.z = 0.5;
        pitchGroup.rotation.x = tilt;

        // Create FOV cone
        const fovGeo = new THREE.ConeGeometry(fovRadius, fovLen, 32);
        fovGeo.translate(0, -fovLen/2, 0);
        fovGeo.rotateX(-Math.PI / 2);

        const fovMat = new THREE.MeshBasicMaterial({
          color: fovColor,
          transparent: true,
          opacity: fovOpacity,
          depthWrite: false,
          side: THREE.DoubleSide
        });

        const fov = new THREE.Mesh(fovGeo, fovMat);
        fov.position.z = 0.05;
        fov.renderOrder = customColor ? 3 : 2;
        pitchGroup.add(fov);

        device.add(pitchGroup);
      }

      // Position and orient device
      device.position.copy(posVec);
      device.lookAt(posVec.clone().add(normalVec));
      if (!customColor) device.position.y += 0.05;

      targetGroup.add(device);
      return device;
    }

    function updatePlacedDevicesList() {
      const list = document.getElementById('placedDevicesList');
      if (userPlacedData.length === 0) {
        list.innerHTML = `
          <div style="text-align: center; padding: var(--ref-padding-l) 0; color: var(--fg-tertiary);">
            <div style="font-size: var(--font-caption2);">No devices placed yet</div>
          </div>
        `;
      } else {
        // Count devices by type for proper numbering
        const typeCounts = {};

        list.innerHTML = userPlacedData.map((device, index) => {
          const type = device.type;
          if (!typeCounts[type]) {
            typeCounts[type] = 0;
          }
          typeCounts[type]++;
          const typeNumber = typeCounts[type];

          return `
            <div onclick="selectDevice(${index})" style="display: flex; align-items: center; justify-content: space-between; padding: var(--ref-padding-m); margin-bottom: var(--ref-padding-xs); background: ${selectedDeviceIndex === index ? 'var(--brand-fill-primary)' : 'var(--bg-tertiary)'}; border-radius: var(--ref-radius-xs); cursor: pointer; transition: all 0.2s; border: 2px solid ${selectedDeviceIndex === index ? 'var(--brand-fg-primary)' : 'transparent'};">
              <span style="font-size: var(--font-caption2); font-weight: var(--font-weight-semibold); color: ${selectedDeviceIndex === index ? 'var(--brand-fg-primary)' : 'var(--fg-primary)'};">
                ${type.charAt(0).toUpperCase() + type.slice(1)} ${typeNumber}
              </span>
              <button style="background: none; border: none; padding: 0; cursor: pointer; display: flex; align-items: center; color: var(--function-error);" onclick="event.stopPropagation(); removeDevice(${index})">
                <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor">
                  <path d="M642.349176 39.574588a48.790588 48.790588 0 0 1 48.670118 48.790588v77.101177h244.374588a24.154353 24.154353 0 0 1 0 48.429176h-49.031529v718.607059c0 39.152941-31.744 70.836706-70.836706 70.836706H175.947294c-39.092706 0-70.776471-31.744-70.77647-70.836706V213.895529H56.139294a24.154353 24.154353 0 1 1 0-48.368941h244.314353v-77.101176a48.609882 48.609882 0 0 1 48.670118-48.850824z m196.306824 174.320941H152.877176v704.752942c0 17.588706 12.830118 32.165647 29.635765 34.93647l5.782588 0.421647h614.942118a35.418353 35.418353 0 0 0 34.936471-29.635764l0.481882-5.722353V213.835294zM495.736471 322.439529c13.312 0 24.094118 10.842353 24.094117 24.094118v391.228235a24.094118 24.094118 0 1 1-48.188235 0V346.533647c0-13.251765 10.842353-24.094118 24.094118-24.094118z m166.972235 0c13.312 0 24.094118 10.842353 24.094118 24.094118v391.228235a24.094118 24.094118 0 1 1-48.188236 0V346.533647c0-13.251765 10.842353-24.094118 24.094118-24.094118z m-333.944471 0c13.312 0 24.094118 10.842353 24.094118 24.094118v391.228235a24.094118 24.094118 0 1 1-48.188235 0V346.533647c0-13.251765 10.842353-24.094118 24.094117-24.094118z m299.309177-234.074353H363.459765a14.155294 14.155294 0 0 0-14.155294 14.155295v63.006117h292.924235V102.520471a14.155294 14.155294 0 0 0-14.155294-14.155295z"></path>
                </svg>
              </button>
            </div>
          `;
        }).join('');
      }
    }

    function selectDevice(index) {
      selectedDeviceIndex = (selectedDeviceIndex === index) ? -1 : index;
      updatePlacedDevicesList();
      highlightSelectedDevice();
    }

    function highlightSelectedDevice() {
      // Clear all highlights
      userDeviceGroup.children.forEach((device, idx) => {
        const fov = device.children.find(child => child.type === 'Group')?.children.find(c => c.material);
        if (fov && fov.material) {
          fov.material.color.setHex(0xFFFFFF);
          fov.material.opacity = 0.6;
        }
      });

      // Highlight selected
      if (selectedDeviceIndex >= 0 && userDeviceGroup.children[selectedDeviceIndex]) {
        const device = userDeviceGroup.children[selectedDeviceIndex];
        const fov = device.children.find(child => child.type === 'Group')?.children.find(c => c.material);
        if (fov && fov.material) {
          fov.material.color.setHex(0x00FF00); // Green highlight
          fov.material.opacity = 0.8;
        }
      }
    }

    function removeDevice(index) {
      // Remove from scene
      if (userDeviceGroup.children[index]) {
        userDeviceGroup.remove(userDeviceGroup.children[index]);
      }

      // Remove from data
      userPlacedData.splice(index, 1);

      // Reset selection
      selectedDeviceIndex = -1;

      // Update list
      updatePlacedDevicesList();

      utils.showToast('Device removed', 'success');
    }

    function generateSolution() {
      // Validation disabled for prototype testing
      const btn = document.getElementById('generateSolutionBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Generating...';

      setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = 'Generate Solution';
        utils.showToast('Solution generated!', 'success');

        // Hide all other views and show step 3
        document.getElementById('planHome').classList.add('hidden');
        document.getElementById('planStep1').classList.add('hidden');
        document.getElementById('planStep2').classList.add('hidden');
        document.getElementById('planStep3').classList.remove('hidden');

        // Update navbar
        document.getElementById('navbarTitle').textContent = 'Step 3/3: View Solution';
        document.querySelector('#mainAppView .navbar-back').innerHTML = '<span onclick="backToStep2()" style="cursor: pointer; color: var(--brand-fg-primary);">‹ Back</span>';

        // Initialize scene
        setTimeout(() => {
          initSolutionScene();
          if (selectedPlanIndex === -1) {
            selectedPlanIndex = 0;
          }
          renderPlanCards();
          update3DPlanView(selectedPlanIndex);
        }, 100);
      }, 1500);
    }

    function backToStep2() {
      document.getElementById('planStep3').classList.add('hidden');
      document.getElementById('planStep2').classList.remove('hidden');

      // Restore navbar
      document.getElementById('navbarTitle').textContent = 'Step 2/3: Generate Solution';
      document.querySelector('#mainAppView .navbar-back').innerHTML = '<span onclick="backToStep1()" style="cursor: pointer; color: var(--brand-fg-primary);">‹ Back</span>';

      // Reset plan selection
      selectedPlanIndex = -1;
    }

    // Initialize Step 3 3D Scene
    function initSolutionScene() {
      const container = document.getElementById('solutionThreeContainer');
      if (!container || container.children.length > 0) return;

      container.innerHTML = '';

      const containerWidth = container.parentElement.clientWidth;
      const size = containerWidth;

      // Reuse scene setup
      threeScene = new THREE.Scene();
      threeScene.background = new THREE.Color(0xE0EDF4);

      threeCamera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
      threeCamera.position.set(30, 25, 30);
      threeCamera.lookAt(0, 0, 0);

      threeRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      threeRenderer.setSize(size, size);
      threeRenderer.setPixelRatio(window.devicePixelRatio);
      threeRenderer.shadowMap.enabled = true;

      threeRenderer.domElement.style.position = 'absolute';
      threeRenderer.domElement.style.top = '0';
      threeRenderer.domElement.style.left = '0';
      threeRenderer.domElement.style.width = '100%';
      threeRenderer.domElement.style.height = '100%';
      threeRenderer.domElement.style.cursor = 'grab';

      container.appendChild(threeRenderer.domElement);

      threeControls = new THREE.OrbitControls(threeCamera, threeRenderer.domElement);
      threeControls.enableDamping = true;
      threeControls.dampingFactor = 0.05;

      // Lights
      threeScene.add(new THREE.AmbientLight(0xffffff, 0.6));
      const sun = new THREE.DirectionalLight(0xffffff, 0.6);
      sun.position.set(20, 50, 20);
      sun.castShadow = true;
      threeScene.add(sun);

      // Create device groups
      userDeviceGroup = new THREE.Group();
      planDeviceGroup = new THREE.Group();
      threeScene.add(userDeviceGroup);
      threeScene.add(planDeviceGroup);

      // Create house model
      createHouseModel();

      // Add user placed devices
      userPlacedData.forEach(data => {
        addDeviceToScene(data.pos, data.normal, data.type, userDeviceGroup, 0xFFFFFF);
      });

      // Animation
      function animate() {
        requestAnimationFrame(animate);
        threeControls.update();
        threeRenderer.render(threeScene, threeCamera);
      }
      animate();
    }

    // Render plan cards
    function renderPlanCards() {
      const container = document.getElementById('planCardsContainer');
      container.innerHTML = securityPlans.map((plan, index) => `
        <div onclick="selectPlan(${index})" style="min-width: 280px; flex-shrink: 0; scroll-snap-align: start; background: ${selectedPlanIndex === index ? 'var(--brand-fill-primary)' : 'white'}; border: 2px solid ${selectedPlanIndex === index ? 'var(--brand-fg-primary)' : 'var(--fill-secondary)'}; border-radius: var(--comp-card-radius); padding: var(--ref-padding-l); cursor: pointer; transition: all 0.3s;">
          <h3 style="font-size: var(--font-title1); font-weight: var(--font-weight-bold); color: var(--fg-primary); margin-bottom: var(--ref-padding-m);">${plan.name}</h3>

          <div style="border-top: 1px solid var(--fill-secondary); padding-top: var(--ref-padding-m); display: flex; flex-direction: column; gap: var(--ref-padding-s);">
            ${plan.devices.map(device => `
              <div style="display: flex; align-items: center; gap: var(--ref-padding-s);">
                <img src="${device.image}" alt="${device.name}" style="width: 32px; height: 32px; object-fit: contain; flex-shrink: 0; background: white; padding: 4px; border-radius: var(--ref-radius-xxs);">
                <div style="flex: 1; font-size: var(--font-caption2); color: var(--fg-secondary);">${device.name}</div>
                <div style="font-size: var(--font-caption2); font-weight: var(--font-weight-semibold); color: var(--fg-primary);">×${device.count}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    // Select plan
    function selectPlan(index) {
      selectedPlanIndex = (selectedPlanIndex === index) ? -1 : index;
      renderPlanCards();
      update3DPlanView(selectedPlanIndex);
    }

    // Update 3D view with plan devices
    function update3DPlanView(index) {
      if (!threeScene || !planDeviceGroup) return;

      // Clear plan devices
      threeScene.remove(planDeviceGroup);
      planDeviceGroup = new THREE.Group();
      threeScene.add(planDeviceGroup);

      if (index === -1) return;

      const plan = securityPlans[index];
      if (plan.layout) {
        plan.layout.forEach(item => {
          const pos = new THREE.Vector3(...item.pos);
          const dummy = new THREE.Object3D();
          dummy.rotation.set(...item.rot);
          const normal = new THREE.Vector3(0, 0, 1).applyEuler(dummy.rotation);
          addDeviceToScene(pos, normal, item.type, planDeviceGroup, 0x00FF00); // Green FOV
        });
      }
    }

    // Send solution confirmation
    function confirmSendSolution() {
      if (selectedPlanIndex === -1) {
        utils.showToast('Please select a plan first', 'error');
        return;
      }

      const plan = securityPlans[selectedPlanIndex];
      const userEmail = document.getElementById('userEmail').value || 'N/A';

      // Create confirmation modal
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      modal.innerHTML = `
        <div class="modal" style="background: white; border-radius: var(--comp-dialog-radius); padding: var(--ref-padding-xl); max-width: 320px; width: 90%;">
          <div class="modal-title" style="font-size: var(--font-title1); font-weight: var(--font-weight-bold); color: var(--fg-primary); margin-bottom: var(--ref-padding-m); text-align: center;">Confirm Send Solution</div>
          <div style="font-size: var(--font-body); color: var(--fg-secondary); text-align: center; margin-bottom: var(--ref-padding-xl);">
            Send <strong>${plan.name} Plan</strong> to <strong>${userEmail}</strong>?
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--ref-padding-m);">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
            <button class="btn btn-primary" onclick="sendSolution()">Send</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function sendSolution() {
      // Close modal
      document.querySelector('.modal-overlay').remove();

      // Show loading
      const btn = document.getElementById('sendSolutionBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Sending...';

      setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = 'Send to User';
        utils.showToast('Solution sent successfully!', 'success');

        // Update draft status to sent
        if (currentDraftId) {
          const draft = modelHistory.find(m => m.id === currentDraftId);
          if (draft) {
            draft.status = 'sent';
            draft.selectedPlan = securityPlans[selectedPlanIndex].name;
            draft.updatedAt = new Date().toISOString().slice(0, 16).replace('T', ' ');
          }
        }

        // Reset and go back to plan home
        setTimeout(() => {
          selectedPlanIndex = -1;
          selectedDeviceIndex = -1;
          userPlacedData = [];
          uploadedPhotos = {};
          isViewingFromHistory = false;
          currentDraftId = null; // Reset draft ID

          document.getElementById('planStep3').classList.add('hidden');
          document.getElementById('planHome').classList.remove('hidden');

          // Restore navbar
          document.getElementById('navbarTitle').textContent = '3D Plan';
          document.querySelector('#mainAppView .navbar-back').innerHTML = '';

          // Show bottom tabbar
          showBottomTabbar();
        }, 1500);
      }, 2000);
    }

    // ============================================
    // Plan Home Functions
    // ============================================

    function startNewSolution() {
      document.getElementById('planHome').classList.add('hidden');
      document.getElementById('planStep1').classList.remove('hidden');

      // Reset draft ID for new solution
      currentDraftId = null;

      // Update navbar
      document.getElementById('navbarTitle').textContent = 'Step 1/3: House Model';
      document.querySelector('#mainAppView .navbar-back').innerHTML = '<span onclick="backToPlanHome()" style="cursor: pointer; color: var(--brand-fg-primary);">‹ Back</span>';

      // Hide bottom tabbar (entering secondary page)
      hideBottomTabbar();
    }

    function backToPlanHome() {
      document.getElementById('planStep1').classList.add('hidden');
      document.getElementById('planStep2').classList.add('hidden');
      document.getElementById('planStep3').classList.add('hidden');
      document.getElementById('planHome').classList.remove('hidden');

      // Reset draft ID when returning to home
      currentDraftId = null;

      // Restore navbar
      document.getElementById('navbarTitle').textContent = '3D Plan';
      document.querySelector('#mainAppView .navbar-back').innerHTML = '';

      // Show bottom tabbar (back to primary page)
      showBottomTabbar();
    }

    // ============================================
    // Model History Functions
    // ============================================

    function showModelHistory() {
      // Hide plan content (including planHome)
      document.getElementById('planContent').classList.add('hidden');
      document.getElementById('modelHistoryView').classList.remove('hidden');

      // Update navbar
      document.getElementById('navbarTitle').textContent = 'Solution History';
      document.querySelector('#mainAppView .navbar-back').innerHTML = '<span onclick="hideModelHistory()" style="cursor: pointer; color: var(--brand-fg-primary);">‹ Back</span>';

      // Hide bottom tabbar (secondary page)
      hideBottomTabbar();

      renderModelHistory();
    }

    function hideModelHistory() {
      document.getElementById('modelHistoryView').classList.add('hidden');
      document.getElementById('planContent').classList.remove('hidden');

      // Show Plan Home, hide all steps
      document.getElementById('planHome').classList.remove('hidden');
      document.getElementById('planStep1').classList.add('hidden');
      document.getElementById('planStep2').classList.add('hidden');
      document.getElementById('planStep3').classList.add('hidden');

      // Restore navbar
      document.getElementById('navbarTitle').textContent = '3D Plan';
      document.querySelector('#mainAppView .navbar-back').innerHTML = '';

      // Show bottom tabbar (back to primary page)
      showBottomTabbar();
    }

    function renderModelHistory() {
      const list = document.getElementById('modelHistoryList');

      list.innerHTML = filteredModelHistory.map(model => `
        <div style="margin-bottom: var(--ref-padding-m); overflow: hidden; border-radius: var(--comp-card-radius); background: white; position: relative;">
          <div style="width: 100%; padding-bottom: 56.25%; position: relative; overflow: hidden; background: #E0EDF4; border-radius: var(--comp-card-radius) var(--comp-card-radius) 0 0;">
            <img src="${model.thumbnail}" alt="House Model" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; object-position: center;">
          </div>
          <div style="padding: var(--ref-padding-m); background: white; border-radius: 0 0 var(--comp-card-radius) var(--comp-card-radius);">
            <div style="font-size: var(--font-body); font-weight: var(--font-weight-semibold); color: var(--fg-primary); margin-bottom: var(--ref-padding-xs);">${model.userAccount}</div>
            <div style="font-size: var(--font-caption2); color: var(--fg-secondary); margin-bottom: var(--ref-padding-xs);">${model.address}</div>
            <div style="font-size: var(--font-caption2); color: var(--fg-tertiary); margin-bottom: var(--ref-padding-m);">Updated: ${model.updatedAt}</div>
            <button class="btn btn-secondary" onclick="viewModelSolution(${model.id})" style="width: 100%; font-size: var(--font-caption2); height: 32px;">
              View Solution
            </button>
          </div>
        </div>
      `).join('');
    }

    function filterModelHistory() {
      const searchTerm = document.getElementById('modelHistorySearch').value.toLowerCase().trim();
      filteredModelHistory = modelHistory.filter(model =>
        model.userAccount.toLowerCase().includes(searchTerm)
      );
      renderModelHistory();
    }

    function viewModelSolution(modelId) {
      const model = modelHistory.find(m => m.id === modelId);
      if (!model) return;

      // Set flag to indicate viewing from history
      isViewingFromHistory = true;

      // Load draft ID if viewing a draft (allows updating same record if sent)
      currentDraftId = model.status === 'draft' ? model.id : null;

      // Hide history view, show planContent
      document.getElementById('modelHistoryView').classList.add('hidden');
      document.getElementById('planContent').classList.remove('hidden');

      // Load model data
      userPlacedData = model.devices || [];

      // Hide all other views and show step 3
      document.getElementById('planHome').classList.add('hidden');
      document.getElementById('planStep1').classList.add('hidden');
      document.getElementById('planStep2').classList.add('hidden');
      document.getElementById('planStep3').classList.remove('hidden');

      // Update navbar to show "View Solution" (without step number from history)
      document.getElementById('navbarTitle').textContent = 'View Solution';
      document.querySelector('#mainAppView .navbar-back').innerHTML = '<span onclick="handleStep3Back()" style="cursor: pointer; color: var(--brand-fg-primary);">‹ Back</span>';

      // Hide bottom tabbar (tertiary page)
      hideBottomTabbar();

      // Initialize scene and render
      setTimeout(() => {
        initSolutionScene();
        // Auto-select plan from history if exists
        if (model.selectedPlan) {
          const planIndex = securityPlans.findIndex(p => p.name === model.selectedPlan);
          selectedPlanIndex = planIndex >= 0 ? planIndex : 0;
        } else {
          selectedPlanIndex = 0;
        }
        renderPlanCards();
        update3DPlanView(selectedPlanIndex);
      }, 100);
    }

    function handleStep3Back() {
      if (isViewingFromHistory) {
        // Go back to model history
        isViewingFromHistory = false;
        document.getElementById('planContent').classList.add('hidden');
        document.getElementById('planStep3').classList.add('hidden');
        document.getElementById('modelHistoryView').classList.remove('hidden');

        // Restore Solution History navbar
        document.getElementById('navbarTitle').textContent = 'Solution History';
        document.querySelector('#mainAppView .navbar-back').innerHTML = '<span onclick="hideModelHistory()" style="cursor: pointer; color: var(--brand-fg-primary);">‹ Back</span>';
      } else {
        // Go back to step 2
        backToStep2();
      }
    }
  </script>

  <!-- Company Selection Modal -->
  <div id="companySelectionModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-body">
        <div class="modal-title">Select Company</div>
        <div style="display: flex; flex-direction: column; gap: var(--ref-padding-m); margin-top: var(--ref-padding-s);">
          <!-- Company A Option -->
          <div class="company-option selected" onclick="selectCompany('companyA')">
            <div class="company-option-radio"></div>
            <div class="company-option-label">Company A</div>
          </div>
          <!-- Company B Option -->
          <div class="company-option" onclick="selectCompany('companyB')">
            <div class="company-option-radio"></div>
            <div class="company-option-label">Company B</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="confirmCompanySelection()">Confirm</button>
      </div>
    </div>
  </div>

</body>
</html>
